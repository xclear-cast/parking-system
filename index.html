<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>주차 통합 관제 시스템</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#4F46E5', // Indigo 600
                        secondary: '#64748B', // Slate 500
                        success: '#10B981', // Emerald 500
                        danger: '#EF4444', // Red 500
                        warning: '#F59E0B', // Amber 500
                    }
                }
            }
        }
    </script>
    
    <!-- React Imports -->
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "lucide-react": "https://esm.sh/lucide-react@0.263.1?deps=react@18.2.0",
            "jszip": "https://esm.sh/jszip@3.10.1"
        }
    }
    </script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        body { -webkit-tap-highlight-color: transparent; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        ::-webkit-scrollbar { width: 0px; background: transparent; }
        .safe-area-top { padding-top: env(safe-area-inset-top); }
        .safe-area-bottom { padding-bottom: env(safe-area-inset-bottom); }
        .animate-fade-in { animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        .animate-scale-in { animation: scaleIn 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        .slide-down { animation: slideDown 0.3s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes scaleIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        @keyframes slideDown { from { opacity: 0; max-height: 0; } to { opacity: 1; max-height: 1000px; } }
        
        /* 체크박스 커스텀 스타일 */
        .custom-checkbox {
            appearance: none;
            background-color: #fff;
            margin: 0;
            font: inherit;
            color: currentColor;
            width: 1.15em;
            height: 1.15em;
            border: 0.15em solid #cbd5e1;
            border-radius: 0.3em;
            display: grid;
            place-content: center;
            transition: all 0.2s ease-in-out;
        }

        .custom-checkbox::before {
            content: "";
            width: 0.65em;
            height: 0.65em;
            transform: scale(0);
            transition: 120ms transform ease-in-out;
            box-shadow: inset 1em 1em white;
            transform-origin: center;
            clip-path: polygon(14% 44%, 0 65%, 50% 100%, 100% 16%, 80% 0%, 43% 62%);
        }

        .custom-checkbox:checked {
            background-color: #4F46E5;
            border-color: #4F46E5;
        }

        .custom-checkbox:checked::before {
            transform: scale(1);
        }
    </style>
</head>
<body class="bg-gray-100 flex justify-center min-h-screen text-slate-800">
    <div id="root" class="w-full md:max-w-md h-[100dvh] bg-gray-50 shadow-2xl overflow-hidden flex flex-col relative"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { Car, FileText, Camera, CheckCircle, ArrowLeft, MapPin, Phone, User, Briefcase, Plus, Trash2, ShieldCheck, Image as ImageIcon, ScanLine, X, RotateCw, Download, Filter, CalendarDays, AlertCircle, Search, Home, Clock, Edit2, Lock, Archive, ChevronRight, ChevronDown, MoreVertical, Eye, UploadCloud, CheckSquare } from 'lucide-react';
        import JSZip from 'jszip';

        // Local mode: all submissions are stored in browser localStorage.
        const LOCAL_STORAGE_KEY = 'parking_submissions_local';
        const STATUS_LABELS = { pending: '대기중', approved: '승인', rejected: '반려' };
        const ADMIN_PASSWORD = '1234'; 

        const getStatusLabel = (status) => STATUS_LABELS[status] || status;
        
        // 상태별 색상 (뱃지용)
        const getStatusColor = (status) => {
            switch(status) {
                case 'approved': return 'bg-emerald-100 text-emerald-700 border border-emerald-200';
                case 'rejected': return 'bg-rose-100 text-rose-700 border border-rose-200';
                default: return 'bg-amber-100 text-amber-700 border border-amber-200';
            }
        };

        function App() {
            const [currentView, setCurrentView] = useState('home'); 
            const [submissions, setSubmissions] = useState({ construction: [], regular: [] });
            const [lastSubmissionType, setLastSubmissionType] = useState('');
            const [isAdmin, setIsAdmin] = useState(false);
            const [editingItem, setEditingItem] = useState(null);
            const [showAdminLogin, setShowAdminLogin] = useState(false);
            
            const toSubmissionGroups = (data) => ({
                construction: data.filter(item => item.type === 'construction').sort((a, b) => new Date(b.submittedAt) - new Date(a.submittedAt)),
                regular: data.filter(item => item.type === 'regular').sort((a, b) => new Date(b.submittedAt) - new Date(a.submittedAt))
            });

            const readLocalSubmissions = () => {
                try {
                    const raw = localStorage.getItem(LOCAL_STORAGE_KEY);
                    const data = raw ? JSON.parse(raw) : [];
                    return Array.isArray(data) ? data : [];
                } catch (error) {
                    console.error("Local Data Load Error:", error);
                    return [];
                }
            };

            const persistLocalSubmissions = (data) => {
                localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(data));
                setSubmissions(toSubmissionGroups(data));
            };

            const getAllSubmissions = () => [...submissions.construction, ...submissions.regular];

            useEffect(() => {
                setSubmissions(toSubmissionGroups(readLocalSubmissions()));
            }, []);

            const normalizeCarNumber = (car = '') => car.replace(/\s+/g, '').toUpperCase();
            const getDateTime = (date, time, fallbackTime) => new Date(`${date}T${time || fallbackTime}`);

            const checkTimeOverlap = (newData, type, excludeId = null) => {
                const newStart = getDateTime(newData.startDate, newData.startTime, '00:00');
                const newEnd = getDateTime(newData.endDate, newData.endTime, '23:59');

                if (Number.isNaN(newStart.getTime()) || Number.isNaN(newEnd.getTime()) || newStart >= newEnd) {
                    return { isOverlap: false };
                }
                
                const targetList = type === 'construction' ? submissions.construction : submissions.regular;

                for (const existing of targetList) {
                    if (excludeId && existing.id === excludeId) continue;
                    if (existing.status === 'rejected') continue;

                    let hasCarOverlap = false;
                    let overlappedCar = '';

                    if (type === 'construction') {
                        const newVehicles = (newData.vehicles || []).map(normalizeCarNumber).filter(Boolean);
                        const existingVehicles = (existing.vehicles || []).map(normalizeCarNumber).filter(Boolean);
                        const overlap = newVehicles.find(v => existingVehicles.includes(v));
                        if (overlap) {
                            hasCarOverlap = true;
                            overlappedCar = (newData.vehicles || []).find(v => normalizeCarNumber(v) === overlap) || overlap;
                        }
                    } else {
                        const newCar = normalizeCarNumber(newData.carNumber);
                        const existingCar = normalizeCarNumber(existing.carNumber);
                        if (newCar && newCar === existingCar) {
                            hasCarOverlap = true;
                            overlappedCar = newData.carNumber;
                        }
                    }

                    if (!hasCarOverlap) continue;

                    const existingStart = getDateTime(existing.startDate, existing.startTime, '00:00');
                    const existingEnd = getDateTime(existing.endDate, existing.endTime, '23:59');
                    if (Number.isNaN(existingStart.getTime()) || Number.isNaN(existingEnd.getTime())) continue;

                    if (newStart < existingEnd && newEnd > existingStart) {
                        return { isOverlap: true, car: overlappedCar, existing };
                    }
                }
                return { isOverlap: false };
            };

            const buildConstructionOverlapMessage = (overlapCheck) => {
                const existing = overlapCheck.existing || {};
                const existingSchedule = `${existing.startDate || '-'} ${existing.startTime || '00:00'} ~ ${existing.endDate || '-'} ${existing.endTime || '23:59'}`;
                return `[신청 불가] 차량(${overlapCheck.car})은 동일 시간에 이미 신청되어 있습니다.\n\n기존 일정: ${existingSchedule}`;
            };

            const handleSaveConstruction = async (data, isEdit = false, docId = null) => {
                const cleanVehicles = (data.vehicles || []).map(v => v.trim().toUpperCase()).filter(Boolean);
                const overlapCheck = checkTimeOverlap({ ...data, vehicles: cleanVehicles }, 'construction', docId);
                if (overlapCheck.isOverlap) {
                    const message = buildConstructionOverlapMessage(overlapCheck);
                    alert(message);
                    return { ok: false, reason: 'overlap', message };
                }

                try {
                    const cleanData = { ...data, driverPhone: data.driverPhone.replace(/-/g, ''), vehicles: cleanVehicles };
                    const allSubmissions = getAllSubmissions();
                    let nextSubmissions;

                    if (isEdit && docId) {
                        nextSubmissions = allSubmissions.map(item =>
                            item.id === docId
                                ? { ...item, ...cleanData, status: 'pending', rejectionReason: null, updatedAt: new Date().toISOString() }
                                : item
                        );
                        setLastSubmissionType('방문 등록 (수정됨)');
                    } else {
                        const newItem = {
                            id: `local-${Date.now()}-${Math.random().toString(36).slice(2, 8)}`,
                            type: 'construction',
                            status: 'pending',
                            submittedAt: new Date().toISOString(),
                            ...cleanData
                        };
                        nextSubmissions = [newItem, ...allSubmissions];
                        setLastSubmissionType('방문 등록');
                    }

                    persistLocalSubmissions(nextSubmissions);
                    setEditingItem(null);
                    setCurrentView('success');
                    return { ok: true };
                } catch (error) {
                    const message = "저장 실패: " + error.message;
                    alert(message);
                    return { ok: false, reason: 'error', message };
                }
            };

            const handleSaveRegular = async (data, isEdit = false, docId = null) => {
                if (data.applicationType !== 'change') {
                    const overlapCheck = checkTimeOverlap({
                        ...data,
                        startDate: new Date().toISOString().split('T')[0],
                        endDate: new Date().getFullYear() + '-12-31',
                        startTime: '00:00',
                        endTime: '23:59'
                    }, 'regular', docId);

                    if (overlapCheck.isOverlap) {
                        alert(`[신청 불가] 차량(${overlapCheck.car})은 이미 정기권이 등록되어 있습니다.`);
                        return;
                    }
                }

                try {
                    const cleanData = { ...data, phone: data.phone.replace(/-/g, '') };
                    const allSubmissions = getAllSubmissions();
                    let nextSubmissions;

                    if (isEdit && docId) {
                        nextSubmissions = allSubmissions.map(item =>
                            item.id === docId
                                ? { ...item, ...cleanData, status: 'pending', rejectionReason: null, updatedAt: new Date().toISOString() }
                                : item
                        );
                        setLastSubmissionType('정기권 신청 (수정됨)');
                    } else {
                        const newItem = {
                            id: `local-${Date.now()}-${Math.random().toString(36).slice(2, 8)}`,
                            type: 'regular',
                            status: 'pending',
                            submittedAt: new Date().toISOString(),
                            ...cleanData
                        };
                        nextSubmissions = [newItem, ...allSubmissions];
                        setLastSubmissionType('정기권 신청');
                    }

                    persistLocalSubmissions(nextSubmissions);
                    setEditingItem(null);
                    setCurrentView('success');
                } catch (error) {
                    alert("저장 실패: " + error.message);
                }
            };

            const updateStatus = async (type, id, newStatus, reason = null) => {
                try {
                    const allSubmissions = getAllSubmissions();
                    const nextSubmissions = allSubmissions.map(item => {
                        if (item.id !== id) return item;
                        return {
                            ...item,
                            status: newStatus,
                            rejectionReason: reason !== null ? reason : item.rejectionReason
                        };
                    });
                    persistLocalSubmissions(nextSubmissions);
                } catch (error) {
                    console.error("Update Error:", error);
                    alert("상태 변경 실패");
                }
            };

            const handleEditClick = (item) => {
                setEditingItem(item);
                setCurrentView(item.type === 'construction' ? 'edit_construction' : 'edit_regular');
            };

            const handleAdminClick = () => {
                if (isAdmin) {
                    setIsAdmin(false); // 로그아웃
                } else {
                    setShowAdminLogin(true); // 로그인 모달 열기
                }
            };

            const renderView = () => {
                switch (currentView) {
                    case 'home': return <HomeScreen onNavigate={setCurrentView} isAdmin={isAdmin} setIsAdmin={setIsAdmin} />;
                    case 'construction': return <ConstructionForm onBack={() => setCurrentView('home')} onSubmit={(data) => handleSaveConstruction(data, false)} />;
                    case 'regular': return <RegularTicketForm onBack={() => setCurrentView('home')} onSubmit={(data) => handleSaveRegular(data, false)} />;
                    case 'edit_construction': return <ConstructionForm onBack={() => setCurrentView('statusCheck')} onSubmit={(data) => handleSaveConstruction(data, true, editingItem.id)} initialData={editingItem} />;
                    case 'edit_regular': return <RegularTicketForm onBack={() => setCurrentView('statusCheck')} onSubmit={(data) => handleSaveRegular(data, true, editingItem.id)} initialData={editingItem} />;
                    case 'statusCheck': return <StatusCheckScreen onBack={() => setCurrentView('home')} submissions={submissions} onEdit={handleEditClick} />;
                    case 'admin': return <AdminDashboard onBack={() => setCurrentView('home')} submissions={submissions} onUpdateStatus={updateStatus} />;
                    case 'success': return <SuccessScreen type={lastSubmissionType} onHome={() => setCurrentView('home')} />;
                    default: return <HomeScreen onNavigate={setCurrentView} />;
                }
            };

            return (
                <div className="flex flex-col h-full bg-slate-50">
                    <header className="bg-slate-900 text-white px-5 py-4 flex justify-between items-center shrink-0 z-10 shadow-lg">
                        <div className="flex items-center space-x-3">
                            <div className="bg-blue-600 p-1.5 rounded-lg shadow-inner">
                                <ShieldCheck size={20} className="text-white"/>
                            </div>
                            <h1 className="text-lg font-bold tracking-tight">주차 통합 관제</h1>
                        </div>
                        {currentView === 'home' && (
                            <button onClick={handleAdminClick} className={`px-3 py-1.5 rounded-full border transition-all duration-200 flex items-center gap-1.5 ${isAdmin ? 'bg-indigo-600 border-indigo-500 text-white shadow-md' : 'border-slate-700 text-slate-400 hover:text-white hover:border-slate-500 hover:bg-slate-800'}`}>
                                <Lock size={12} />
                                <span className="text-xs font-bold">{isAdmin ? '관리자 ON' : '관리자'}</span>
                            </button>
                        )}
                    </header>
                    <main className="flex-1 overflow-y-auto relative">{renderView()}</main>

                    {/* 관리자 비밀번호 입력 모달 */}
                    {showAdminLogin && (
                        <AdminLoginModal 
                            isOpen={showAdminLogin} 
                            onClose={() => setShowAdminLogin(false)} 
                            onLogin={() => { setIsAdmin(true); setShowAdminLogin(false); }} 
                        />
                    )}
                </div>
            );
        }

        // --- 컴포넌트 ---
        function HistoryModal({ isOpen, onClose, historyList, targetCar }) {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm p-4 animate-fade-in">
                    <div className="bg-white w-full max-w-sm rounded-2xl shadow-2xl overflow-hidden max-h-[80vh] flex flex-col transform transition-all scale-100">
                        <div className="p-4 border-b flex justify-between bg-rose-50"><h3 className="font-bold flex items-center gap-2 text-rose-600"><AlertCircle size={20}/> 중복 이력</h3><button onClick={onClose} className="text-gray-500 hover:text-gray-800"><X size={20}/></button></div>
                        <div className="p-3 bg-amber-50 text-sm text-amber-900 border-b border-amber-100 px-5">차량 <strong>{targetCar}</strong>의 금일 내역</div>
                        <div className="flex-1 overflow-y-auto p-4 space-y-3 bg-slate-50">
                            {historyList.map((item, idx) => (
                                <div key={idx} className="border border-slate-200 p-4 rounded-xl bg-white shadow-sm">
                                    <div className="flex justify-between text-xs mb-2 pb-2 border-b border-dashed border-slate-100">
                                        <span className="bg-slate-100 text-slate-600 px-2 py-0.5 rounded-full font-medium">{new Date(item.submittedAt).toLocaleTimeString()} 신청</span>
                                        <span className={`px-2 py-0.5 rounded-full font-bold border ${getStatusColor(item.status)} text-[10px]`}>{getStatusLabel(item.status)}</span>
                                    </div>
                                    <div className="text-base font-bold text-slate-800 mb-1">{item.type==='construction'?item.companyName:item.name}</div>
                                    
                                    {/* 시간 표시 추가 */}
                                    {item.type === 'construction' && (
                                        <div className="text-sm font-bold text-indigo-600 mb-1 bg-indigo-50 px-2 py-1 rounded-md inline-flex items-center gap-1 border border-indigo-100">
                                            <Clock size={12}/> {item.startTime} ~ {item.endTime}
                                        </div>
                                    )}

                                    <div className="text-xs text-slate-500 flex items-center gap-1 mt-1"><Briefcase size={12}/>{item.type==='construction'?`목적: ${item.visitPurpose}`:item.applicationType}</div>
                                </div>
                            ))}
                        </div>
                        <div className="p-4 bg-white border-t border-slate-100"><button onClick={onClose} className="w-full py-3 bg-slate-800 text-white rounded-xl font-bold hover:bg-slate-900 transition shadow-lg shadow-slate-200">닫기</button></div>
                    </div>
                </div>
            );
        }

        // 이미지 확대 보기 모달
        function ImageModal({ src, onClose }) {
            if (!src) return null;
            return (
                <div className="fixed inset-0 z-[60] flex items-center justify-center bg-black/90 p-4 animate-fade-in cursor-pointer" onClick={onClose}>
                    <img src={src} className="max-w-full max-h-[90vh] object-contain rounded-lg shadow-2xl" />
                    <button className="absolute top-6 right-6 text-white bg-white/20 p-2 rounded-full hover:bg-white/30"><X size={28}/></button>
                    <div className="absolute bottom-6 text-white/70 text-sm bg-black/50 px-3 py-1 rounded-full">화면을 눌러 닫기</div>
                </div>
            )
        }

        function AdminDashboard({ onBack, submissions, onUpdateStatus }) {
            const [activeTab, setActiveTab] = useState('construction');
            const [filterYear, setFilterYear] = useState(new Date().getFullYear());
            const [filterMonth, setFilterMonth] = useState(new Date().getMonth() + 1);
            const [filterDay, setFilterDay] = useState('all');
            const [filterStatus, setFilterStatus] = useState('all');
            const [searchText, setSearchText] = useState(''); 
            const [expandedId, setExpandedId] = useState(null); 
            const [historyOpen, setHistoryOpen] = useState(false);
            const [historyList, setHistoryList] = useState([]);
            const [targetCar, setTargetCar] = useState('');
            const [rejectingId, setRejectingId] = useState(null);
            const [rejectReason, setRejectReason] = useState("");
            const [isZipping, setIsZipping] = useState(false);
            const [viewImage, setViewImage] = useState(null);
            const [selectedIds, setSelectedIds] = useState(new Set()); // 선택된 항목 ID

            // 연도 목록 생성 (2026년부터 5년간)
            const yearOptions = Array.from({length: 5}, (_, i) => 2026 + i);

            // 탭 변경시 펼침 상태 및 선택 상태 초기화
            useEffect(() => {
                setExpandedId(null);
                setSelectedIds(new Set());
            }, [activeTab]);

            const list = submissions[activeTab];
            const filteredList = list.filter(item => {
                const d = new Date(item.submittedAt);
                // 1. 날짜 필터
                if (d.getFullYear() !== parseInt(filterYear)) return false;
                if ((d.getMonth()+1) !== parseInt(filterMonth)) return false;
                if (filterDay!=='all' && d.getDate() !== parseInt(filterDay)) return false;
                // 2. 상태 필터
                if (filterStatus!=='all' && item.status !== filterStatus) return false;
                // 3. 검색어 필터 (차량번호, 이름, 업체명, 방문자)
                if (searchText) {
                    const term = searchText.toLowerCase();
                    const car = (item.carNumber || (item.vehicles ? item.vehicles.join(' ') : '')).toLowerCase();
                    const name = (item.name || item.companyName || '').toLowerCase();
                    const visitor = (item.visitorName || '').toLowerCase();
                    if (!car.includes(term) && !name.includes(term) && !visitor.includes(term)) {
                        return false;
                    }
                }
                return true;
            });

            const getDuplicateInfo = (item) => {
                if (activeTab !== 'construction') return { count: 0, history: [] };
                const date = item.startDate;
                let count = 0; let history = [];
                list.forEach(other => {
                    if (other.startDate === date) {
                        const overlap = (item.vehicles||[]).some(v => (other.vehicles||[]).includes(v));
                        if (overlap) { count++; history.push(other); }
                    }
                });
                return { count, history };
            };

            // 선택 로직
            const toggleSelectAll = () => {
                if (filteredList.length === 0) return;
                const allSelected = filteredList.every(item => selectedIds.has(item.id));
                if (allSelected) {
                    setSelectedIds(new Set());
                } else {
                    const newSet = new Set(selectedIds);
                    filteredList.forEach(item => newSet.add(item.id));
                    setSelectedIds(newSet);
                }
            };

            const toggleSelect = (id) => {
                const newSet = new Set(selectedIds);
                if (newSet.has(id)) {
                    newSet.delete(id);
                } else {
                    newSet.add(id);
                }
                setSelectedIds(newSet);
            };

            const getTargetList = () => {
                if (selectedIds.size > 0) {
                    return filteredList.filter(item => selectedIds.has(item.id));
                }
                return filteredList;
            };

            const handleDownload = () => {
                if (!window.XLSX) return alert("엑셀 로딩중...");
                const targetList = getTargetList();
                if (targetList.length === 0) return alert("다운로드할 데이터가 없습니다.");

                const ws_data = [];
                if(activeTab==='construction') {
                    ws_data.push(["차량번호","업체명","방문자성명","시작일","시작시간","종료일","종료시간","연락처","메모","호수"]);
                    targetList.forEach(i => i.vehicles.forEach(v => { if(v.trim()) ws_data.push([v, i.companyName, i.visitorName, i.startDate, i.startTime, i.endDate, i.endTime, i.driverPhone, `[${i.visitPurpose}] ${i.location} ${i.status==='rejected'?i.rejectionReason:''}`, i.visitUnit]) }));
                } else {
                    ws_data.push(["차량번호","시작일","시작시간","종료일","종료시간","사용자명","연락처","업체","부서","직급","차종","부제","동","호수","메모"]);
                    const today = new Date().toISOString().split('T')[0];
                    targetList.forEach(i => ws_data.push([i.carNumber, today, "00:00", new Date().getFullYear()+"-12-31", "23:59", i.name, i.phone, i.department, "", "", "", "미사용", "", i.unitNumber, `${i.applicationType} ${i.status==='rejected'?i.rejectionReason:''}`]));
                }
                const wb = window.XLSX.utils.book_new();
                window.XLSX.utils.book_append_sheet(wb, window.XLSX.utils.aoa_to_sheet(ws_data), "Sheet1");
                window.XLSX.writeFile(wb, `export_${activeTab}_${new Date().toISOString().slice(0,10)}.xlsx`);
            };

            const handleZipDownload = async () => {
                if (isZipping) return;
                const targetList = getTargetList();
                if (targetList.length === 0) return alert("다운로드할 데이터가 없습니다.");

                setIsZipping(true);
                try {
                    const zip = new JSZip();
                    const allData = { date: new Date().toISOString(), type: activeTab, count: targetList.length, data: targetList };
                    zip.file("data.json", JSON.stringify(allData, null, 2));
                    const imgFolder = zip.folder("images");
                    let imgCount = 0;
                    
                    targetList.forEach(item => {
                        if (item.registrationImg) {
                            const base64Data = item.registrationImg.split(',')[1];
                            if(base64Data) { imgFolder.file(`${item.name || item.companyName}_${item.carNumber || '차량'}_등록증.jpg`, base64Data, {base64: true}); imgCount++; }
                        }
                        if (item.idCardImg) {
                            const base64Data = item.idCardImg.split(',')[1];
                            if(base64Data) { imgFolder.file(`${item.name || item.companyName}_${item.carNumber || '차량'}_사원증.jpg`, base64Data, {base64: true}); imgCount++; }
                        }
                    });

                    if (imgCount === 0 && targetList.length === 0) {
                        alert("저장할 데이터가 없습니다."); setIsZipping(false); return;
                    }
                    const content = await zip.generateAsync({type:"blob"});
                    const url = window.URL.createObjectURL(content);
                    const a = document.createElement("a"); a.href = url; a.download = `주차관리_${activeTab}_${selectedIds.size > 0 ? '선택' : '전체'}_${new Date().toISOString().slice(0,10)}.zip`; a.click();
                    window.URL.revokeObjectURL(url);
                } catch (error) { console.error("ZIP Error:", error); alert("압축 중 오류가 발생했습니다."); } finally { setIsZipping(false); }
            };

            useEffect(() => { if(!window.XLSX) { const s = document.createElement('script'); s.src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"; document.body.appendChild(s); } }, []);

            // 상세 항목 렌더링 헬퍼
            const InfoRow = ({ label, value, highlight }) => (
                <div className="flex justify-between items-center py-2 border-b border-slate-100 last:border-0 hover:bg-slate-50 px-2 rounded">
                    <span className="text-slate-500 text-xs w-20 font-medium">{label}</span>
                    <span className={`text-sm font-bold text-right flex-1 break-keep ${highlight ? 'text-indigo-600' : 'text-slate-700'}`}>{value || '-'}</span>
                </div>
            );
            
            const isAllSelected = filteredList.length > 0 && filteredList.every(item => selectedIds.has(item.id));
            const selectedCount = selectedIds.size;

            return (
                <div className="flex flex-col h-full bg-slate-50">
                    <HistoryModal isOpen={historyOpen} onClose={()=>setHistoryOpen(false)} historyList={historyList} targetCar={targetCar} />
                    <ImageModal src={viewImage} onClose={()=>setViewImage(null)} />
                    
                    <div className="bg-white p-5 pb-2 shadow-sm z-10 sticky top-0">
                        <div className="flex justify-between mb-4 items-center">
                            <div className="flex items-center space-x-3">
                                <button onClick={onBack} className="p-2 -ml-2 rounded-full hover:bg-slate-100 transition"><ArrowLeft size={20} className="text-slate-600"/></button>
                                <h2 className="font-bold text-xl text-slate-800">관리자 대시보드</h2>
                            </div>
                            <span className="text-xs font-bold bg-indigo-50 text-indigo-600 px-3 py-1.5 rounded-full border border-indigo-100">Total: {filteredList.length}</span>
                        </div>
                        
                        <div className="grid grid-cols-3 gap-2 mb-3">
                            <select value={filterYear} onChange={e=>setFilterYear(e.target.value)} className="w-full p-2.5 bg-slate-50 border border-slate-200 rounded-lg text-sm font-medium focus:ring-2 focus:ring-indigo-500 focus:outline-none">
                                {yearOptions.map(year => (
                                    <option key={year} value={year}>{year}년</option>
                                ))}
                            </select>
                            <select value={filterMonth} onChange={e=>setFilterMonth(e.target.value)} className="w-full p-2.5 bg-slate-50 border border-slate-200 rounded-lg text-sm font-medium focus:ring-2 focus:ring-indigo-500 focus:outline-none">{[...Array(12)].map((_,i)=><option key={i+1} value={i+1}>{i+1}월</option>)}</select>
                            <select value={filterDay} onChange={e=>setFilterDay(e.target.value)} className="w-full p-2.5 bg-slate-50 border border-slate-200 rounded-lg text-sm font-medium focus:ring-2 focus:ring-indigo-500 focus:outline-none"><option value="all">전체 일</option>{[...Array(31)].map((_,i)=><option key={i+1} value={i+1}>{i+1}일</option>)}</select>
                        </div>

                        {/* 검색 기능 추가 */}
                        <div className="relative mb-3">
                            <Search className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400" size={18}/>
                            <input 
                                className="w-full pl-10 pr-4 py-3 bg-white border border-slate-200 rounded-xl text-sm font-medium focus:ring-2 focus:ring-indigo-500 outline-none transition-all placeholder:text-slate-400" 
                                placeholder="차량번호, 성명, 업체명 검색..." 
                                value={searchText} 
                                onChange={e=>setSearchText(e.target.value)}
                            />
                        </div>

                        <div className="mb-3">
                            <select value={filterStatus} onChange={e=>setFilterStatus(e.target.value)} className="w-full p-2.5 bg-slate-50 border border-slate-200 rounded-lg text-sm font-medium focus:ring-2 focus:ring-indigo-500 focus:outline-none"><option value="all">모든 상태 보기</option><option value="pending">대기중인 건만</option><option value="approved">승인된 건만</option><option value="rejected">반려된 건만</option></select>
                        </div>
                        
                        {/* 탭 버튼 */}
                        <div className="flex p-1 bg-slate-100 rounded-xl mb-3">
                            <button onClick={()=>setActiveTab('construction')} className={`flex-1 py-2.5 text-sm rounded-lg font-bold transition-all ${activeTab==='construction'?'bg-white text-indigo-600 shadow-sm ring-1 ring-black/5':'text-slate-500 hover:text-slate-700'}`}>공사/방문</button>
                            <button onClick={()=>setActiveTab('regular')} className={`flex-1 py-2.5 text-sm rounded-lg font-bold transition-all ${activeTab==='regular'?'bg-white text-emerald-600 shadow-sm ring-1 ring-black/5':'text-slate-500 hover:text-slate-700'}`}>정기권</button>
                        </div>

                        {/* 액션 버튼 */}
                        <div className="flex gap-2 pb-3">
                            <button onClick={handleDownload} className="flex-1 bg-slate-800 hover:bg-slate-900 text-white py-3 rounded-xl text-sm font-bold flex items-center justify-center gap-2 shadow-lg shadow-slate-200 transition active:scale-95">
                                <Download size={16}/>
                                <span>{selectedCount > 0 ? `${selectedCount}건 엑셀 저장` : '전체 엑셀 저장'}</span>
                            </button>
                            <button onClick={handleZipDownload} disabled={isZipping} className="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white py-3 rounded-xl text-sm font-bold flex items-center justify-center gap-2 shadow-lg shadow-indigo-200 transition active:scale-95">
                                {isZipping ? <RotateCw className="animate-spin" size={16}/> : <Archive size={16}/>}
                                <span>{isZipping ? '압축중...' : (selectedCount > 0 ? `${selectedCount}건 ZIP` : '전체 ZIP')}</span>
                            </button>
                        </div>
                    </div>

                    <div className="flex-1 overflow-y-auto p-5 space-y-4 bg-slate-50">
                        {filteredList.length === 0 && <div className="text-center py-10 text-slate-400 text-sm">표시할 내역이 없습니다.</div>}
                        
                        {/* 윈도우 스타일 리스트 (테이블 헤더 느낌) */}
                        {filteredList.length > 0 && (
                            <div className="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                                <div className="flex items-center p-3 bg-slate-100 border-b border-slate-200 text-xs font-bold text-slate-500">
                                    <div className="w-10 flex justify-center items-center">
                                        <input type="checkbox" checked={isAllSelected} onChange={toggleSelectAll} className="custom-checkbox cursor-pointer"/>
                                    </div>
                                    <div className="w-14 text-center">상태</div>
                                    <div className="flex-1 px-2">내용</div>
                                    <div className="w-20 text-right pr-2">날짜</div>
                                    <div className="w-6"></div>
                                </div>
                                {filteredList.map(item => {
                                    const {count, history} = getDuplicateInfo(item);
                                    const isDuplicate = count >= 2;
                                    const isExpanded = expandedId === item.id;
                                    const isSelected = selectedIds.has(item.id);

                                    return (
                                        <div key={item.id} className={`border-b border-slate-100 last:border-0 bg-white ${isSelected ? 'bg-indigo-50/20' : ''}`}>
                                            {/* 요약 행 (클릭 시 펼침) */}
                                            <div 
                                                onClick={() => setExpandedId(isExpanded ? null : item.id)}
                                                className={`flex items-center p-4 cursor-pointer hover:bg-slate-50 transition-colors ${isExpanded ? 'bg-indigo-50/30' : ''}`}
                                            >
                                                <div className="w-10 flex justify-center shrink-0" onClick={(e) => e.stopPropagation()}>
                                                    <input type="checkbox" checked={isSelected} onChange={() => toggleSelect(item.id)} className="custom-checkbox cursor-pointer"/>
                                                </div>
                                                <div className="w-14 flex justify-center shrink-0">
                                                    <span className={`px-2 py-1 rounded text-[10px] font-bold ${getStatusColor(item.status)}`}>{getStatusLabel(item.status)}</span>
                                                </div>
                                                <div className="flex-1 px-2 min-w-0 flex flex-col justify-center">
                                                    <div className="flex items-center gap-1.5">
                                                        <span className="font-bold text-slate-800 text-sm truncate">
                                                            {activeTab==='construction'? item.companyName : item.name}
                                                        </span>
                                                        {isDuplicate && <AlertCircle size={14} className="text-rose-500 shrink-0"/>}
                                                    </div>
                                                    <span className="text-xs text-slate-500 truncate mt-0.5 font-medium">
                                                        {activeTab==='construction'? (item.vehicles[0] || '차량없음') + (item.vehicles.length>1?` 외 ${item.vehicles.length-1}`:'') : item.carNumber}
                                                    </span>
                                                </div>
                                                <div className="w-20 text-right text-[10px] text-slate-400 leading-tight shrink-0">
                                                    {new Date(item.submittedAt).toLocaleDateString().slice(5)}<br/>
                                                    {new Date(item.submittedAt).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}
                                                </div>
                                                <div className="w-6 flex justify-end text-slate-400 shrink-0">
                                                    <ChevronRight size={16} className={`transition-transform duration-300 ${isExpanded ? 'rotate-90 text-indigo-500' : ''}`}/>
                                                </div>
                                            </div>

                                            {/* 상세 내용 (아코디언) */}
                                            <div className={`overflow-hidden transition-all duration-300 bg-slate-50 border-t border-slate-100 ${isExpanded ? 'max-h-[1000px] opacity-100' : 'max-h-0 opacity-0'}`}>
                                                <div className="p-4 space-y-4">
                                                    {isDuplicate && <button onClick={()=> { setTargetCar(item.vehicles[0]); setHistoryList(history); setHistoryOpen(true); }} className="w-full bg-rose-50 hover:bg-rose-100 text-rose-600 border border-rose-200 text-xs py-2.5 rounded-lg flex items-center justify-center font-bold transition"><AlertCircle size={14} className="mr-1.5"/> 금일 {count}회 중복 신청 (이력보기)</button>}
                                                    
                                                    <div className="bg-white p-2 rounded-xl border border-slate-200 shadow-sm">
                                                        {activeTab==='construction' ? (
                                                            <>
                                                                <InfoRow label="방문목적" value={item.visitPurpose} />
                                                                <InfoRow label="방문호수" value={`${item.visitUnit}호`} />
                                                                <InfoRow label="방문내용" value={item.location} />
                                                                <InfoRow label="연락처" value={item.driverPhone} />
                                                                <InfoRow label="방문기간" value={`${item.startDate} ${item.startTime} ~ ${item.endDate} ${item.endTime}`} />
                                                                <InfoRow label="차량번호" value={item.vehicles.join(', ')} highlight />
                                                            </>
                                                        ) : (
                                                            <>
                                                                <InfoRow label="신청구분" value={`${item.applicationType} ${item.applicationType==='change' ? `(기존: ${item.oldCarNumber})` : ''}`} />
                                                                <InfoRow label="신청호수" value={`${item.unitNumber}호`} />
                                                                <InfoRow label="소속" value={item.department} />
                                                                <InfoRow label="연락처" value={item.phone} />
                                                                <InfoRow label="차량번호" value={item.carNumber} highlight />
                                                                
                                                                {(item.registrationImg || item.idCardImg) && (
                                                                    <div className="mt-2 pt-2 border-t border-slate-100 px-2">
                                                                        <span className="text-xs text-slate-400 block mb-2 font-bold">첨부 서류 (클릭하여 확대)</span>
                                                                        <div className="flex gap-3 pb-1">
                                                                            {item.registrationImg && (
                                                                                <div className="flex flex-col gap-1 shrink-0 group cursor-pointer" onClick={() => setViewImage(item.registrationImg)}>
                                                                                    <div className="relative">
                                                                                        <img src={item.registrationImg} className="h-20 w-28 rounded-lg border border-slate-200 object-cover shadow-sm group-hover:opacity-90 transition"/>
                                                                                        <div className="absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 bg-black/20 rounded-lg transition"><Eye className="text-white drop-shadow-md" size={20}/></div>
                                                                                    </div>
                                                                                    <span className="text-[10px] text-slate-500 text-center font-medium">차량등록증</span>
                                                                                </div>
                                                                            )}
                                                                            {item.idCardImg && (
                                                                                <div className="flex flex-col gap-1 shrink-0 group cursor-pointer" onClick={() => setViewImage(item.idCardImg)}>
                                                                                    <div className="relative">
                                                                                        <img src={item.idCardImg} className="h-20 w-28 rounded-lg border border-slate-200 object-cover shadow-sm group-hover:opacity-90 transition"/>
                                                                                        <div className="absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 bg-black/20 rounded-lg transition"><Eye className="text-white drop-shadow-md" size={20}/></div>
                                                                                    </div>
                                                                                    <span className="text-[10px] text-slate-500 text-center font-medium">사원증</span>
                                                                                </div>
                                                                            )}
                                                                        </div>
                                                                    </div>
                                                                )}
                                                            </>
                                                        )}
                                                    </div>

                                                    {item.status === 'pending' && (
                                                        rejectingId === item.id ? 
                                                        <div className="animate-fade-in bg-white p-3 rounded-xl border border-slate-200 shadow-sm">
                                                            <input className="w-full border border-slate-300 rounded-lg p-2.5 text-sm mb-2 focus:ring-2 focus:ring-indigo-500 focus:outline-none" placeholder="반려 사유를 입력하세요" value={rejectReason} onChange={e=>setRejectReason(e.target.value)} autoFocus/>
                                                            <div className="flex gap-2">
                                                                <button onClick={()=>setRejectingId(null)} className="flex-1 py-2.5 rounded-lg border border-slate-300 text-slate-600 font-bold text-sm hover:bg-slate-50">취소</button>
                                                                <button onClick={()=> { onUpdateStatus(activeTab, item.id, 'rejected', rejectReason); setRejectingId(null); }} className="flex-1 py-2.5 rounded-lg bg-rose-500 text-white font-bold text-sm hover:bg-rose-600 shadow-md shadow-rose-200">확인</button>
                                                            </div>
                                                        </div>
                                                        : <div className="flex gap-2">
                                                            <button onClick={()=>{setRejectingId(item.id); setRejectReason("")}} className="flex-1 border border-rose-200 text-rose-600 bg-white hover:bg-rose-50 text-sm py-3 rounded-xl font-bold transition shadow-sm">반려</button>
                                                            <button onClick={()=>onUpdateStatus(activeTab, item.id, 'approved')} className="flex-1 bg-emerald-500 hover:bg-emerald-600 text-white text-sm py-3 rounded-xl font-bold shadow-lg shadow-emerald-100 transition">승인</button>
                                                        </div>
                                                    )}
                                                    {item.status === 'rejected' && <div className="text-xs text-rose-600 bg-rose-50 p-3 rounded-lg border border-rose-100 font-medium">💡 사유: {item.rejectionReason}</div>}
                                                </div>
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                        )}
                    </div>
                </div>
            )
        }

        function AdminLoginModal({ isOpen, onClose, onLogin }) {
            const [password, setPassword] = useState('');
            const [error, setError] = useState(false);

            if (!isOpen) return null;

            const handleSubmit = (e) => {
                e.preventDefault();
                if (password === ADMIN_PASSWORD) {
                    onLogin();
                } else {
                    setError(true);
                    setPassword('');
                }
            };

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-md p-6 animate-fade-in">
                    <div className="bg-white w-full max-w-xs rounded-3xl shadow-2xl p-8 transform transition-all scale-100">
                        <div className="flex justify-between items-center mb-6">
                            <h3 className="font-bold text-xl flex items-center gap-2 text-slate-800"><Lock size={22} className="text-indigo-600"/> 관리자 인증</h3>
                            <button onClick={onClose}><X size={24} className="text-slate-400 hover:text-slate-600 transition"/></button>
                        </div>
                        <form onSubmit={handleSubmit} className="space-y-5">
                            <div>
                                <input 
                                    type="password" 
                                    className={`w-full p-4 border-2 rounded-xl text-center text-xl tracking-widest outline-none transition-colors ${error ? 'border-rose-400 bg-rose-50 focus:border-rose-500' : 'border-slate-200 focus:border-indigo-500 focus:bg-indigo-50'}`}
                                    placeholder="••••"
                                    value={password}
                                    onChange={(e) => { setPassword(e.target.value); setError(false); }}
                                    autoFocus
                                    maxLength={4}
                                />
                                {error && <p className="text-xs text-rose-500 text-center mt-3 font-bold flex items-center justify-center gap-1 animate-pulse"><AlertCircle size={12}/> 비밀번호가 일치하지 않습니다.</p>}
                            </div>
                            <button type="submit" className="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-4 rounded-xl font-bold shadow-lg shadow-indigo-200 transition active:scale-95">확인</button>
                        </form>
                    </div>
                </div>
            );
        }

        function HomeScreen({ onNavigate, isAdmin }) {
            return (
                <div className="p-6 flex flex-col items-center justify-center h-full space-y-6 animate-fade-in bg-gradient-to-b from-white to-slate-50">
                    <div className="text-center mb-6">
                        <div className="bg-indigo-50 w-20 h-20 rounded-3xl flex items-center justify-center mx-auto mb-4 shadow-sm">
                            <ShieldCheck size={40} className="text-indigo-600" />
                        </div>
                        <h2 className="text-2xl font-bold text-slate-800 mb-2">환영합니다</h2>
                        <p className="text-slate-500 text-sm">원하시는 서비스를 선택해주세요.</p>
                    </div>
                    
                    <button onClick={()=>onNavigate('construction')} className="w-full group bg-white p-6 rounded-3xl border-2 border-indigo-50 hover:border-indigo-200 shadow-sm hover:shadow-xl hover:shadow-indigo-100 transition-all duration-300 flex items-center gap-5 relative overflow-hidden">
                        <div className="bg-indigo-100 p-4 rounded-2xl group-hover:scale-110 transition-transform duration-300"><Car size={32} className="text-indigo-600"/></div>
                        <div className="text-left z-10">
                            <span className="font-bold text-lg text-slate-800 block mb-1">공사/방문 등록</span>
                            <span className="text-xs text-slate-500 font-medium">일반 방문 및 공사 차량</span>
                        </div>
                        <div className="absolute right-0 top-0 bottom-0 w-1/3 bg-gradient-to-l from-indigo-50/50 to-transparent opacity-0 group-hover:opacity-100 transition-opacity"/>
                    </button>

                    <button onClick={()=>onNavigate('regular')} className="w-full group bg-white p-6 rounded-3xl border-2 border-emerald-50 hover:border-emerald-200 shadow-sm hover:shadow-xl hover:shadow-emerald-100 transition-all duration-300 flex items-center gap-5 relative overflow-hidden">
                        <div className="bg-emerald-100 p-4 rounded-2xl group-hover:scale-110 transition-transform duration-300"><FileText size={32} className="text-emerald-600"/></div>
                        <div className="text-left z-10">
                            <span className="font-bold text-lg text-slate-800 block mb-1">정기권 신청</span>
                            <span className="text-xs text-slate-500 font-medium">입주민 및 직원 정기 등록</span>
                        </div>
                        <div className="absolute right-0 top-0 bottom-0 w-1/3 bg-gradient-to-l from-emerald-50/50 to-transparent opacity-0 group-hover:opacity-100 transition-opacity"/>
                    </button>

                    <button onClick={()=>onNavigate('statusCheck')} className="w-full bg-white p-4 rounded-2xl border border-slate-200 flex items-center justify-center gap-2 hover:bg-slate-50 transition active:scale-95 text-slate-600 font-bold shadow-sm">
                        <Search size={20}/>
                        <span>신청 내역 조회 / 수정</span>
                    </button>

                    {isAdmin && (
                        <button onClick={()=>onNavigate('admin')} className="w-full mt-4 bg-slate-800 hover:bg-slate-900 text-white p-4 rounded-2xl flex items-center justify-center gap-3 shadow-xl shadow-slate-200 transition active:scale-95">
                            <ShieldCheck size={20}/>
                            <span className="font-bold">관리자 대시보드</span>
                        </button>
                    )}
                </div>
            )
        }

        // --- 폼 컴포넌트 UI 개선 ---
        const FormInput = ({ label, ...props }) => (
            <div className="mb-4">
                <label className="block text-xs font-bold text-slate-500 mb-1.5 ml-1">{label}</label>
                <input {...props} className="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl focus:bg-white focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition-all placeholder:text-slate-400 text-sm font-medium disabled:bg-slate-100 disabled:text-slate-400" />
            </div>
        );

        function ConstructionForm({ onBack, onSubmit, initialData }) {
            const [visitPurpose, setVisitPurpose] = useState('공사');
            const [formData, setFormData] = useState({ companyName:'', visitorName:'', visitUnit:'', location:'', driverPhone:'', startDate:'', endDate:'', startTime:'09:00', endTime:'18:00', vehicles:[''] });
            const [submitWarning, setSubmitWarning] = useState('');
            useEffect(() => { if(initialData) { setVisitPurpose(initialData.visitPurpose); setFormData({...initialData, visitorName: initialData.visitorName || ''}); } }, [initialData]);
            useEffect(() => { if(visitPurpose==='부동산') { if(formData.startDate) setFormData(p=>({...p, endDate:p.startDate})); if(formData.startTime) { const [h,m]=formData.startTime.split(':').map(Number); const eH=h+2; const eS=eH>=24?'23:59':`${String(eH).padStart(2,'0')}:${String(m).padStart(2,'0')}`; if(formData.endTime!==eS) setFormData(p=>({...p, endTime:eS})); } } }, [visitPurpose, formData.startDate, formData.startTime]);
            
            return (
                <div className="flex flex-col h-full bg-white">
                    <div className="px-5 py-4 border-b border-slate-100 flex items-center gap-3 sticky top-0 bg-white/90 backdrop-blur-md z-10">
                        <button onClick={onBack} className="p-2 -ml-2 rounded-full hover:bg-slate-50"><ArrowLeft className="text-slate-600"/></button>
                        <h2 className="text-xl font-bold text-slate-800">공사/방문 등록</h2>
                    </div>
                    <div className="flex-1 overflow-y-auto p-5 pb-24">
                        <form onSubmit={async e=>{e.preventDefault(); setSubmitWarning(''); const cleanedVehicles = formData.vehicles.map(v => v.trim().toUpperCase()).filter(Boolean); const result = await onSubmit({...formData, visitPurpose, vehicles: cleanedVehicles}); if (result && result.ok === false && result.reason === 'overlap') setSubmitWarning(result.message || '중복 신청으로 접수할 수 없습니다.');}}>
                            <div className="mb-6">
                                <label className="block text-sm font-bold text-slate-800 mb-3">방문 목적</label>
                                <div className="grid grid-cols-3 gap-2 bg-slate-100 p-1.5 rounded-2xl">
                                    {['공사','부동산','기타'].map(t=><button key={t} type="button" onClick={()=>setVisitPurpose(t)} className={`py-2.5 text-sm rounded-xl font-bold transition-all ${visitPurpose===t?'bg-white shadow text-indigo-600':'text-slate-500 hover:text-slate-700'}`}>{t}</button>)}
                                </div>
                                {visitPurpose==='부동산'&&<p className="text-xs text-indigo-500 mt-2 font-medium flex items-center gap-1"><Clock size={12}/> 부동산은 2시간 제한됩니다.</p>}
                            </div>
                            <div className="space-y-1">
                                <FormInput label="업체명" required value={formData.companyName} onChange={e=>setFormData({...formData, companyName:e.target.value})} placeholder={visitPurpose === '기타' ? "" : (visitPurpose === '공사' ? "예: OO인테리어" : "예: 행복부동산")}/>
                                <FormInput label="방문자 성명" required value={formData.visitorName} onChange={e=>setFormData({...formData, visitorName:e.target.value})} placeholder={visitPurpose === '기타' ? "" : "홍길동"}/>
                                <FormInput label="방문 호수" required value={formData.visitUnit} onChange={e=>setFormData({...formData, visitUnit:e.target.value})} placeholder="예: 101호"/>
                                <FormInput 
                                    label={visitPurpose === '공사' ? '작업 내용' : '방문 내용'}
                                    value={formData.location} 
                                    onChange={e=>setFormData({...formData, location:e.target.value})}
                                    placeholder={visitPurpose === '기타' ? "" : (visitPurpose === '공사' ? '예: 인테리어 공사' : '예: 매물 확인')}
                                />
                                <FormInput label="연락처" type="tel" required value={formData.driverPhone} onChange={e=>setFormData({...formData, driverPhone:e.target.value.replace(/[^0-9]/g,'')})} placeholder="01012345678"/>
                            </div>
                            
                            <div className="p-4 bg-slate-50 rounded-2xl border border-slate-100 mb-6">
                                <h3 className="text-sm font-bold text-slate-700 mb-3">방문 일시</h3>
                                <div className="grid grid-cols-2 gap-3 mb-3">
                                    <div><label className="text-xs text-slate-400 mb-1 block">시작일</label><input type="date" required className="w-full p-2.5 border rounded-xl text-sm bg-white font-medium" value={formData.startDate} onChange={e=>{const v=e.target.value; setFormData(p=>({...p, startDate:v, endDate: visitPurpose==='부동산'?v:p.endDate}))}}/></div>
                                    <div><label className="text-xs text-slate-400 mb-1 block">시작 시간</label><input type="time" required className="w-full p-2.5 border rounded-xl text-sm bg-white font-medium" value={formData.startTime} onChange={e=>setFormData({...formData, startTime:e.target.value})}/></div>
                                </div>
                                <div className="grid grid-cols-2 gap-3">
                                    <div><label className="text-xs text-slate-400 mb-1 block">종료일</label><input type="date" required className="w-full p-2.5 border rounded-xl text-sm bg-white font-medium disabled:bg-slate-100" value={formData.endDate} onChange={e=>setFormData({...formData, endDate:e.target.value})} disabled={visitPurpose==='부동산'}/></div>
                                    <div><label className="text-xs text-slate-400 mb-1 block">종료 시간</label><input type="time" required className="w-full p-2.5 border rounded-xl text-sm bg-white font-medium disabled:bg-slate-100" value={formData.endTime} onChange={e=>setFormData({...formData, endTime:e.target.value})} disabled={visitPurpose==='부동산'}/></div>
                                </div>
                            </div>

                            <div className="mb-6">
                                <label className="text-sm font-bold text-slate-800 mb-2 block">차량 번호</label>
                                <div className="space-y-2">
                                    {formData.vehicles.map((v,i)=><div key={i} className="flex gap-2"><input className="flex-1 p-3 border border-slate-200 rounded-xl bg-slate-50 focus:bg-white focus:ring-2 focus:ring-indigo-500 outline-none font-bold tracking-wider" value={v} onChange={e=>{const n=[...formData.vehicles];n[i]=e.target.value;setFormData({...formData, vehicles:n})}} required placeholder="12가3456"/>{formData.vehicles.length>1&&<button type="button" onClick={()=>{const n=[...formData.vehicles];n.splice(i,1);setFormData({...formData, vehicles:n})}} className="px-3 text-rose-500 bg-rose-50 rounded-xl hover:bg-rose-100"><Trash2 size={18}/></button>}</div>)}
                                </div>
                                <button type="button" onClick={()=>setFormData({...formData, vehicles:[...formData.vehicles, '']})} className="mt-3 text-indigo-600 text-sm font-bold flex items-center gap-1 hover:bg-indigo-50 px-3 py-2 rounded-lg transition"><Plus size={16}/> 차량 추가하기</button>
                            </div>
                            
                            {submitWarning && <div className="p-4 rounded-xl border border-rose-200 bg-rose-50 text-rose-700 text-sm font-medium whitespace-pre-line mb-6 flex items-start gap-2"><AlertCircle size={16} className="mt-0.5 shrink-0"/>{submitWarning}</div>}
                            
                            <div className="fixed bottom-0 left-0 right-0 p-4 bg-white border-t border-slate-100 md:max-w-md md:mx-auto">
                                <button type="submit" className="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-4 rounded-2xl font-bold shadow-xl shadow-indigo-200 transition active:scale-95 text-lg">{initialData?'수정하기':'신청하기'}</button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        }

        function RegularTicketForm({ onBack, onSubmit, initialData }) {
            const [appType, setAppType] = useState('new');
            const [formData, setFormData] = useState({ name:'', department:'', phone:'', carNumber:'', oldCarNumber:'', unitNumber:'', registrationImg:null, idCardImg:null });
            const regFileRef = useRef(null);
            const idFileRef = useRef(null);

            useEffect(() => { if(initialData) { setAppType(initialData.applicationType); setFormData({...initialData}); } }, [initialData]);
            
            const handleCompressedFile = (field, file) => {
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const MAX_WIDTH = 1024;
                        let width = img.width; let height = img.height;
                        if (width > MAX_WIDTH) { height *= MAX_WIDTH / width; width = MAX_WIDTH; }
                        canvas.width = width; canvas.height = height;
                        const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0, width, height);
                        const dataUrl = canvas.toDataURL('image/jpeg', 0.7);
                        setFormData(p => ({...p, [field]: dataUrl}));
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            };

            return (
                <div className="flex flex-col h-full bg-white">
                    <div className="px-5 py-4 border-b border-slate-100 flex items-center gap-3 sticky top-0 bg-white/90 backdrop-blur-md z-10">
                        <button onClick={onBack} className="p-2 -ml-2 rounded-full hover:bg-slate-50"><ArrowLeft className="text-slate-600"/></button>
                        <h2 className="text-xl font-bold text-slate-800">정기권 신청</h2>
                    </div>
                    <div className="flex-1 overflow-y-auto p-5 pb-24">
                        <form onSubmit={e=>{e.preventDefault(); onSubmit({...formData, applicationType:appType})}}>
                            <div className="mb-6">
                                <label className="block text-sm font-bold text-slate-800 mb-3">신청 유형</label>
                                <div className="flex gap-2 bg-slate-100 p-1.5 rounded-2xl">
                                    <button type="button" onClick={()=>setAppType('new')} className={`flex-1 py-2.5 text-sm rounded-xl font-bold transition-all ${appType==='new'?'bg-white shadow text-indigo-600':'text-slate-500 hover:text-slate-700'}`}>신규</button>
                                    <button type="button" onClick={()=>setAppType('change')} className={`flex-1 py-2.5 text-sm rounded-xl font-bold transition-all ${appType==='change'?'bg-white shadow text-emerald-600':'text-slate-500 hover:text-slate-700'}`}>변경</button>
                                </div>
                            </div>
                            {appType==='change' && <div className="p-4 bg-emerald-50 rounded-2xl border border-emerald-100 mb-6"><FormInput label="기존 차량번호" required value={formData.oldCarNumber} onChange={e=>setFormData({...formData, oldCarNumber:e.target.value})} className="bg-white" /></div>}
                            <div className="space-y-1">
                                <FormInput label="성명" required value={formData.name} onChange={e=>setFormData({...formData, name:e.target.value})}/>
                                <FormInput label="소속" required value={formData.department} onChange={e=>setFormData({...formData, department:e.target.value})}/>
                                <FormInput label="연락처" type="tel" required value={formData.phone} onChange={e=>setFormData({...formData, phone:e.target.value.replace(/[^0-9]/g,'')})}/>
                                <div className="grid grid-cols-2 gap-3">
                                    <FormInput label={appType==='change'?'변경할 차량':'차량번호'} required value={formData.carNumber} onChange={e=>setFormData({...formData, carNumber:e.target.value})} className="bg-amber-50 border-amber-200 focus:ring-amber-500 focus:border-amber-500"/>
                                    <FormInput label="호수" required value={formData.unitNumber} onChange={e=>setFormData({...formData, unitNumber:e.target.value})}/>
                                </div>
                            </div>

                            <div className="mt-6 space-y-4">
                                <h3 className="text-sm font-bold text-slate-800">증빙 서류 첨부</h3>
                                <div className="grid grid-cols-2 gap-4">
                                    {/* 차량등록증 */}
                                    <div className="bg-slate-50 p-3 rounded-2xl border border-slate-100 flex flex-col">
                                        <div className="text-xs font-bold text-slate-500 mb-2 text-center">차량등록증</div>
                                        {formData.registrationImg ? (
                                            <div className="relative group aspect-[4/3]">
                                                <img src={formData.registrationImg} className="w-full h-full object-cover rounded-xl border border-slate-200 shadow-sm"/>
                                                <button type="button" onClick={()=>setFormData(p=>({...p, registrationImg:null}))} className="absolute top-1 right-1 bg-black/50 text-white p-1 rounded-full hover:bg-black/70"><X size={14}/></button>
                                            </div>
                                        ) : (
                                            <label className="flex-1 flex flex-col gap-2 justify-center items-center cursor-pointer bg-white border border-dashed border-slate-300 rounded-xl hover:bg-slate-50 transition p-2">
                                                <div className="w-10 h-10 bg-slate-100 rounded-full flex items-center justify-center text-slate-400">
                                                    <UploadCloud size={20}/>
                                                </div>
                                                <span className="text-xs font-bold text-slate-500">사진 첨부</span>
                                                <input ref={regFileRef} type="file" accept="image/*" className="hidden" onChange={e=>handleCompressedFile('registrationImg', e.target.files[0])}/>
                                            </label>
                                        )}
                                    </div>
                                    {/* 사원증 */}
                                    <div className="bg-slate-50 p-3 rounded-2xl border border-slate-100 flex flex-col">
                                        <div className="text-xs font-bold text-slate-500 mb-2 text-center">사원증</div>
                                        {formData.idCardImg ? (
                                            <div className="relative group aspect-[4/3]">
                                                <img src={formData.idCardImg} className="w-full h-full object-cover rounded-xl border border-slate-200 shadow-sm"/>
                                                <button type="button" onClick={()=>setFormData(p=>({...p, idCardImg:null}))} className="absolute top-1 right-1 bg-black/50 text-white p-1 rounded-full hover:bg-black/70"><X size={14}/></button>
                                            </div>
                                        ) : (
                                            <label className="flex-1 flex flex-col gap-2 justify-center items-center cursor-pointer bg-white border border-dashed border-slate-300 rounded-xl hover:bg-slate-50 transition p-2">
                                                <div className="w-10 h-10 bg-slate-100 rounded-full flex items-center justify-center text-slate-400">
                                                    <UploadCloud size={20}/>
                                                </div>
                                                <span className="text-xs font-bold text-slate-500">사진 첨부</span>
                                                <input ref={idFileRef} type="file" accept="image/*" className="hidden" onChange={e=>handleCompressedFile('idCardImg', e.target.files[0])}/>
                                            </label>
                                        )}
                                    </div>
                                </div>
                            </div>
                            
                            <div className="fixed bottom-0 left-0 right-0 p-4 bg-white border-t border-slate-100 md:max-w-md md:mx-auto">
                                <button type="submit" className="w-full bg-emerald-500 hover:bg-emerald-600 text-white py-4 rounded-2xl font-bold shadow-xl shadow-emerald-200 transition active:scale-95 text-lg">{initialData?'수정하기':'신청하기'}</button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        }

        function StatusCheckScreen({ onBack, submissions, onEdit }) {
            const [name, setName] = useState(''); const [car, setCar] = useState(''); const [res, setRes] = useState(null);
            const search = (e) => {
                e.preventDefault(); if(!name.trim() || !car.trim()) return alert("정보를 입력하세요");
                const c = submissions.construction.filter(i => (i.companyName===name || i.visitorName===name) && i.vehicles.some(v=>v.includes(car)));
                const r = submissions.regular.filter(i => i.name===name && i.carNumber.includes(car));
                setRes([...c, ...r]);
            };
            return (
                <div className="flex flex-col h-full bg-slate-50">
                    <div className="px-5 py-4 border-b border-slate-100 flex items-center gap-3 bg-white sticky top-0 z-10">
                        <button onClick={onBack} className="p-2 -ml-2 rounded-full hover:bg-slate-50"><ArrowLeft className="text-slate-600"/></button>
                        <h2 className="text-xl font-bold text-slate-800">신청 내역 조회</h2>
                    </div>
                    <div className="p-5">
                        <div className="bg-white p-5 rounded-2xl shadow-sm border border-slate-100 mb-6">
                            <form onSubmit={search} className="space-y-3">
                                <input className="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-sm outline-none focus:ring-2 focus:ring-indigo-500" placeholder="성명 또는 업체명" value={name} onChange={e=>setName(e.target.value)}/>
                                <input className="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-sm outline-none focus:ring-2 focus:ring-indigo-500" placeholder="차량번호" value={car} onChange={e=>setCar(e.target.value)}/>
                                <button className="w-full bg-indigo-600 text-white py-3 rounded-xl font-bold shadow-lg shadow-indigo-200 active:scale-95 transition">조회하기</button>
                            </form>
                        </div>
                        
                        <div className="space-y-4">
                            {res && res.length === 0 && <div className="text-center text-slate-400 py-4">조회 결과가 없습니다.</div>}
                            {res && res.map(i => (
                                <div key={i.id} className={`bg-white p-5 rounded-2xl shadow-sm border-l-4 ${getStatusBorder(i.status)}`}>
                                    <div className="flex justify-between items-start mb-2">
                                        <span className="font-bold text-lg text-slate-800">{i.type==='construction'?`[${i.visitPurpose}] ${i.companyName}`:'정기권 신청'}</span>
                                        <span className={`px-2.5 py-1 rounded-full text-xs font-bold border ${getStatusColor(i.status)}`}>{getStatusLabel(i.status)}</span>
                                    </div>
                                    <div className="text-sm text-slate-600 space-y-1 mb-3">
                                        {i.type === 'construction' ? <><p>방문자: {i.visitorName}</p><p>장소: {i.location} ({i.visitUnit}호)</p></> : <><p>차량: {i.carNumber}</p><p>신청자: {i.name}</p></>}
                                    </div>
                                    {i.status==='rejected' && <div className="bg-rose-50 text-rose-600 text-xs p-3 rounded-xl border border-rose-100 mb-3">반려 사유: {i.rejectionReason}</div>}
                                    {i.status!=='approved' && <button onClick={()=>onEdit(i)} className="w-full py-2.5 border border-indigo-200 text-indigo-600 rounded-xl text-sm font-bold hover:bg-indigo-50 transition">수정하기</button>}
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            )
        }

        function SuccessScreen({ type, onHome }) {
            return (
                <div className="flex flex-col items-center justify-center h-full bg-white p-6 text-center animate-scale-in">
                    <div className="w-24 h-24 bg-emerald-100 rounded-full flex items-center justify-center mb-6 animate-bounce">
                        <CheckCircle size={48} className="text-emerald-500"/>
                    </div>
                    <h2 className="text-2xl font-bold text-slate-800 mb-2">신청 완료!</h2>
                    <p className="text-slate-500 mb-8">{type} 접수가 정상적으로 처리되었습니다.<br/>관리자 승인 후 효력이 발생합니다.</p>
                    <button onClick={onHome} className="w-full max-w-xs bg-slate-800 text-white py-4 rounded-2xl font-bold shadow-xl shadow-slate-200 transition hover:bg-slate-900 active:scale-95">홈으로 돌아가기</button>
                </div>
            )
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>