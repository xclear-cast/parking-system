<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>주차 신청 접수시스템</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#4F46E5',
                        secondary: '#64748B',
                        success: '#10B981',
                        danger: '#EF4444',
                        warning: '#F59E0B',
                    },
                    animation: {
                        'bounce-short': 'bounce 1s infinite 2',
                        'slide-in-right': 'slideInRight 0.3s ease-out forwards',
                        'pulse-border': 'pulseBorder 2s infinite',
                    },
                    keyframes: {
                        slideInRight: {
                            '0%': { transform: 'translateX(100%)', opacity: '0' },
                            '100%': { transform: 'translateX(0)', opacity: '1' },
                        },
                        pulseBorder: {
                            '0%, 100%': { borderColor: '#818cf8' }, 
                            '50%': { borderColor: '#4f46e5' }, 
                        }
                    }
                }
            }
        }
    </script>
    
    <!-- React Imports -->
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "lucide-react": "https://esm.sh/lucide-react@0.263.1?deps=react@18.2.0",
            "jspdf": "https://esm.sh/jspdf@2.5.1"
        }
    }
    </script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        body { -webkit-tap-highlight-color: transparent; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        ::-webkit-scrollbar { width: 0px; background: transparent; }
        .safe-area-top { padding-top: env(safe-area-inset-top); }
        .safe-area-bottom { padding-bottom: env(safe-area-inset-bottom); }
        .animate-fade-in { animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        .animate-scale-in { animation: scaleIn 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes scaleIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        
        .custom-checkbox {
            appearance: none; background-color: #fff; margin: 0; font: inherit; color: currentColor;
            width: 1.15em; height: 1.15em; border: 0.15em solid #cbd5e1; border-radius: 0.3em;
            display: grid; place-content: center; transition: all 0.2s ease-in-out;
        }
        .custom-checkbox::before {
            content: ""; width: 0.65em; height: 0.65em; transform: scale(0);
            transition: 120ms transform ease-in-out; box-shadow: inset 1em 1em white;
            transform-origin: center; clip-path: polygon(14% 44%, 0 65%, 50% 100%, 100% 16%, 80% 0%, 43% 62%);
        }
        .custom-checkbox:checked { background-color: #4F46E5; border-color: #4F46E5; }
        .custom-checkbox:checked::before { transform: scale(1); }
    </style>
</head>
<body class="bg-gray-100 flex justify-center min-h-screen text-slate-800">
    <div id="root" class="w-full md:max-w-md h-[100dvh] bg-gray-50 shadow-2xl overflow-hidden flex flex-col relative"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef, useMemo } from 'react';
        import { createRoot } from 'react-dom/client';
        import { Car, FileText, ArrowLeft, Trash2, ShieldCheck, X, Download, AlertCircle, Search, Clock, Lock, ChevronRight, UploadCloud, CheckCircle, Bell, UserCheck, BadgeCheck, PenTool, RotateCw, Briefcase, Home } from 'lucide-react';
        import { jsPDF } from 'jspdf';

        const LOCAL_STORAGE_KEY = 'parking_submissions_full_v3';
        const MASTER_BACKUP_META_KEY = 'parking_master_backup_meta_v1';
        const BACKUP_REMINDER_LAST_AT_KEY = 'parking_backup_reminder_last_at_v1';
        const BACKUP_REMINDER_REPEAT_MS = 5 * 60 * 1000;
        const OFFICIAL_BACKUP_WINDOW = { startMinutes: (21 * 60) + 50, endMinutes: (22 * 60) };
        const ADMIN_SESSION_KEY = 'parking_admin_session_v1';
        const ADMIN_SESSION_DURATION_MS = 24 * 60 * 60 * 1000;
        const STATUS_CHECK_RETENTION = { constructionDays: 1, regularMonths: 1 };
        const STORAGE_RETENTION = { constructionDays: 7, regularMonths: 1 };
        const FINAL_APPROVER_SIGNATURE_TEXT = '주차관제실';
        const OFFICIAL_FOOTER_TITLE = '강동 아이파크 더 리버몰 주차관제실';
        const OFFICIAL_FOOTER_SUBTITLE = '본 문서는 주차관제실 전자승인 문서입니다.';
        const PDF_FONT_URLS = [
            'https://cdn.jsdelivr.net/gh/google/fonts@main/ofl/nanumgothic/NanumGothic-Regular.ttf',
            'https://raw.githubusercontent.com/googlefonts/nanumgothic/master/fonts/ttf/NanumGothic-Regular.ttf'
        ];
        
        // --- 권한 및 상태 정의 ---
        const ROLES = {
            '1111': { id: 'SAFETY', name: '방재실', type: 'construction', desc: '공사/방문 차량 1차 확인' },
            '2222': { id: 'CENTER', name: '생활지원센터', type: 'all', desc: '정기권 및 방문(기타) 1차 확인' },
            '1234': { id: 'MASTER', name: '주차관제실', type: 'all', desc: '전체 내역 최종 승인' }
        };
        const REGULAR_ACCESS_DENIED_MESSAGE = '방재실 계정은 정기권 신청 권한이 없습니다.';
        const isRegularAccessBlockedForRole = (roleId) => roleId === 'SAFETY';
        const getRoleNameById = (roleId) => Object.values(ROLES).find(role => role.id === roleId)?.name || '';
        const ROLE_LOGIN_OPTIONS = ['MASTER', 'SAFETY', 'CENTER']
            .map((targetId) => {
                const entry = Object.entries(ROLES).find(([, role]) => role.id === targetId);
                if (!entry) return null;
                const [password, role] = entry;
                return { ...role, password };
            })
            .filter(Boolean);

        // 상태 라벨 변경: 1차 미승인 상태를 명확하게 '1차대기'로 표시
        const STATUS_LABELS = { 
            pending: '1차대기', // 기존 대기중 -> 1차대기 (방재실/지원센터 확인 전)
            checked: '2차대기', // 기존 1차확인 -> 2차대기 (최종 승인 전)
            approved: '최종승인', 
            rejected: '반려' 
        };

        const getStatusLabel = (status) => STATUS_LABELS[status] || status;
        
        const getStatusColor = (status) => {
            switch(status) {
                case 'approved': return 'bg-emerald-100 text-emerald-700 border border-emerald-200';
                case 'checked': return 'bg-indigo-100 text-indigo-700 border border-indigo-200';
                case 'rejected': return 'bg-rose-100 text-rose-700 border border-rose-200';
                default: return 'bg-amber-100 text-amber-700 border border-amber-200';
            }
        };

        const getStatusBorder = (status) => {
            switch(status) {
                case 'approved': return 'border-l-emerald-500';
                case 'checked': return 'border-l-indigo-500';
                case 'rejected': return 'border-l-rose-500';
                default: return 'border-l-amber-500';
            }
        };

        const getFormattedDate = () => {
            const today = new Date();
            return `${today.getFullYear()}년 ${String(today.getMonth() + 1).padStart(2, '0')}월 ${String(today.getDate()).padStart(2, '0')}일`;
        };

        const sanitizeCarNumberInput = (value) =>
            (value || '')
                .replace(/[A-Za-z]/g, '')
                .replace(/\s+/g, '');
        const sanitizePhoneInput = (value) => (value || '').replace(/[^0-9]/g, '');

        const parseSubmissionArray = (raw) => {
            if (!raw) return [];
            try {
                const parsed = typeof raw === 'string' ? JSON.parse(raw) : raw;
                return Array.isArray(parsed) ? parsed : [];
            } catch {
                return [];
            }
        };

        const toLocalYmd = (value = Date.now()) => {
            const d = new Date(value);
            if (Number.isNaN(d.getTime())) return '';
            const yyyy = d.getFullYear();
            const mm = String(d.getMonth() + 1).padStart(2, '0');
            const dd = String(d.getDate()).padStart(2, '0');
            return `${yyyy}-${mm}-${dd}`;
        };

        const toMinutesOfDay = (value = Date.now()) => {
            const d = new Date(value);
            if (Number.isNaN(d.getTime())) return -1;
            return (d.getHours() * 60) + d.getMinutes();
        };

        const isInOfficialBackupWindow = (value = Date.now()) => {
            const minuteOfDay = toMinutesOfDay(value);
            if (minuteOfDay < 0) return false;
            return minuteOfDay >= OFFICIAL_BACKUP_WINDOW.startMinutes && minuteOfDay <= OFFICIAL_BACKUP_WINDOW.endMinutes;
        };

        const hasOfficialBackupForDate = (officialBackupAt, dateValue = Date.now()) => {
            if (!officialBackupAt) return false;
            const backupDate = new Date(officialBackupAt);
            if (Number.isNaN(backupDate.getTime())) return false;
            if (toLocalYmd(backupDate) !== toLocalYmd(dateValue)) return false;
            return isInOfficialBackupWindow(backupDate);
        };

        const readBackupMeta = () => {
            const fallback = { lastBackupAt: null, officialBackupAt: null, versions: {} };
            try {
                const raw = localStorage.getItem(MASTER_BACKUP_META_KEY);
                if (!raw) return fallback;
                const parsed = JSON.parse(raw);
                const lastBackupAt = typeof parsed?.lastBackupAt === 'string' ? parsed.lastBackupAt : null;
                const officialBackupAt = typeof parsed?.officialBackupAt === 'string' ? parsed.officialBackupAt : null;
                const versions = parsed?.versions && typeof parsed.versions === 'object' ? parsed.versions : {};
                return { lastBackupAt, officialBackupAt, versions };
            } catch {
                return fallback;
            }
        };

        const writeBackupMeta = (meta) => {
            try {
                const safeMeta = {
                    lastBackupAt: typeof meta?.lastBackupAt === 'string' ? meta.lastBackupAt : null,
                    officialBackupAt: typeof meta?.officialBackupAt === 'string' ? meta.officialBackupAt : null,
                    versions: meta?.versions && typeof meta.versions === 'object' ? meta.versions : {}
                };
                localStorage.setItem(MASTER_BACKUP_META_KEY, JSON.stringify(safeMeta));
            } catch {}
        };

        const getRetentionBaseDate = (item) => {
            if (item.type === 'construction' && item.endDate) {
                const endDate = new Date(`${item.endDate}T${item.endTime || '23:59'}`);
                if (!Number.isNaN(endDate.getTime())) return endDate;
            }
            const submitted = new Date(item.submittedAt || item.updatedAt || 0);
            if (Number.isNaN(submitted.getTime())) return null;
            return submitted;
        };

        const isWithinRetentionWindow = (item, retentionPolicy) => {
            const baseDate = getRetentionBaseDate(item);
            if (!baseDate) return false;
            const expireAt = new Date(baseDate);

            if (item.type === 'construction') {
                expireAt.setDate(expireAt.getDate() + retentionPolicy.constructionDays);
            } else if (item.type === 'regular') {
                expireAt.setMonth(expireAt.getMonth() + retentionPolicy.regularMonths);
            } else {
                return true;
            }

            return new Date() <= expireAt;
        };

        const pruneSubmissionsByRetention = (items, retentionPolicy) =>
            items.filter((item) => isWithinRetentionWindow(item, retentionPolicy));

        // --- 서명 패드 ---
        const SignaturePad = ({ onSave, initialData }) => {
            const canvasRef = useRef(null);
            const [isDrawing, setIsDrawing] = useState(false);
            const [hasSignature, setHasSignature] = useState(!!initialData);
            const signatureDataRef = useRef(initialData || null);

            const drawSignatureImage = (dataUrl) => {
                const canvas = canvasRef.current;
                if (!canvas) return;
                if (!dataUrl) return;
                const ctx = canvas.getContext('2d');
                const img = new Image();
                img.onload = () => ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                img.src = dataUrl;
            };

            const syncCanvasSize = () => {
                const canvas = canvasRef.current;
                if (!canvas) return;
                const rect = canvas.getBoundingClientRect();
                const nextWidth = Math.max(1, Math.round(rect.width));
                const nextHeight = Math.max(1, Math.round(rect.height));
                if (canvas.width === nextWidth && canvas.height === nextHeight) return;

                const savedSignature = signatureDataRef.current;
                canvas.width = nextWidth;
                canvas.height = nextHeight;
                const ctx = canvas.getContext('2d');
                ctx.lineWidth = 2;
                ctx.lineCap = 'round';
                ctx.strokeStyle = '#000';

                if (savedSignature) {
                    drawSignatureImage(savedSignature);
                }
            };

            useEffect(() => {
                signatureDataRef.current = initialData || null;
                setHasSignature(!!initialData);
                syncCanvasSize();
                const rafId = requestAnimationFrame(syncCanvasSize);
                window.addEventListener('resize', syncCanvasSize);
                return () => {
                    cancelAnimationFrame(rafId);
                    window.removeEventListener('resize', syncCanvasSize);
                };
            }, [initialData]);

            const getPos = (e) => {
                const canvas = canvasRef.current;
                const rect = canvas.getBoundingClientRect();
                const clientX = (e.touches ? e.touches[0].clientX : e.clientX);
                const clientY = (e.touches ? e.touches[0].clientY : e.clientY);
                return { 
                    x: Math.max(0, Math.min(clientX - rect.left, rect.width)),
                    y: Math.max(0, Math.min(clientY - rect.top, rect.height))
                };
            };

            const startDrawing = (e) => {
                syncCanvasSize();
                e.preventDefault(); setIsDrawing(true);
                const { x, y } = getPos(e);
                const ctx = canvasRef.current.getContext('2d');
                ctx.beginPath(); ctx.moveTo(x, y); ctx.lineWidth = 2; ctx.lineCap = 'round'; ctx.strokeStyle = '#000';
            };

            const draw = (e) => {
                if (!isDrawing) return;
                e.preventDefault();
                const { x, y } = getPos(e);
                const ctx = canvasRef.current.getContext('2d');
                ctx.lineTo(x, y); ctx.stroke();
                setHasSignature(true);
            };

            const endDrawing = () => {
                if (isDrawing) {
                    setIsDrawing(false);
                    const dataUrl = canvasRef.current.toDataURL();
                    signatureDataRef.current = dataUrl;
                    onSave(dataUrl);
                }
            };

            const clear = () => {
                const canvas = canvasRef.current;
                canvas.getContext('2d').clearRect(0, 0, canvas.width, canvas.height);
                signatureDataRef.current = null;
                setHasSignature(false);
                onSave(null);
            };

            return (
                <div className="flex flex-col gap-2">
                    <div className="relative border border-slate-300 rounded-xl bg-white overflow-hidden touch-none" style={{ height: '150px' }}>
                        <canvas ref={canvasRef} className="w-full h-full cursor-crosshair" onMouseDown={startDrawing} onMouseMove={draw} onMouseUp={endDrawing} onMouseLeave={endDrawing} onTouchStart={startDrawing} onTouchMove={draw} onTouchEnd={endDrawing}/>
                        {!hasSignature && <div className="absolute inset-0 flex items-center justify-center pointer-events-none text-slate-300 select-none">서명해 주세요</div>}
                    </div>
                    <button type="button" onClick={clear} className="text-xs text-slate-500 underline self-end hover:text-rose-500">서명 지우기</button>
                </div>
            );
        };

        function FirstCheckApproveModal({ isOpen, roleName, managerName, onManagerNameChange, signature, onSignatureChange, onClose, onConfirm }) {
            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm p-4 animate-fade-in">
                    <div className="bg-white w-full max-w-sm rounded-2xl shadow-2xl overflow-hidden">
                        <div className="px-4 py-3 border-b border-slate-100 flex items-center justify-between">
                            <h3 className="text-base font-bold text-slate-800">1차 확인 승인</h3>
                            <button type="button" onClick={onClose} className="p-1.5 rounded-full hover:bg-slate-100">
                                <X size={18} className="text-slate-500" />
                            </button>
                        </div>
                        <div className="p-4 space-y-4">
                            <div>
                                <label className="block text-xs font-bold text-slate-500 mb-1.5 ml-1">확인 부서</label>
                                <input value={roleName} readOnly className="w-full p-3 bg-slate-100 border border-slate-200 rounded-xl text-sm font-medium text-slate-500" />
                            </div>
                            <div>
                                <label className="block text-xs font-bold text-slate-500 mb-1.5 ml-1">담당자 이름</label>
                                <input
                                    value={managerName}
                                    onChange={(e) => onManagerNameChange(e.target.value)}
                                    placeholder="담당자 이름 입력"
                                    className="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl focus:bg-white focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition-all text-sm font-medium"
                                />
                            </div>
                            <div>
                                <label className="block text-xs font-bold text-slate-500 mb-1.5 ml-1">담당자 서명</label>
                                <SignaturePad onSave={onSignatureChange} initialData={signature} />
                            </div>
                        </div>
                        <div className="px-4 py-3 border-t border-slate-100 bg-slate-50 flex gap-2">
                            <button type="button" onClick={onClose} className="flex-1 py-2.5 rounded-xl border border-slate-300 text-slate-600 font-bold text-sm">취소</button>
                            <button type="button" onClick={onConfirm} className="flex-1 py-2.5 rounded-xl bg-indigo-600 hover:bg-indigo-700 text-white font-bold text-sm">1차 확인</button>
                        </div>
                    </div>
                </div>
            );
        }

        const FormInput = ({ label, ...props }) => (
            <div className="mb-4">
                <label className="block text-xs font-bold text-slate-500 mb-1.5 ml-1">{label}</label>
                <input {...props} className="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl focus:bg-white focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition-all placeholder:text-slate-400 text-sm font-medium disabled:bg-slate-100 disabled:text-slate-400" />
            </div>
        );

        function App() {
            const [currentView, setCurrentView] = useState('home'); 
            const [submissions, setSubmissions] = useState({ construction: [], regular: [] });
            const [lastSubmissionType, setLastSubmissionType] = useState('');
            const [adminRole, setAdminRole] = useState(null); 
            const [adminLoginAt, setAdminLoginAt] = useState(null);
            const [editingItem, setEditingItem] = useState(null);
            const [showAdminLogin, setShowAdminLogin] = useState(false);
            const [notifications, setNotifications] = useState([]);
            const [showNotificationCenter, setShowNotificationCenter] = useState(false);

            const isValidRoleId = (roleId) => Object.values(ROLES).some((role) => role.id === roleId);
            const saveAdminSession = (roleId, loggedInAt = new Date().toISOString()) => {
                if (!isValidRoleId(roleId)) return;
                localStorage.setItem(ADMIN_SESSION_KEY, JSON.stringify({ roleId, loggedInAt }));
                setAdminRole(roleId);
                setAdminLoginAt(loggedInAt);
            };
            const clearAdminSession = ({ alertMessage = '로그아웃되어 홈 화면으로 이동합니다.', showAlert = true } = {}) => {
                localStorage.removeItem(ADMIN_SESSION_KEY);
                setAdminRole(null);
                setAdminLoginAt(null);
                setShowNotificationCenter(false);
                setShowAdminLogin(false);
                setEditingItem(null);
                setCurrentView('home');
                if (showAlert) {
                    alert(alertMessage);
                }
            };
            const handleProxySubmitDeclined = () => {
                clearAdminSession({
                    alertMessage: '대리접수 진행을 취소하여 로그아웃되고 홈 화면으로 이동합니다.'
                });
            };
            const handleHomeNavigate = (targetView) => {
                if (isRegularAccessBlockedForRole(adminRole) && targetView === 'regular') {
                    alert(REGULAR_ACCESS_DENIED_MESSAGE);
                    return;
                }
                const needsProxyConfirm = adminRole && (targetView === 'construction' || targetView === 'regular');
                if (needsProxyConfirm) {
                    const proceed = window.confirm('이 상태로 하면 대리접수가 됩니다.\n계속하시겠습니까?');
                    if (!proceed) {
                        handleProxySubmitDeclined();
                        return;
                    }
                }
                setCurrentView(targetView);
            };
            
            const toSubmissionGroups = (data) => {
                const source = Array.isArray(data) ? data : [];
                return {
                    construction: source.filter(item => item.type === 'construction').sort((a, b) => new Date(b.submittedAt) - new Date(a.submittedAt)),
                    regular: source.filter(item => item.type === 'regular').sort((a, b) => new Date(b.submittedAt) - new Date(a.submittedAt))
                };
            };

            const readLocalSubmissions = () => {
                try {
                    const raw = localStorage.getItem(LOCAL_STORAGE_KEY);
                    const parsed = parseSubmissionArray(raw);
                    const pruned = pruneSubmissionsByRetention(parsed, STORAGE_RETENTION);
                    if (pruned.length !== parsed.length) {
                        localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(pruned));
                    }
                    return toSubmissionGroups(pruned);
                } catch { return { construction: [], regular: [] }; }
            };

            const persistLocalSubmissions = (data) => {
                const source = Array.isArray(data) ? data : [];
                const pruned = pruneSubmissionsByRetention(source, STORAGE_RETENTION);
                localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(pruned));
                setSubmissions(toSubmissionGroups(pruned));
            };

            const getAllSubmissions = () => [...submissions.construction, ...submissions.regular];
            const unreadNotificationCount = notifications.reduce((count, item) => count + (item.read ? 0 : 1), 0);
            const toastNotifications = notifications.filter(item => !item.read).slice(0, 3);
            const markAllNotificationsRead = () => setNotifications(prev => prev.map(item => (item.read ? item : { ...item, read: true })));
            const clearNotifications = () => setNotifications([]);

            const pushNotifications = (messages) => {
                if (!messages || messages.length === 0) return;
                const createdAt = new Date().toISOString();
                const base = Date.now();
                const entries = messages.map((message, idx) => ({
                    id: `noti-${base}-${idx}-${Math.random().toString(36).slice(2, 6)}`,
                    message,
                    createdAt,
                    read: false
                }));
                setNotifications(prev => [...entries, ...prev].slice(0, 100));
                entries.forEach((entry) => {
                    window.setTimeout(() => {
                        setNotifications(prev => prev.map(item => item.id === entry.id ? { ...item, read: true } : item));
                    }, 5000);
                });
            };

            const buildRoleNotifications = (newData, oldData, roleId) => {
                if (!roleId) return [];
                const oldMap = new Map((oldData || []).map((item) => [item.id, item]));
                const messages = [];

                (newData || []).forEach((item) => {
                    const prev = oldMap.get(item.id);
                    const typeLabel = item.type === 'construction' ? '공사/방문' : '정기권';

                    if (!prev) {
                        if (roleId === 'SAFETY' || roleId === 'CENTER') {
                            messages.push(`신청서가 접수되었습니다. 1차 확인이 필요합니다. (${typeLabel})`);
                        }
                        if (roleId === 'MASTER' && item.status === 'checked') {
                            messages.push(`2차 확인이 필요합니다. (${typeLabel})`);
                        }
                        return;
                    }

                    if (prev.status !== item.status && item.status === 'checked' && roleId === 'MASTER') {
                        messages.push(`2차 확인이 필요합니다. (${typeLabel})`);
                    }
                });

                return messages;
            };

            useEffect(() => {
                try {
                    const rawSession = localStorage.getItem(ADMIN_SESSION_KEY);
                    if (!rawSession) return;
                    const parsed = JSON.parse(rawSession);
                    const roleId = parsed?.roleId;
                    const loggedInAt = parsed?.loggedInAt;
                    const loginMs = new Date(loggedInAt).getTime();
                    const isExpired = Number.isNaN(loginMs) || (Date.now() - loginMs >= ADMIN_SESSION_DURATION_MS);
                    if (!isValidRoleId(roleId) || isExpired) {
                        localStorage.removeItem(ADMIN_SESSION_KEY);
                        return;
                    }
                    setAdminRole(roleId);
                    setAdminLoginAt(loggedInAt);
                } catch {
                    localStorage.removeItem(ADMIN_SESSION_KEY);
                }
            }, []);

            useEffect(() => {
                const handleSessionStorageChange = (e) => {
                    if (e.key !== ADMIN_SESSION_KEY) return;
                    if (!e.newValue) {
                        clearAdminSession();
                        return;
                    }
                    try {
                        const parsed = JSON.parse(e.newValue);
                        const roleId = parsed?.roleId;
                        const loggedInAt = parsed?.loggedInAt;
                        const loginMs = new Date(loggedInAt).getTime();
                        const isExpired = Number.isNaN(loginMs) || (Date.now() - loginMs >= ADMIN_SESSION_DURATION_MS);
                        if (!isValidRoleId(roleId) || isExpired) {
                            clearAdminSession();
                            return;
                        }
                        setAdminRole(roleId);
                        setAdminLoginAt(loggedInAt);
                    } catch {
                        clearAdminSession();
                    }
                };
                window.addEventListener('storage', handleSessionStorageChange);
                return () => window.removeEventListener('storage', handleSessionStorageChange);
            }, []);

            useEffect(() => {
                if (!adminRole || !adminLoginAt) return;
                const loginMs = new Date(adminLoginAt).getTime();
                if (Number.isNaN(loginMs)) {
                    clearAdminSession({ showAlert: false });
                    return;
                }
                const remainingMs = (loginMs + ADMIN_SESSION_DURATION_MS) - Date.now();
                if (remainingMs <= 0) {
                    clearAdminSession({ alertMessage: '관리자 로그인 유지시간(24시간)이 만료되어 자동 로그아웃되어 홈 화면으로 이동합니다.' });
                    return;
                }
                const timeoutId = window.setTimeout(() => {
                    clearAdminSession({ alertMessage: '관리자 로그인 유지시간(24시간)이 만료되어 자동 로그아웃되어 홈 화면으로 이동합니다.' });
                }, remainingMs);
                return () => window.clearTimeout(timeoutId);
            }, [adminRole, adminLoginAt]);

            useEffect(() => {
                setSubmissions(readLocalSubmissions());
                const handleStorageChange = (e) => {
                    if (e.key === LOCAL_STORAGE_KEY) {
                        const newData = parseSubmissionArray(e.newValue);
                        const oldData = parseSubmissionArray(e.oldValue);
                        setSubmissions(readLocalSubmissions());
                        if (adminRole) {
                            const messages = buildRoleNotifications(newData, oldData, adminRole);
                            pushNotifications(messages);
                        }
                    }
                };
                window.addEventListener('storage', handleStorageChange);
                return () => window.removeEventListener('storage', handleStorageChange);
            }, [adminRole]);

            useEffect(() => {
                const runBackupReminder = () => {
                    const now = new Date();
                    if (Number.isNaN(now.getTime())) return;
                    const isReminderWindow = isInOfficialBackupWindow(now);
                    if (!isReminderWindow) return;

                    const backupMeta = readBackupMeta();
                    const hasOfficialBackupToday = hasOfficialBackupForDate(backupMeta?.officialBackupAt, now);
                    if (hasOfficialBackupToday) return;

                    const lastReminderAtRaw = localStorage.getItem(BACKUP_REMINDER_LAST_AT_KEY);
                    const lastReminderAt = Number(lastReminderAtRaw);
                    if (Number.isFinite(lastReminderAt) && (now.getTime() - lastReminderAt < BACKUP_REMINDER_REPEAT_MS)) {
                        return;
                    }
                    localStorage.setItem(BACKUP_REMINDER_LAST_AT_KEY, `${now.getTime()}`);

                    const toastMessage = adminRole === 'MASTER'
                        ? '21:50 백업 시간입니다. 개별 백업을 실행해주세요.'
                        : '21:50 공식백업 시간입니다. 주차관제실 계정으로 백업해주세요.';
                    pushNotifications([toastMessage]);

                    const alertMessage = adminRole === 'MASTER'
                        ? '21:50 백업 시간입니다.\n관리자 화면에서 "주차관제실 개별 백업 (폴더 저장)"을 실행해주세요.'
                        : '21:50 백업 시간입니다.\n주차관제실 계정으로 로그인 후 개별 백업을 실행해주세요.';
                    alert(alertMessage);
                };

                runBackupReminder();
                const timerId = window.setInterval(runBackupReminder, 30 * 1000);
                return () => window.clearInterval(timerId);
            }, [adminRole]);

            const checkTimeOverlap = (newData, type, excludeId = null) => {
                const normalize = (s) => s?.replace(/\s+/g, '').toUpperCase();
                const newStart = new Date(`${newData.startDate}T${newData.startTime || '00:00'}`);
                const newEnd = new Date(`${newData.endDate}T${newData.endTime || '23:59'}`);
                
                const targetList = type === 'construction' ? submissions.construction : submissions.regular;
                
                for (const existing of targetList) {
                    if (excludeId && existing.id === excludeId) continue;
                    if (existing.status === 'rejected') continue;

                    let hasOverlap = false;
                    let overlappedCar = '';

                    if (type === 'construction') {
                        const newVs = (newData.vehicles||[]).map(normalize).filter(Boolean);
                        const exVs = (existing.vehicles||[]).map(normalize).filter(Boolean);
                        const match = newVs.find(v => exVs.includes(v));
                        if (match) { hasOverlap = true; overlappedCar = match; }
                    } else {
                        const nC = normalize(newData.carNumber);
                        const eC = normalize(existing.carNumber);
                        if (nC && nC === eC) { hasOverlap = true; overlappedCar = newData.carNumber; }
                    }

                    if (!hasOverlap) continue;

                    const exStart = new Date(`${existing.startDate}T${existing.startTime || '00:00'}`);
                    const exEnd = new Date(`${existing.endDate}T${existing.endTime || '23:59'}`);
                    
                    if (newStart < exEnd && newEnd > exStart) {
                        return { isOverlap: true, car: overlappedCar, existing };
                    }
                }
                return { isOverlap: false };
            };

            const REQUIRED_FIELD_LABELS = {
                construction: {
                    companyName: '업체명',
                    visitorName: '방문자 성명',
                    visitUnit: '방문 호수',
                    visitSchedule: '방문 일시',
                    driverPhone: '연락처',
                    vehicles: '차량번호',
                    signature: '신청자 서명',
                    proxySignature: '대리 접수 서명',
                    proxySubmitterName: '대리 접수자명'
                },
                regular: {
                    name: '이름',
                    department: '부서',
                    phone: '연락처',
                    carNumber: '차량번호',
                    unitNumber: '호수',
                    signature: '신청자 서명',
                    proxySignature: '대리 접수 서명',
                    proxySubmitterName: '대리 접수자명',
                    registrationImg: '차량등록증',
                    idCardImg: '사원증/신분증',
                    oldCarNumber: '기존 차량번호',
                    changeReason: '변경 사유'
                }
            };
            const toRequiredFieldLabel = (type, key) => REQUIRED_FIELD_LABELS[type]?.[key] || key;
            const createActivityLogEntry = ({ action, detail, actor, at }) => ({
                id: `log-${Date.now()}-${Math.random().toString(36).slice(2, 6)}`,
                at: at || new Date().toISOString(),
                action: action || '기록',
                detail: detail || '',
                actor: actor || '시스템'
            });
            const mergeActivityLogs = (item, ...entries) => {
                const prev = Array.isArray(item?.activityLogs) ? item.activityLogs : [];
                const next = [...prev, ...entries.filter(Boolean)];
                return next.slice(-200);
            };
            const getCurrentActorName = (fallback = '신청자') => {
                const roleName = getRoleNameById(adminRole);
                return roleName || fallback;
            };
            const getReceptionMeta = () => {
                if (adminRole) {
                    return {
                        receptionType: 'proxy',
                        receptionRole: adminRole,
                        receptionDesk: getRoleNameById(adminRole) || '관리자'
                    };
                }
                return {
                    receptionType: 'self',
                    receptionRole: null,
                    receptionDesk: '소비자'
                };
            };

            const getMissingRequiredFields = (type, data) => {
                const missing = [];
                const hasText = (value) => `${value || ''}`.trim().length > 0;
                const hasPhone = (value) => sanitizePhoneInput(value).length > 0;
                const hasCar = (value) => sanitizeCarNumberInput(value).length > 0;

                if (type === 'construction') {
                    if (!hasText(data.companyName)) missing.push('companyName');
                    if (!hasText(data.visitorName)) missing.push('visitorName');
                    if (!hasText(data.visitUnit)) missing.push('visitUnit');
                    if (!hasText(data.startDate) || !hasText(data.endDate) || !hasText(data.startTime) || !hasText(data.endTime)) missing.push('visitSchedule');
                    if (!hasPhone(data.driverPhone)) missing.push('driverPhone');
                    const vehicles = Array.isArray(data.vehicles) ? data.vehicles : [];
                    if (!vehicles.some((vehicle) => hasCar(vehicle))) missing.push('vehicles');
                    if (data.receptionType === 'proxy' && !hasText(data.proxySubmitterName)) missing.push('proxySubmitterName');
                    if (!hasText(data.signature)) missing.push(data.receptionType === 'proxy' ? 'proxySignature' : 'signature');
                    return missing;
                }

                if (type === 'regular') {
                    if (!hasText(data.name)) missing.push('name');
                    if (!hasText(data.department)) missing.push('department');
                    if (!hasPhone(data.phone)) missing.push('phone');
                    if (!hasCar(data.carNumber)) missing.push('carNumber');
                    if (!hasText(data.unitNumber)) missing.push('unitNumber');
                    if (data.receptionType === 'proxy' && !hasText(data.proxySubmitterName)) missing.push('proxySubmitterName');
                    if (!hasText(data.signature)) missing.push(data.receptionType === 'proxy' ? 'proxySignature' : 'signature');
                    if (!hasText(data.registrationImg)) missing.push('registrationImg');
                    if (data.applicationType === 'change') {
                        if (!hasCar(data.oldCarNumber)) missing.push('oldCarNumber');
                        if (!hasText(data.changeReason)) missing.push('changeReason');
                    }
                }

                return missing;
            };

            const handleSave = (type, data, isEdit, docId) => {
                if (type === 'regular' && isRegularAccessBlockedForRole(adminRole)) {
                    alert(REGULAR_ACCESS_DENIED_MESSAGE);
                    setEditingItem(null);
                    setCurrentView('home');
                    return { ok: false, blockedByRole: true };
                }
                const all = [...submissions.construction, ...submissions.regular];
                const nowIso = new Date().toISOString();
                const receptionMeta = getReceptionMeta();
                const proxySubmitterName = receptionMeta.receptionType === 'proxy'
                    ? `${data?.proxySubmitterName || ''}`.trim()
                    : null;
                const cleanData = { ...data, ...receptionMeta, proxySubmitterName, updatedAt: nowIso };
                const missingRequiredFields = [...new Set(getMissingRequiredFields(type, cleanData))];
                if (missingRequiredFields.length > 0) {
                    const labels = missingRequiredFields.map((fieldKey) => toRequiredFieldLabel(type, fieldKey));
                    alert(`필수 입력 항목이 누락되었습니다.\n- ${labels.join('\n- ')}`);
                    return { ok: false, missingFields: missingRequiredFields };
                }
                const requestTypeLabel = type === 'construction' ? '공사/방문' : '정기권';
                const receptionLabel = cleanData.receptionType === 'proxy'
                    ? `대리접수 (${cleanData.receptionDesk || '관리자'}${cleanData.proxySubmitterName ? ` / ${cleanData.proxySubmitterName}` : ''})`
                    : '본인접수';
                const isAutoCheckedRealEstate = type === 'construction' && cleanData.visitPurpose === '부동산';
                const firstCheckDefaults = isAutoCheckedRealEstate ? {
                    status: 'checked',
                    checkedBy: '주차관제실',
                    firstCheckedManagerName: '주차관제실',
                    firstCheckedManagerRole: 'MASTER',
                    firstCheckedManagerSignature: null,
                    firstCheckedAt: nowIso,
                    finalApprovalSignatureText: null
                } : {
                    status: 'pending',
                    checkedBy: null,
                    firstCheckedManagerName: null,
                    firstCheckedManagerRole: null,
                    firstCheckedManagerSignature: null,
                    firstCheckedAt: null,
                    finalApprovalSignatureText: null
                };
                
                let nextSubmissions;
                if (isEdit && docId) {
                    nextSubmissions = all.map(item => {
                        if (item.id !== docId) return item;
                        const actor = getCurrentActorName('신청자');
                        const logs = mergeActivityLogs(
                            item,
                            createActivityLogEntry({
                                at: nowIso,
                                action: '수정',
                                detail: `${requestTypeLabel} 신청서 수정 (${receptionLabel})`,
                                actor
                            }),
                            item.status !== firstCheckDefaults.status
                                ? createActivityLogEntry({
                                    at: nowIso,
                                    action: '상태변경',
                                    detail: `상태 변경: ${getStatusLabel(item.status)} -> ${getStatusLabel(firstCheckDefaults.status)} (수정 후 재검토)`,
                                    actor
                                })
                                : null
                        );
                        return {
                            ...item,
                            ...cleanData,
                            ...firstCheckDefaults,
                            approvedBy: null,
                            approvedAt: null,
                            finalApprovalSignatureText: null,
                            rejectionReason: null,
                            rejectedBy: null,
                            rejectedAt: null,
                            activityLogs: logs
                        };
                    });
                } else {
                    const submitterActor = getCurrentActorName('신청자');
                    const initialLogEntries = [
                        createActivityLogEntry({
                            at: nowIso,
                            action: '접수',
                            detail: `${requestTypeLabel} 신청 접수 (${receptionLabel})`,
                            actor: submitterActor
                        })
                    ];
                    if (isAutoCheckedRealEstate) {
                        initialLogEntries.push(
                            createActivityLogEntry({
                                at: nowIso,
                                action: '상태변경',
                                detail: `상태 변경: ${getStatusLabel('pending')} -> ${getStatusLabel('checked')} (자동 1차 확인)`,
                                actor: '주차관제실'
                            })
                        );
                    }
                    const newItem = {
                        id: `doc-${Date.now()}-${Math.random().toString(36).substr(2,5)}`,
                        type,
                        ...firstCheckDefaults,
                        submittedAt: nowIso,
                        ...cleanData,
                        activityLogs: mergeActivityLogs(null, ...initialLogEntries)
                    };
                    nextSubmissions = [newItem, ...all];
                }
                persistLocalSubmissions(nextSubmissions);
                setEditingItem(null);
                setLastSubmissionType(type === 'construction' ? '공사/방문 등록' : '정기권 신청');
                setCurrentView('success');
                return { ok: true };
            };

            const updateStatus = (id, newStatus, reason = null, meta = {}) => {
                if (newStatus === 'rejected' && !(reason || '').trim()) {
                    alert('반려 사유를 입력해 주세요.');
                    return { ok: false };
                }
                const nowIso = new Date().toISOString();
                const all = getAllSubmissions();
                const next = all.map(item => {
                    if (item.id !== id) return item;
                    const updates = { status: newStatus };
                    const roleInfo = ROLES[Object.keys(ROLES).find(k => ROLES[k].id === adminRole)];
                    const name = roleInfo ? roleInfo.name : 'Unknown';
                    let statusChangeDetail = `상태 변경: ${getStatusLabel(item.status)} -> ${getStatusLabel(newStatus)}`;

                    if (newStatus === 'checked') {
                        updates.checkedBy = name;
                        updates.firstCheckedManagerName = meta.managerName || item.firstCheckedManagerName || null;
                        updates.firstCheckedManagerRole = meta.managerRole || adminRole || item.firstCheckedManagerRole || null;
                        updates.firstCheckedManagerSignature = meta.managerSignature || item.firstCheckedManagerSignature || null;
                        updates.firstCheckedAt = nowIso;
                        if (meta.managerName) {
                            statusChangeDetail += ` (담당자: ${meta.managerName})`;
                        }
                    }
                    else if (newStatus === 'approved') {
                        updates.approvedBy = FINAL_APPROVER_SIGNATURE_TEXT;
                        updates.approvedAt = nowIso;
                        updates.finalApprovalSignatureText = FINAL_APPROVER_SIGNATURE_TEXT;
                    }
                    else if (newStatus === 'rejected') {
                        updates.rejectionReason = (reason || '').trim();
                        updates.rejectedBy = name;
                        updates.rejectedAt = nowIso;
                        updates.finalApprovalSignatureText = null;
                        statusChangeDetail += ` (사유: ${(reason || '').trim()})`;
                    }
                    updates.activityLogs = mergeActivityLogs(
                        item,
                        createActivityLogEntry({
                            at: nowIso,
                            action: '상태변경',
                            detail: statusChangeDetail,
                            actor: name
                        })
                    );
                    return { ...item, ...updates };
                });
                persistLocalSubmissions(next);
                return { ok: true };
            };

            const deleteSubmissions = (ids) => {
                if (!ids || ids.length === 0) return;
                const idSet = new Set(ids);
                const next = getAllSubmissions().filter(item => !idSet.has(item.id));
                persistLocalSubmissions(next);
            };

            const renderView = () => {
                if (isRegularAccessBlockedForRole(adminRole) && (currentView === 'regular' || currentView === 'edit_regular')) {
                    return <HomeScreen onNavigate={handleHomeNavigate} adminRole={adminRole} onOpenAdmin={() => setShowAdminLogin(true)} />;
                }
                switch (currentView) {
                    case 'home': return <HomeScreen onNavigate={handleHomeNavigate} adminRole={adminRole} onOpenAdmin={() => setShowAdminLogin(true)} />;
                    case 'construction': return <ConstructionForm onBack={() => setCurrentView('home')} userRole={adminRole} onSubmit={(data) => {
                        const check = checkTimeOverlap(data, 'construction');
                        if (check.isOverlap) { alert(`[중복] 차량 ${check.car}는 이미 등록되어 있습니다.`); return { ok: false }; }
                        return handleSave('construction', data, false);
                    }} />;
                    case 'regular': return <RegularTicketForm onBack={() => setCurrentView('home')} userRole={adminRole} onSubmit={(data) => {
                        if (data.applicationType !== 'change') {
                            const check = checkTimeOverlap({...data, startDate: new Date().toISOString().split('T')[0], endDate: '2099-12-31'}, 'regular');
                            if (check.isOverlap) { alert(`[중복] 차량 ${check.car}는 이미 등록되어 있습니다.`); return { ok: false }; }
                        }
                        return handleSave('regular', data, false);
                    }} />;
                    case 'edit_construction': return <ConstructionForm onBack={() => setCurrentView('statusCheck')} userRole={adminRole} initialData={editingItem} onSubmit={(data) => handleSave('construction', data, true, editingItem.id)} />;
                    case 'edit_regular': return <RegularTicketForm onBack={() => setCurrentView('statusCheck')} userRole={adminRole} initialData={editingItem} onSubmit={(data) => handleSave('regular', data, true, editingItem.id)} />;
                    case 'statusCheck': return <StatusCheckScreen onBack={() => setCurrentView('home')} submissions={submissions} onEdit={(item)=>{ setEditingItem(item); setCurrentView(item.type==='construction'?'edit_construction':'edit_regular'); }} />;
                    case 'admin': return <AdminDashboard onBack={() => setCurrentView('home')} submissions={submissions} onUpdateStatus={updateStatus} onDeleteSubmissions={deleteSubmissions} adminRole={adminRole} />;
                    case 'success': return <SuccessScreen type={lastSubmissionType} onHome={() => setCurrentView('home')} />;
                    default: return <HomeScreen onNavigate={handleHomeNavigate} />;
                }
            };

            return (
                <div className="flex flex-col h-full bg-slate-50 relative">
                    <header className="bg-slate-900 text-white px-4 sm:px-5 py-3 sm:py-4 shrink-0 z-10 shadow-lg safe-area-top">
                        <div className="flex items-center justify-between gap-2">
                            <div className="flex items-center gap-2.5 min-w-0">
                                <div className="bg-indigo-600 p-1.5 rounded-lg shadow-inner shrink-0">
                                    <ShieldCheck size={20} className="text-white"/>
                                </div>
                                <h1 className="text-base sm:text-lg font-bold tracking-tight whitespace-nowrap truncate">주차 신청 접수시스템</h1>
                            </div>
                            <button
                                onClick={() => {
                                    if (showNotificationCenter) {
                                        setShowNotificationCenter(false);
                                        return;
                                    }
                                    markAllNotificationsRead();
                                    setShowNotificationCenter(true);
                                }}
                                className="relative px-2.5 py-1.5 rounded-full border border-slate-700 text-slate-300 hover:text-white hover:border-slate-500 hover:bg-slate-800 transition-all duration-200 flex items-center justify-center shrink-0"
                                aria-label="알림"
                                title="알림"
                            >
                                <Bell size={14} />
                                {unreadNotificationCount > 0 && <span className="absolute -top-1 -right-1 min-w-[18px] h-[18px] px-1 bg-rose-500 text-white text-[10px] rounded-full flex items-center justify-center font-bold">{unreadNotificationCount > 9 ? '9+' : unreadNotificationCount}</span>}
                            </button>
                        </div>
                        <div className="mt-2 flex items-center justify-end gap-2">
                            <button
                                onClick={() => { setCurrentView('home'); setEditingItem(null); }}
                                className={`px-3 py-1.5 rounded-full border transition-all duration-200 flex items-center gap-1.5 shrink-0 ${currentView === 'home' ? 'bg-slate-800 border-slate-600 text-slate-200' : 'border-slate-700 text-slate-400 hover:text-white hover:border-slate-500 hover:bg-slate-800'}`}
                            >
                                <Home size={12} />
                                <span className="text-xs font-bold whitespace-nowrap">홈</span>
                            </button>
                            <button onClick={() => adminRole ? clearAdminSession() : setShowAdminLogin(true)} className={`px-3 py-1.5 rounded-full border transition-all duration-200 flex items-center gap-1.5 shrink-0 ${adminRole ? 'bg-indigo-600 border-indigo-500 text-white shadow-md' : 'border-slate-700 text-slate-400 hover:text-white hover:border-slate-500 hover:bg-slate-800'}`}>
                                <Lock size={12} />
                                <span className="text-xs font-bold whitespace-nowrap">{adminRole ? '로그아웃' : '로그인'}</span>
                            </button>
                        </div>
                    </header>
                    <main className="flex-1 overflow-y-auto relative">{renderView()}</main>
                    <NotificationCenterModal
                        isOpen={showNotificationCenter}
                        onClose={() => setShowNotificationCenter(false)}
                        notifications={notifications}
                        onMarkAllRead={markAllNotificationsRead}
                        onClear={clearNotifications}
                    />
                    <div className="absolute top-4 right-4 flex flex-col gap-2 z-50 pointer-events-none">
                        {toastNotifications.map(noti => (
                            <div key={noti.id} className="bg-slate-800/90 backdrop-blur text-white p-3 rounded-xl shadow-xl flex items-center gap-3 animate-slide-in-right">
                                <Bell className="text-yellow-400 animate-bounce-short" size={20} />
                                <span className="text-sm font-bold">{noti.message}</span>
                            </div>
                        ))}
                    </div>
                    {showAdminLogin && <AdminLoginModal isOpen={showAdminLogin} onClose={() => setShowAdminLogin(false)} onLogin={(roleId) => { saveAdminSession(roleId); setShowAdminLogin(false); }} />}
                </div>
            );
        }

        // ... 부가 모달 및 유틸 컴포넌트 ...
        function HistoryModal({ isOpen, onClose, historyList, targetCar }) {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm p-4 animate-fade-in">
                    <div className="bg-white w-full max-w-sm rounded-2xl shadow-2xl overflow-hidden max-h-[80vh] flex flex-col transform transition-all scale-100">
                        <div className="p-4 border-b flex justify-between bg-rose-50"><h3 className="font-bold flex items-center gap-2 text-rose-600"><AlertCircle size={20}/> 중복 이력</h3><button onClick={onClose} className="text-gray-500 hover:text-gray-800"><X size={20}/></button></div>
                        <div className="p-3 bg-amber-50 text-sm text-amber-900 border-b border-amber-100 px-5">차량 <strong>{targetCar}</strong>의 금일 내역</div>
                        <div className="flex-1 overflow-y-auto p-4 space-y-3 bg-slate-50">
                            {historyList.map((item, idx) => (
                                <div key={idx} className="border border-slate-200 p-4 rounded-xl bg-white shadow-sm">
                                    <div className="flex justify-between text-xs mb-2 pb-2 border-b border-dashed border-slate-100">
                                        <span className="bg-slate-100 text-slate-600 px-2 py-0.5 rounded-full font-medium">{new Date(item.submittedAt).toLocaleTimeString()} 신청</span>
                                        <span className={`px-2 py-0.5 rounded-full font-bold border ${getStatusColor(item.status)} text-[10px]`}>{getStatusLabel(item.status)}</span>
                                    </div>
                                    <div className="text-base font-bold text-slate-800 mb-1">{item.type==='construction'?item.companyName:item.name}</div>
                                    {item.type === 'construction' && (
                                        <div className="text-sm font-bold text-indigo-600 mb-1 bg-indigo-50 px-2 py-1 rounded-md inline-flex items-center gap-1 border border-indigo-100"><Clock size={12}/> {item.startTime} ~ {item.endTime}</div>
                                    )}
                                    <div className="text-xs text-slate-500 flex items-center gap-1 mt-1"><Briefcase size={12}/>{item.type==='construction'?`목적: ${item.visitPurpose}`:item.applicationType}</div>
                                </div>
                            ))}
                        </div>
                        <div className="p-4 bg-white border-t border-slate-100"><button onClick={onClose} className="w-full py-3 bg-slate-800 text-white rounded-xl font-bold hover:bg-slate-900 transition shadow-lg shadow-slate-200">닫기</button></div>
                    </div>
                </div>
            );
        }

        function ImageModal({ src, onClose, title }) {
            if (!src) return null;
            return (
                <div className="fixed inset-0 z-[60] flex items-center justify-center bg-black/90 p-4 animate-fade-in cursor-pointer" onClick={onClose}>
                    <img src={src} className="max-w-full max-h-[80vh] object-contain rounded-lg shadow-2xl bg-white" />
                    {title && <div className="absolute top-6 left-6 text-white font-bold text-lg">{title}</div>}
                    <button className="absolute top-6 right-6 text-white bg-white/20 p-2 rounded-full hover:bg-white/30"><X size={28}/></button>
                    <div className="absolute bottom-6 text-white/70 text-sm bg-black/50 px-3 py-1 rounded-full">화면을 눌러 닫기</div>
                </div>
            )
        }

        function NotificationCenterModal({ isOpen, onClose, notifications, onMarkAllRead, onClear }) {
            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 z-[70] bg-black/40 backdrop-blur-sm p-4 animate-fade-in" onClick={onClose}>
                    <div className="ml-auto w-full max-w-sm h-[70vh] bg-white rounded-2xl shadow-2xl border border-slate-200 overflow-hidden flex flex-col" onClick={(e) => e.stopPropagation()}>
                        <div className="px-4 py-3 border-b border-slate-100 flex items-center justify-between bg-slate-50">
                            <h3 className="font-bold text-slate-800 flex items-center gap-2"><Bell size={16}/> 알림</h3>
                            <button onClick={onClose} className="p-1.5 rounded-full hover:bg-slate-200"><X size={16} className="text-slate-500" /></button>
                        </div>
                        <div className="flex-1 overflow-y-auto p-3 space-y-2 bg-white">
                            {notifications.length === 0 ? (
                                <div className="h-full flex items-center justify-center text-sm text-slate-400">표시할 알림이 없습니다.</div>
                            ) : (
                                notifications.map((noti) => {
                                    const created = new Date(noti.createdAt || Date.now());
                                    const timeText = Number.isNaN(created.getTime()) ? '-' : created.toLocaleString('ko-KR', { month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' });
                                    return (
                                        <div key={noti.id} className={`p-3 rounded-xl border ${noti.read ? 'bg-slate-50 border-slate-200' : 'bg-indigo-50 border-indigo-200'}`}>
                                            <div className="flex justify-between items-start gap-2">
                                                <p className={`text-sm font-semibold ${noti.read ? 'text-slate-600' : 'text-slate-800'}`}>{noti.message}</p>
                                                {!noti.read && <span className="w-2 h-2 mt-1 rounded-full bg-indigo-500 shrink-0"></span>}
                                            </div>
                                            <div className="text-[11px] text-slate-400 mt-1">{timeText}</div>
                                        </div>
                                    );
                                })
                            )}
                        </div>
                        <div className="px-3 py-3 border-t border-slate-100 bg-slate-50 grid grid-cols-2 gap-2">
                            <button onClick={onMarkAllRead} className="py-2.5 rounded-lg border border-slate-300 text-slate-600 text-sm font-bold hover:bg-white">모두 읽음</button>
                            <button onClick={onClear} className="py-2.5 rounded-lg bg-rose-500 text-white text-sm font-bold hover:bg-rose-600">전체 삭제</button>
                        </div>
                    </div>
                </div>
            );
        }

        // --- 관리자 대시보드 ---
        function AdminDashboard({ onBack, submissions, onUpdateStatus, onDeleteSubmissions, adminRole }) {
            const getInitialTab = () => {
                if (adminRole === 'SAFETY') return 'construction';
                if (adminRole === 'CENTER') return 'regular';
                return 'construction'; 
            };

            const [activeTab, setActiveTab] = useState(getInitialTab());
            const [filterYear, setFilterYear] = useState(new Date().getFullYear());
            const [filterMonth, setFilterMonth] = useState(new Date().getMonth() + 1);
            const [filterDay, setFilterDay] = useState('all');
            
            const [filterStatus, setFilterStatus] = useState(adminRole === 'MASTER' ? 'checked' : 'all');
            
            const [searchType, setSearchType] = useState('all'); 
            const [searchText, setSearchText] = useState(''); 
            const [expandedId, setExpandedId] = useState(null); 
            const [historyOpen, setHistoryOpen] = useState(false);
            const [historyList, setHistoryList] = useState([]);
            const [targetCar, setTargetCar] = useState('');
            const [rejectingId, setRejectingId] = useState(null);
            const [rejectReason, setRejectReason] = useState("");
            const [isZipping, setIsZipping] = useState(false);
            const [viewImage, setViewImage] = useState(null);
            const [viewImageTitle, setViewImageTitle] = useState('');
            const [selectedIds, setSelectedIds] = useState(new Set()); 
            const pdfFontBase64Ref = useRef(null);
            const [checkingItem, setCheckingItem] = useState(null);
            const [firstCheckerName, setFirstCheckerName] = useState('');
            const [firstCheckerSignature, setFirstCheckerSignature] = useState(null);
            const [isBackingUpLocally, setIsBackingUpLocally] = useState(false);
            const [backupMeta, setBackupMeta] = useState(() => readBackupMeta());
            const [backupClockTick, setBackupClockTick] = useState(Date.now());
            const normalizeBackupName = (value, fallback = 'unknown') => {
                const cleaned = `${value || ''}`
                    .trim()
                    .replace(/\s+/g, '_')
                    .replace(/[\\/:*?"<>|]/g, '')
                    .replace(/[^\w\u3131-\u318E\uAC00-\uD7A3._-]/g, '');
                return (cleaned || fallback).slice(0, 60);
            };
            const getDateParts = (value) => {
                const d = new Date(value || Date.now());
                if (Number.isNaN(d.getTime())) return null;
                const yyyy = `${d.getFullYear()}`;
                const mm = `${d.getMonth() + 1}`.padStart(2, '0');
                const dd = `${d.getDate()}`.padStart(2, '0');
                const hh = `${d.getHours()}`.padStart(2, '0');
                const min = `${d.getMinutes()}`.padStart(2, '0');
                return { yyyy, mm, dd, hh, min };
            };
            const getItemBackupVersion = (item) => `${item?.updatedAt || item?.submittedAt || ''}|${item?.status || ''}|${item?.type || ''}`;
            const getBackupTypeFolder = (item) => item?.type === 'construction' ? '공사방문' : '정기권';
            const getBackupStatusFolder = (item) => normalizeBackupName(getStatusLabel(item?.status || ''), '상태미상');
            const getBackupCarName = (item) => {
                if (item?.type === 'construction') {
                    const cars = Array.isArray(item?.vehicles) ? item.vehicles.filter(Boolean) : [];
                    return normalizeBackupName(cars.join('_'), '차량없음');
                }
                return normalizeBackupName(item?.carNumber, '차량없음');
            };
            const buildBackupFileName = (item) => {
                const submittedParts = getDateParts(item?.submittedAt) || getDateParts(Date.now());
                const timeText = `${submittedParts.yyyy}${submittedParts.mm}${submittedParts.dd}_${submittedParts.hh}${submittedParts.min}`;
                const owner = normalizeBackupName(item?.type === 'construction' ? item?.companyName : item?.name, '신청자');
                const car = getBackupCarName(item);
                const docId = normalizeBackupName(item?.id, `doc_${Date.now()}`);
                return `${timeText}_${docId}_${owner}_${car}.pdf`;
            };

            const lastBackupDate = backupMeta?.lastBackupAt ? new Date(backupMeta.lastBackupAt) : null;
            const hasValidLastBackupStamp = !!lastBackupDate && !Number.isNaN(lastBackupDate.getTime());
            const nowForBackup = new Date(backupClockTick);
            const nowMinuteOfDay = toMinutesOfDay(nowForBackup);
            const isBeforeBackupWindow = nowMinuteOfDay >= 0 && nowMinuteOfDay < OFFICIAL_BACKUP_WINDOW.startMinutes;
            const isInBackupWindow = nowMinuteOfDay >= OFFICIAL_BACKUP_WINDOW.startMinutes && nowMinuteOfDay <= OFFICIAL_BACKUP_WINDOW.endMinutes;
            const isAfterBackupWindow = nowMinuteOfDay > OFFICIAL_BACKUP_WINDOW.endMinutes;
            const hasOfficialBackupToday = hasOfficialBackupForDate(backupMeta?.officialBackupAt, nowForBackup);
            const officialBackupDate = backupMeta?.officialBackupAt ? new Date(backupMeta.officialBackupAt) : null;
            const hasOfficialStamp = !!officialBackupDate && !Number.isNaN(officialBackupDate.getTime());
            const recentBackupText = hasValidLastBackupStamp
                ? `최근 백업: ${lastBackupDate.toLocaleString('ko-KR')}`
                : '최근 백업: 없음';
            const backupStatusText = hasOfficialBackupToday
                ? `오늘 공식 백업 완료: ${hasOfficialStamp ? officialBackupDate.toLocaleString('ko-KR') : '-' }`
                : (isBeforeBackupWindow
                    ? '오늘 공식 백업 대기 (21:50~22:00)'
                    : (isInBackupWindow
                        ? '공식 백업 시간입니다 (21:50~22:00)'
                        : (isAfterBackupWindow ? '오늘 공식 백업 미완료 (즉시 실행 필요)' : '오늘 공식 백업 상태 확인 필요')));
            const backupStatusClass = hasOfficialBackupToday
                ? 'text-emerald-600'
                : (isAfterBackupWindow ? 'text-rose-600' : (isInBackupWindow ? 'text-amber-600' : 'text-slate-500'));

            useEffect(() => {
                const timerId = window.setInterval(() => setBackupClockTick(Date.now()), 30 * 1000);
                return () => window.clearInterval(timerId);
            }, []);
            const yearOptions = useMemo(() => {
                const currentYear = new Date().getFullYear();
                const years = new Set([currentYear]);
                [...(submissions.construction || []), ...(submissions.regular || [])].forEach(item => {
                    const d = new Date(item.submittedAt);
                    if (!Number.isNaN(d.getTime())) years.add(d.getFullYear());
                });
                return Array.from(years).sort((a, b) => b - a);
            }, [submissions]);

            useEffect(() => {
                if (yearOptions.length === 0) return;
                if (!yearOptions.includes(Number(filterYear))) {
                    setFilterYear(yearOptions[0]);
                }
            }, [yearOptions, filterYear]);

            useEffect(() => {
                if (adminRole === 'SAFETY') setActiveTab('construction');
                if (adminRole === 'CENTER') setActiveTab('regular');
                if (adminRole === 'MASTER') setActiveTab('construction');
            }, [adminRole]);

            const list = submissions[activeTab] || [];
            const filteredList = list.filter(item => {
                const d = new Date(item.submittedAt);
                if (d.getFullYear() !== parseInt(filterYear)) return false;
                if ((d.getMonth()+1) !== parseInt(filterMonth)) return false;
                if (filterDay!=='all' && d.getDate() !== parseInt(filterDay)) return false;
                if (filterStatus!=='all' && item.status !== filterStatus) return false;

                if (activeTab === 'construction') {
                    if (adminRole === 'SAFETY' && !['공사', '기타'].includes(item.visitPurpose)) return false;
                    if (adminRole === 'CENTER' && item.visitPurpose !== '기타') return false;
                }
                
                if (searchText) {
                    const term = searchText.toLowerCase();
                    const car = (item.carNumber || (item.vehicles ? item.vehicles.join(' ') : '')).toLowerCase();
                    const name = (item.name || item.companyName || '').toLowerCase();
                    const unit = (item.unitNumber || item.visitUnit || '').toLowerCase();

                    if (searchType === 'all') {
                        if (!car.includes(term) && !name.includes(term) && !unit.includes(term)) return false;
                    } else if (searchType === 'name') {
                        if (!name.includes(term)) return false;
                    } else if (searchType === 'car') {
                        if (!car.includes(term)) return false;
                    } else if (searchType === 'unit') {
                        if (!unit.includes(term)) return false;
                    }
                }
                return true;
            });

            const getDuplicateInfo = (item) => {
                if (activeTab !== 'construction') return { count: 0, history: [] };
                const date = item.startDate;
                let count = 0; let history = [];
                list.forEach(other => {
                    if (other.startDate === date) {
                        const overlap = (item.vehicles||[]).some(v => (other.vehicles||[]).includes(v));
                        if (overlap) { count++; history.push(other); }
                    }
                });
                return { count, history };
            };

            const toggleSelectAll = () => {
                if (filteredList.length === 0) return;
                const allSelected = filteredList.every(item => selectedIds.has(item.id));
                if (allSelected) { setSelectedIds(new Set()); } else { const newSet = new Set(selectedIds); filteredList.forEach(item => newSet.add(item.id)); setSelectedIds(newSet); }
            };
            const toggleSelect = (id) => { const newSet = new Set(selectedIds); if (newSet.has(id)) { newSet.delete(id); } else { newSet.add(id); } setSelectedIds(newSet); };
            const getTargetList = () => selectedIds.size > 0 ? filteredList.filter(item => selectedIds.has(item.id)) : filteredList;

            useEffect(() => { if(!window.XLSX) { const s = document.createElement('script'); s.src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"; document.body.appendChild(s); } }, []);

            const handleDownload = () => {
                if (!window.XLSX) return alert("엑셀 로딩중...");
                const targetList = getTargetList();
                if (targetList.length === 0) return alert("다운로드할 데이터가 없습니다.");
                const ws_data = [];
                if(activeTab==='construction') {
                    ws_data.push(["상태","차량번호","업체명","방문자성명","시작일","시작시간","종료일","종료시간","연락처","메모","호수","1차확인자","최종승인자"]);
                    targetList.forEach(i => i.vehicles.forEach(v => { if(v.trim()) ws_data.push([getStatusLabel(i.status), v, i.companyName, i.visitorName, i.startDate, i.startTime, i.endDate, i.endTime, i.driverPhone, `[${i.visitPurpose}] ${i.location}`, i.visitUnit, i.checkedBy||'-', i.approvedBy||'-']) }));
                } else {
                    ws_data.push(["상태","차량번호","시작일","종료일","사용자명","연락처","부서","호수","메모","1차확인자","최종승인자"]);
                    const today = new Date().toISOString().split('T')[0];
                    targetList.forEach(i => ws_data.push([getStatusLabel(i.status), i.carNumber, today, "2099-12-31", i.name, i.phone, i.department, i.unitNumber, i.applicationType, i.checkedBy||'-', i.approvedBy||'-']));
                }
                const wb = window.XLSX.utils.book_new();
                window.XLSX.utils.book_append_sheet(wb, window.XLSX.utils.aoa_to_sheet(ws_data), "Sheet1");
                window.XLSX.writeFile(wb, `주차관제_${activeTab}_${new Date().toISOString().slice(0,10)}.xlsx`);
            };

            const formatDateTimeForDoc = (value) => {
                if (!value) return '-';
                const d = new Date(value);
                if (Number.isNaN(d.getTime())) return '-';
                return d.toLocaleString('ko-KR', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' });
            };

            const arrayBufferToBase64 = (buffer) => {
                let binary = '';
                const bytes = new Uint8Array(buffer);
                const chunkSize = 0x8000;
                for (let i = 0; i < bytes.length; i += chunkSize) {
                    binary += String.fromCharCode(...bytes.subarray(i, i + chunkSize));
                }
                return btoa(binary);
            };

            const ensurePdfFont = async (pdf) => {
                const fontFile = 'NanumGothic-Regular.ttf';
                const fontName = 'NanumGothic';
                try {
                    if (!pdfFontBase64Ref.current) {
                        let loadedBuffer = null;
                        for (const url of PDF_FONT_URLS) {
                            try {
                                const res = await fetch(url);
                                if (!res.ok) continue;
                                loadedBuffer = await res.arrayBuffer();
                                break;
                            } catch {}
                        }
                        if (!loadedBuffer) throw new Error('font fetch failed');
                        pdfFontBase64Ref.current = arrayBufferToBase64(loadedBuffer);
                    }
                    pdf.addFileToVFS(fontFile, pdfFontBase64Ref.current);
                    pdf.addFont(fontFile, fontName, 'normal');
                    pdf.setFont(fontName, 'normal');
                    return true;
                } catch {
                    return false;
                }
            };

            const addDataImageToPdf = (pdf, dataUrl, x, y, w, h) => {
                if (!dataUrl || typeof dataUrl !== 'string') return false;
                const isPng = dataUrl.startsWith('data:image/png');
                const isJpeg = dataUrl.startsWith('data:image/jpeg') || dataUrl.startsWith('data:image/jpg');
                const format = isPng ? 'PNG' : (isJpeg ? 'JPEG' : null);
                if (!format) return false;
                try {
                    pdf.addImage(dataUrl, format, x, y, w, h, undefined, 'FAST');
                    return true;
                } catch {
                    return false;
                }
            };

            const renderApplicationToPdf = (pdf, item, index = 1, total = 1) => {
                const pageWidth = pdf.internal.pageSize.getWidth();
                const pageHeight = pdf.internal.pageSize.getHeight();
                const marginX = 10;
                const topY = 16;
                const contentBottomY = pageHeight - 16;
                const labelColW = 46;
                const valueColX = marginX + labelColW;
                const valueColW = pageWidth - marginX - valueColX;
                const receptionDesk = item?.receptionDesk || (item?.receptionRole ? getRoleNameById(item.receptionRole) : '');
                const receptionDisplay = item?.receptionType === 'proxy'
                    ? `대리접수 (${receptionDesk || '관리자'})`
                    : '본인접수';
                let y = topY;

                pdf.setFontSize(19);
                pdf.text('주차 신청서', pageWidth / 2, y, { align: 'center' });
                if (total > 1) {
                    pdf.setFontSize(10);
                    pdf.text(`${index}/${total}`, pageWidth - marginX, y, { align: 'right' });
                }
                y += 8.5;
                pdf.setFontSize(10);
                pdf.text(`문서번호: ${item.id || '-'}`, marginX, y);
                pdf.text(`출력일시: ${formatDateTimeForDoc(new Date().toISOString())}`, pageWidth - marginX, y, { align: 'right' });
                y += 7;
                pdf.setDrawColor(220);
                pdf.line(marginX, y, pageWidth - marginX, y);
                y += 5.5;

                const rows = item.type === 'construction'
                    ? [
                        ['구분', '공사/방문차량'],
                        ['상태', getStatusLabel(item.status)],
                        ['신청일시', formatDateTimeForDoc(item.submittedAt)],
                        ['업체명', item.companyName],
                        ['방문자 성명', item.visitorName],
                        ['방문 목적', item.visitPurpose],
                        ['방문 호수', item.visitUnit ? `${item.visitUnit}호` : '-'],
                        ['방문 내용', item.location],
                        ['연락처', item.driverPhone],
                        ['접수구분', receptionDisplay],
                        ...(item.receptionType === 'proxy' ? [['대리 접수자명', item.proxySubmitterName || '-']] : []),
                        ['방문 기간', `${item.startDate || '-'} ${item.startTime || ''} ~ ${item.endDate || '-'} ${item.endTime || ''}`],
                        ['차량번호', (item.vehicles || []).join(', ') || '-'],
                        ['1차 확인자', item.firstCheckedManagerName || item.checkedBy || '-'],
                        ['최종 승인자', item.approvedBy || (item.status === 'approved' ? FINAL_APPROVER_SIGNATURE_TEXT : '-')],
                        ['반려 사유', item.rejectionReason || '-']
                    ]
                    : [
                        ['구분', '정기권'],
                        ['상태', getStatusLabel(item.status)],
                        ['신청일시', formatDateTimeForDoc(item.submittedAt)],
                        ['신청 유형', item.applicationType === 'change' ? '변경' : '신규'],
                        ['신청자 성명', item.name],
                        ['소속', item.department],
                        ['연락처', item.phone],
                        ['접수구분', receptionDisplay],
                        ...(item.receptionType === 'proxy' ? [['대리 접수자명', item.proxySubmitterName || '-']] : []),
                        ['신청 호수', item.unitNumber ? `${item.unitNumber}호` : '-'],
                        ['차량번호', item.carNumber],
                        ['기존 차량번호', item.oldCarNumber || '-'],
                        ['변경 사유', item.changeReason || '-'],
                        ['1차 확인자', item.firstCheckedManagerName || item.checkedBy || '-'],
                        ['최종 승인자', item.approvedBy || (item.status === 'approved' ? FINAL_APPROVER_SIGNATURE_TEXT : '-')],
                        ['반려 사유', item.rejectionReason || '-']
                    ];

                const drawRow = (label, value) => {
                    const text = `${value || '-'}`;
                    const lines = pdf.splitTextToSize(text, valueColW - 4);
                    const height = Math.max(10.5, lines.length * 5 + 3.5);
                    if (y + height > contentBottomY) {
                        pdf.addPage();
                        y = topY;
                    }
                    pdf.setFillColor(248, 250, 252);
                    pdf.rect(marginX, y, labelColW, height, 'F');
                    pdf.setDrawColor(229, 231, 235);
                    pdf.rect(marginX, y, labelColW, height);
                    pdf.rect(valueColX, y, pageWidth - marginX - valueColX, height);
                    pdf.setFontSize(10);
                    pdf.text(label, marginX + 2, y + 6.3);
                    pdf.text(lines, valueColX + 2, y + 6.3);
                    y += height;
                };

                rows.forEach(([label, value]) => drawRow(label, value));
                y += 5;

                const sigBoxH = 40;
                if (y + sigBoxH + 4 > contentBottomY) {
                    pdf.addPage();
                    y = topY;
                }
                const sigGap = 4;
                const sigBoxW = (pageWidth - (marginX * 2) - (sigGap * 2)) / 3;
                const sigX1 = marginX;
                const sigX2 = sigX1 + sigBoxW + sigGap;
                const sigX3 = sigX2 + sigBoxW + sigGap;
                pdf.setDrawColor(229, 231, 235);
                pdf.rect(sigX1, y, sigBoxW, sigBoxH);
                pdf.rect(sigX2, y, sigBoxW, sigBoxH);
                pdf.rect(sigX3, y, sigBoxW, sigBoxH);
                pdf.setFontSize(9.5);
                pdf.text(item.receptionType === 'proxy' ? '대리 접수 서명' : '신청자 서명', sigX1 + 2, y + 6);
                pdf.text('1차 확인 서명', sigX2 + 2, y + 6);
                pdf.text('최종 확인', sigX3 + 2, y + 6);

                const sigImgW = sigBoxW - 4;
                const sigImgH = 20;
                const hasApplicantSignature = addDataImageToPdf(pdf, item.signature, sigX1 + 2, y + 7, sigImgW, sigImgH);
                const hasCheckerSignature = addDataImageToPdf(pdf, item.firstCheckedManagerSignature, sigX2 + 2, y + 7, sigImgW, sigImgH);
                if (!hasApplicantSignature) { pdf.setFontSize(8); pdf.text('서명 없음', sigX1 + 2, y + 19); }
                if (!hasCheckerSignature) { pdf.setFontSize(8); pdf.text('서명 없음', sigX2 + 2, y + 19); }

                const applicantSignedAt = formatDateTimeForDoc(item.submittedAt);
                const firstCheckedAt = formatDateTimeForDoc(item.firstCheckedAt);
                if (applicantSignedAt !== '-') {
                    pdf.setFontSize(6.8);
                    pdf.text(applicantSignedAt, sigX1 + (sigBoxW / 2), y + 35, { align: 'center' });
                }
                if (firstCheckedAt !== '-') {
                    pdf.setFontSize(6.8);
                    pdf.text(firstCheckedAt, sigX2 + (sigBoxW / 2), y + 35, { align: 'center' });
                }

                const finalSignatureText = item.finalApprovalSignatureText || (item.status === 'approved' ? FINAL_APPROVER_SIGNATURE_TEXT : '');
                if (finalSignatureText) {
                    pdf.setFontSize(12);
                    pdf.text(finalSignatureText, sigX3 + (sigBoxW / 2), y + 19, { align: 'center' });
                    const approvedAt = formatDateTimeForDoc(item.approvedAt);
                    if (approvedAt !== '-') {
                        pdf.setFontSize(6.8);
                        pdf.text(approvedAt, sigX3 + (sigBoxW / 2), y + 35, { align: 'center' });
                    }
                } else {
                    pdf.setFontSize(8);
                    pdf.text('미확정', sigX3 + (sigBoxW / 2), y + 22, { align: 'center' });
                }

                if (item.registrationImg || item.idCardImg) {
                    pdf.addPage();
                    let imgY = 16;
                    const imageBoxW = pageWidth - (marginX * 2);
                    const hasBothAttachments = Boolean(item.registrationImg && item.idCardImg);
                    const imageBoxH = hasBothAttachments ? 84 : 170;
                    pdf.setFontSize(15);
                    pdf.text('첨부 서류', marginX, imgY);
                    imgY += 8;
                    if (item.registrationImg) {
                        pdf.setFontSize(10);
                        pdf.text('차량등록증', marginX, imgY);
                        imgY += 3;
                        pdf.setDrawColor(229, 231, 235);
                        pdf.rect(marginX, imgY, imageBoxW, imageBoxH);
                        const ok = addDataImageToPdf(pdf, item.registrationImg, marginX + 1.5, imgY + 1.5, imageBoxW - 3, imageBoxH - 3);
                        if (!ok) { pdf.setFontSize(9); pdf.text('이미지 로드 실패', marginX + 2, imgY + 12); }
                        imgY += imageBoxH + 8;
                    }
                    if (item.idCardImg) {
                        pdf.setFontSize(10);
                        pdf.text('사원증', marginX, imgY);
                        imgY += 3;
                        pdf.setDrawColor(229, 231, 235);
                        pdf.rect(marginX, imgY, imageBoxW, imageBoxH);
                        const ok = addDataImageToPdf(pdf, item.idCardImg, marginX + 1.5, imgY + 1.5, imageBoxW - 3, imageBoxH - 3);
                        if (!ok) { pdf.setFontSize(9); pdf.text('이미지 로드 실패', marginX + 2, imgY + 12); }
                    }
                }
            };

            const buildBundledApplicationsPdf = async (items) => {
                const pdf = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4' });
                const fontReady = await ensurePdfFont(pdf);
                if (!fontReady) throw new Error('PDF_FONT_LOAD_FAILED');
                items.forEach((item, idx) => {
                    if (idx > 0) pdf.addPage();
                    renderApplicationToPdf(pdf, item, idx + 1, items.length);
                });

                const totalPages = pdf.getNumberOfPages();
                for (let page = 1; page <= totalPages; page++) {
                    pdf.setPage(page);
                    const pageWidth = pdf.internal.pageSize.getWidth();
                    const pageHeight = pdf.internal.pageSize.getHeight();
                    const footerLineY = pageHeight - 12;
                    const footerTextY = pageHeight - 8;

                    pdf.setDrawColor(226, 232, 240);
                    pdf.line(14, footerLineY, pageWidth - 14, footerLineY);
                    pdf.setTextColor(100, 116, 139);
                    pdf.setFontSize(7);
                    pdf.text(OFFICIAL_FOOTER_SUBTITLE, 14, footerTextY);
                    pdf.text(`${OFFICIAL_FOOTER_TITLE} · ${page}/${totalPages}`, pageWidth - 14, footerTextY, { align: 'right' });
                    pdf.setTextColor(0, 0, 0);
                }

                return pdf.output('arraybuffer');
            };

            const handlePdfDownload = async () => {
                if (isZipping) return;
                const targetList = getTargetList();
                if (targetList.length === 0) return alert("다운로드할 데이터가 없습니다.");
                setIsZipping(true);
                try {
                    const ymd = new Date().toISOString().slice(0,10);
                    const bundlePdf = await buildBundledApplicationsPdf(targetList);
                    const url = window.URL.createObjectURL(new Blob([bundlePdf], { type: 'application/pdf' }));
                    const a = document.createElement("a"); a.href = url; a.download = `parking_bundle_${activeTab}_${ymd}.pdf`; a.click();
                    window.URL.revokeObjectURL(url);
                } catch (error) {
                    if (error?.message === 'PDF_FONT_LOAD_FAILED') {
                        alert("한글 폰트 로딩에 실패했습니다. 인터넷 연결 상태에서 다시 시도해주세요.");
                    } else {
                        alert("오류 발생");
                    }
                } finally { setIsZipping(false); }
            };

            const handleLocalFolderBackup = async () => {
                if (adminRole !== 'MASTER') return;
                if (isBackingUpLocally) return;
                if (typeof window.showDirectoryPicker !== 'function') {
                    alert('현재 브라우저에서는 폴더 직접 백업을 지원하지 않습니다. (Chromium 계열 권장)');
                    return;
                }

                const allItems = [...(submissions.construction || []), ...(submissions.regular || [])]
                    .sort((a, b) => new Date(a.submittedAt || 0) - new Date(b.submittedAt || 0));
                if (allItems.length === 0) {
                    alert('백업할 데이터가 없습니다.');
                    return;
                }

                setIsBackingUpLocally(true);
                try {
                    const backupTriggeredAt = new Date();
                    const baseDir = await window.showDirectoryPicker({ id: 'parking-master-backup', mode: 'readwrite' });
                    const nowParts = getDateParts(Date.now());
                    const monthDir = await baseDir.getDirectoryHandle(`${nowParts.yyyy}-${nowParts.mm}`, { create: true });
                    const dayDir = await monthDir.getDirectoryHandle(`${nowParts.yyyy}-${nowParts.mm}-${nowParts.dd}`, { create: true });

                    const nextVersions = { ...(backupMeta?.versions || {}) };
                    let createdCount = 0;
                    let skippedCount = 0;
                    let failedCount = 0;

                    for (const item of allItems) {
                        const version = getItemBackupVersion(item);
                        if (item?.id && nextVersions[item.id] === version) {
                            skippedCount += 1;
                            continue;
                        }

                        try {
                            const typeDir = await dayDir.getDirectoryHandle(getBackupTypeFolder(item), { create: true });
                            const statusDir = await typeDir.getDirectoryHandle(getBackupStatusFolder(item), { create: true });
                            const fileName = buildBackupFileName(item);

                            const pdfBuffer = await buildBundledApplicationsPdf([item]);
                            const fileHandle = await statusDir.getFileHandle(fileName, { create: true });
                            const writable = await fileHandle.createWritable();
                            await writable.write(pdfBuffer);
                            await writable.close();
                            if (item?.id) nextVersions[item.id] = version;
                            createdCount += 1;
                        } catch {
                            failedCount += 1;
                        }
                    }

                    const backupTriggeredAtIso = backupTriggeredAt.toISOString();
                    const isOfficialBackupRun = isInOfficialBackupWindow(backupTriggeredAt);
                    const isOfficialBackupAccepted = isOfficialBackupRun && failedCount === 0;
                    const nextMeta = {
                        lastBackupAt: backupTriggeredAtIso,
                        officialBackupAt: isOfficialBackupAccepted ? backupTriggeredAtIso : (backupMeta?.officialBackupAt || null),
                        versions: nextVersions
                    };
                    writeBackupMeta(nextMeta);
                    setBackupMeta(nextMeta);
                    const backupAcceptedText = isOfficialBackupAccepted
                        ? '공식(21:50~22:00, 실패 0건)'
                        : (isOfficialBackupRun ? '임시(공식 시간 내 실패 건 존재)' : '임시(공식 시간 외)');
                    alert(`개별 백업 완료\n- 신규 저장: ${createdCount}건\n- 중복 건너뜀: ${skippedCount}건\n- 실패: ${failedCount}건\n- 백업 인정: ${backupAcceptedText}`);
                } catch (error) {
                    if (error?.name === 'AbortError') {
                        alert('백업 폴더 선택이 취소되었습니다.');
                    } else {
                        alert('개별 백업 중 오류가 발생했습니다.');
                    }
                } finally {
                    setIsBackingUpLocally(false);
                }
            };

            const handleDeleteSelected = () => {
                if (adminRole !== 'MASTER') return;
                if (selectedIds.size === 0) { alert("삭제할 항목을 선택해주세요."); return; }
                const ok = window.confirm(`정말 지우시겠습니까?\n선택된 ${selectedIds.size}건이 삭제됩니다.`);
                if (!ok) return;
                onDeleteSubmissions(Array.from(selectedIds));
                setSelectedIds(new Set());
                setExpandedId(null);
            };

            const closeFirstCheckModal = () => {
                setCheckingItem(null);
                setFirstCheckerName('');
                setFirstCheckerSignature(null);
            };

            const handleFirstCheckConfirm = () => {
                if (!checkingItem) return;
                if (!firstCheckerName.trim()) { alert('담당자 이름을 입력해주세요.'); return; }
                if (!firstCheckerSignature) { alert('담당자 서명을 등록해주세요.'); return; }
                onUpdateStatus(checkingItem.id, 'checked', null, {
                    managerName: firstCheckerName.trim(),
                    managerRole: adminRole,
                    managerSignature: firstCheckerSignature
                });
                closeFirstCheckModal();
            };

            const InfoRow = ({ label, value, highlight }) => (
                <div className="flex justify-between items-center py-2 border-b border-slate-100 last:border-0 hover:bg-slate-50 px-2 rounded">
                    <span className="text-slate-500 text-xs w-20 font-medium">{label}</span>
                    <span className={`text-sm font-bold text-right flex-1 break-keep ${highlight ? 'text-indigo-600' : 'text-slate-700'}`}>{value || '-'}</span>
                </div>
            );
            const getReceptionDisplay = (item) => {
                const desk = item?.receptionDesk || (item?.receptionRole ? getRoleNameById(item.receptionRole) : '');
                if (item?.receptionType === 'proxy') return desk ? `대리접수 (${desk})` : '대리접수';
                if (item?.receptionType === 'self') return '본인접수';
                return desk ? `대리접수 (${desk})` : '본인접수';
            };

            const renderActionButtons = (item) => {
                if (item.status === 'approved' || item.status === 'rejected') return null;
                const isMaster = adminRole === 'MASTER';
                const isSafety = adminRole === 'SAFETY';
                const isCenter = adminRole === 'CENTER';
                const isFirstCheckRole = isSafety || isCenter;
                const canFirstCheck = item.status === 'pending' && (
                    (isSafety && item.type === 'construction') ||
                    (isCenter && (item.type === 'regular' || (item.type === 'construction' && item.visitPurpose === '기타')))
                );

                if (isFirstCheckRole && item.status !== 'pending') return null;

                if (rejectingId === item.id) {
                    return (
                        <div className="mt-3 animate-fade-in bg-white p-3 rounded-xl border border-rose-200 shadow-sm">
                            <input className="w-full border border-slate-300 rounded-lg p-2.5 text-sm mb-2" placeholder="반려 사유 입력" value={rejectReason} onChange={e=>setRejectReason(e.target.value)} autoFocus/>
                            <div className="flex gap-2">
                                <button onClick={()=>setRejectingId(null)} className="flex-1 py-2.5 rounded-lg border border-slate-300 text-slate-600 font-bold text-sm">취소</button>
                                <button onClick={()=> { onUpdateStatus(item.id, 'rejected', rejectReason); setRejectingId(null); }} className="flex-1 py-2.5 rounded-lg bg-rose-500 text-white font-bold text-sm shadow-md">확인</button>
                            </div>
                        </div>
                    );
                }

                return (
                    <div className="flex gap-2 mt-3">
                        <button onClick={()=>{setRejectingId(item.id); setRejectReason("")}} className="flex-1 border border-rose-200 text-rose-600 bg-white hover:bg-rose-50 text-sm py-3 rounded-xl font-bold transition">반려</button>
                        {canFirstCheck && (
                            <button onClick={()=>{ setCheckingItem(item); setFirstCheckerName(''); setFirstCheckerSignature(null); }} className="flex-1 bg-indigo-500 hover:bg-indigo-600 text-white text-sm py-3 rounded-xl font-bold shadow-lg shadow-indigo-100 transition">1차 확인</button>
                        )}
                        {isMaster && (
                            item.status === 'checked' ? (
                                <button onClick={()=>onUpdateStatus(item.id, 'approved')} className="flex-1 bg-emerald-600 hover:bg-emerald-700 text-white text-sm py-3 rounded-xl font-bold shadow-lg shadow-emerald-200 transition animate-pulse">최종 승인</button>
                            ) : (
                                <button onClick={()=>onUpdateStatus(item.id, 'approved')} className="flex-1 bg-slate-600 hover:bg-slate-700 text-white text-sm py-3 rounded-xl font-bold transition">직권 승인</button>
                            )
                        )}
                    </div>
                );
            };

            const isAllSelected = filteredList.length > 0 && filteredList.every(item => selectedIds.has(item.id));
            const selectedCount = selectedIds.size;

            return (
                <div className="flex flex-col h-full bg-slate-50">
                    <HistoryModal isOpen={historyOpen} onClose={()=>setHistoryOpen(false)} historyList={historyList} targetCar={targetCar} />
                    <ImageModal src={viewImage} title={viewImageTitle} onClose={()=>{setViewImage(null); setViewImageTitle('');}} />
                    <FirstCheckApproveModal
                        isOpen={!!checkingItem}
                        roleName={getRoleNameById(adminRole)}
                        managerName={firstCheckerName}
                        onManagerNameChange={setFirstCheckerName}
                        signature={firstCheckerSignature}
                        onSignatureChange={setFirstCheckerSignature}
                        onClose={closeFirstCheckModal}
                        onConfirm={handleFirstCheckConfirm}
                    />
                    
                    <div className="bg-white p-5 pb-2 shadow-sm z-10">
                        <div className="flex justify-between mb-4 items-center gap-2">
                            <div className="flex items-center gap-3 min-w-0">
                                <button onClick={onBack} className="p-2 -ml-2 rounded-full hover:bg-slate-100 transition"><ArrowLeft size={20} className="text-slate-600"/></button>
                                <div className="flex items-center gap-2 min-w-0">
                                    <h2 className="font-bold text-lg sm:text-xl text-slate-800 whitespace-nowrap">관리자 대시보드</h2>
                                    <span className="text-[11px] sm:text-xs text-slate-500 whitespace-nowrap truncate">{ROLES[Object.keys(ROLES).find(k => ROLES[k].id === adminRole)]?.name || '관리자'} 모드</span>
                                </div>
                            </div>
                            <span className="text-xs font-bold bg-indigo-50 text-indigo-600 px-3 py-1.5 rounded-full border border-indigo-100 shrink-0">Total: {filteredList.length}</span>
                        </div>
                        
                        <div className="grid grid-cols-3 gap-2 mb-3">
                            <select value={filterYear} onChange={e=>setFilterYear(Number(e.target.value))} className="w-full p-2.5 bg-slate-50 border border-slate-200 rounded-lg text-sm font-medium focus:outline-none">{yearOptions.map(y=><option key={y} value={y}>{y}년</option>)}</select>
                            <select value={filterMonth} onChange={e=>setFilterMonth(e.target.value)} className="w-full p-2.5 bg-slate-50 border border-slate-200 rounded-lg text-sm font-medium focus:outline-none">{[...Array(12)].map((_,i)=><option key={i+1} value={i+1}>{i+1}월</option>)}</select>
                            <select value={filterDay} onChange={e=>setFilterDay(e.target.value)} className="w-full p-2.5 bg-slate-50 border border-slate-200 rounded-lg text-sm font-medium focus:outline-none"><option value="all">전체 일</option>{[...Array(31)].map((_,i)=><option key={i+1} value={i+1}>{i+1}일</option>)}</select>
                        </div>

                        <div className="flex gap-2 mb-3">
                            <select value={searchType} onChange={e=>setSearchType(e.target.value)} className="w-1/3 p-2.5 bg-slate-50 border border-slate-200 rounded-xl text-sm font-medium focus:outline-none"><option value="all">전체 검색</option><option value="name">성명/업체</option><option value="car">차량번호</option><option value="unit">호수</option></select>
                            <div className="relative flex-1"><Search className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400" size={18}/><input className="w-full pl-10 pr-4 py-3 bg-white border border-slate-200 rounded-xl text-sm font-medium focus:outline-none" placeholder="검색어 입력" value={searchText} onChange={e=>setSearchText(e.target.value)}/></div>
                        </div>

                        <div className="mb-3">
                            {adminRole === 'MASTER' && filterStatus === 'checked' ? (
                                <div className="flex items-center justify-between bg-indigo-50 border border-indigo-100 p-2.5 rounded-lg mb-1 animate-pulse-border border-2">
                                    <span className="text-xs font-bold text-indigo-700 flex items-center gap-1"><BadgeCheck size={14}/> 1차 확인되어 넘어온 건만 조회 중</span>
                                    <button onClick={()=>setFilterStatus('all')} className="text-xs bg-white border border-indigo-200 px-2 py-1 rounded shadow-sm text-indigo-600 font-bold">전체 보기</button>
                                </div>
                            ) : (
                                <select value={filterStatus} onChange={e=>setFilterStatus(e.target.value)} className="w-full p-2.5 bg-slate-50 border border-slate-200 rounded-lg text-sm font-medium focus:outline-none">
                                    <option value="all">모든 상태 보기</option>
                                    <option value="pending">1차대기 (미확인)</option>
                                    <option value="checked">2차대기 (1차확인됨)</option>
                                    <option value="approved">최종 승인됨</option>
                                    <option value="rejected">반려됨</option>
                                </select>
                            )}
                        </div>
                        
                        <div className="flex p-1 bg-slate-100 rounded-xl mb-3">
                            {(adminRole === 'MASTER' || adminRole === 'SAFETY' || adminRole === 'CENTER') && (
                                <button onClick={()=>setActiveTab('construction')} className={`flex-1 py-2.5 text-sm rounded-lg font-bold transition-all ${activeTab==='construction'?'bg-white text-indigo-600 shadow-sm ring-1 ring-black/5':'text-slate-500 hover:text-slate-700'}`}>공사/방문</button>
                            )}
                            {(adminRole === 'MASTER' || adminRole === 'CENTER') && (
                                <button onClick={()=>setActiveTab('regular')} className={`flex-1 py-2.5 text-sm rounded-lg font-bold transition-all ${activeTab==='regular'?'bg-white text-emerald-600 shadow-sm ring-1 ring-black/5':'text-slate-500 hover:text-slate-700'}`}>정기권</button>
                            )}
                        </div>

                        <div className="flex gap-2 pb-2">
                            <button onClick={handleDownload} className="flex-1 bg-slate-800 hover:bg-slate-900 text-white py-3 rounded-xl text-sm font-bold flex items-center justify-center gap-2 shadow-lg transition active:scale-95"><Download size={16}/><span>{selectedCount>0?`${selectedCount}건 엑셀`:'전체 엑셀'}</span></button>
                            <button onClick={handlePdfDownload} disabled={isZipping} className="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white py-3 rounded-xl text-sm font-bold flex items-center justify-center gap-2 shadow-lg transition active:scale-95">{isZipping?<RotateCw className="animate-spin" size={16}/>:<Download size={16}/>}<span>{isZipping?'PDF 생성중':(selectedCount>0?`${selectedCount}건 PDF`:'전체 PDF')}</span></button>
                            {adminRole === 'MASTER' && (
                                <button
                                    onClick={handleDeleteSelected}
                                    disabled={selectedCount === 0}
                                    title={selectedCount === 0 ? '삭제할 항목을 선택하세요' : '선택 항목 삭제'}
                                    className={`px-3 py-3 rounded-xl text-sm font-bold flex items-center justify-center shadow-lg transition active:scale-95 ${selectedCount === 0 ? 'bg-slate-200 text-slate-400 cursor-not-allowed' : 'bg-rose-500 hover:bg-rose-600 text-white shadow-rose-200'}`}
                                >
                                    <Trash2 size={18}/>
                                </button>
                            )}
                        </div>
                        {adminRole === 'MASTER' && (
                            <div className="pb-3">
                                <button
                                    onClick={handleLocalFolderBackup}
                                    disabled={isBackingUpLocally}
                                    className="w-full bg-emerald-600 hover:bg-emerald-700 disabled:bg-emerald-300 text-white py-3 rounded-xl text-sm font-bold flex items-center justify-center gap-2 shadow-lg transition active:scale-95"
                                >
                                    {isBackingUpLocally ? <RotateCw className="animate-spin" size={16}/> : <Download size={16}/>}
                                    <span>{isBackingUpLocally ? '개별 백업 진행중' : '주차관제실 개별 백업 (폴더 저장)'}</span>
                                </button>
                                <div className={`mt-1 px-1 text-[11px] font-medium ${backupStatusClass}`}>
                                    {backupStatusText}
                                </div>
                                <div className="mt-0.5 px-1 text-[10px] text-slate-400">
                                    {recentBackupText}
                                </div>
                            </div>
                        )}
                    </div>

                    <div className="flex-1 overflow-y-auto p-5 space-y-4 bg-slate-50">
                        {filteredList.length === 0 && <div className="text-center py-10 text-slate-400 text-sm">{filterStatus==='checked'?'1차 확인된 건이 없습니다.':'표시할 내역이 없습니다.'}</div>}
                        {filteredList.length > 0 && (
                            <div className="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                                <div className="flex items-center p-3 bg-slate-100 border-b border-slate-200 text-xs font-bold text-slate-500">
                                    <div className="w-10 flex justify-center items-center"><input type="checkbox" checked={isAllSelected} onChange={toggleSelectAll} className="custom-checkbox cursor-pointer"/></div>
                                    <div className="w-14 text-center">상태</div>
                                    <div className="flex-1 px-2">내용</div>
                                    <div className="w-20 text-right pr-2">날짜</div>
                                    <div className="w-6"></div>
                                </div>
                                {filteredList.map(item => {
                                    const {count, history} = getDuplicateInfo(item);
                                    const isDuplicate = count >= 2;
                                    const isExpanded = expandedId === item.id;
                                    const isSelected = selectedIds.has(item.id);
                                    const isWaitingApproval = adminRole === 'MASTER' && item.status === 'checked';
                                    const finalApprovalSignature = item.finalApprovalSignatureText || item.approvedBy || (item.status === 'approved' ? FINAL_APPROVER_SIGNATURE_TEXT : null);
                                    const submitSignatureLabel = item.receptionType === 'proxy' ? '대리 접수 서명' : '신청자 서명';
                                    const activityLogs = (Array.isArray(item.activityLogs) ? item.activityLogs : [])
                                        .slice()
                                        .sort((a, b) => new Date(b.at || 0) - new Date(a.at || 0));

                                    return (
                                        <div key={item.id} className={`border-b border-slate-100 last:border-0 bg-white ${isSelected ? 'bg-indigo-50/20' : ''} ${isWaitingApproval ? 'border-2 border-indigo-500 z-10 relative' : ''}`}>
                                            <div onClick={() => setExpandedId(isExpanded ? null : item.id)} className={`flex items-center p-4 cursor-pointer hover:bg-slate-50 transition-colors ${isExpanded ? 'bg-indigo-50/30' : ''}`}>
                                                <div className="w-10 flex justify-center shrink-0" onClick={(e) => e.stopPropagation()}><input type="checkbox" checked={isSelected} onChange={() => toggleSelect(item.id)} className="custom-checkbox cursor-pointer"/></div>
                                                <div className="w-14 flex justify-center shrink-0"><span className={`px-2 py-1 rounded text-[10px] font-bold ${getStatusColor(item.status)}`}>{getStatusLabel(item.status)}</span></div>
                                                <div className="flex-1 px-2 min-w-0 flex flex-col justify-center">
                                                    <div className="flex items-center gap-1.5">
                                                        <span className="font-bold text-slate-800 text-sm truncate">{activeTab==='construction'? item.companyName : item.name}</span>
                                                        {isDuplicate && <AlertCircle size={14} className="text-rose-500 shrink-0"/>}
                                                        {isWaitingApproval && <span className="bg-red-500 text-white text-[10px] px-1.5 rounded-full animate-bounce">승인대기</span>}
                                                    </div>
                                                    <span className="text-xs text-slate-500 truncate mt-0.5 font-medium">{activeTab==='construction'? (item.vehicles[0] || '차량없음') + (item.vehicles.length>1?` 외 ${item.vehicles.length-1}`:'') : item.carNumber}</span>
                                                </div>
                                                <div className="w-20 text-right text-[10px] text-slate-400 leading-tight shrink-0">{new Date(item.submittedAt).toLocaleDateString().slice(5)}<br/>{new Date(item.submittedAt).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</div>
                                                <div className="w-6 flex justify-end text-slate-400 shrink-0"><ChevronRight size={16} className={`transition-transform duration-300 ${isExpanded ? 'rotate-90 text-indigo-500' : ''}`}/></div>
                                            </div>
                                            <div className={`overflow-hidden transition-all duration-300 bg-slate-50 border-t border-slate-100 ${isExpanded ? 'max-h-[1000px] opacity-100' : 'max-h-0 opacity-0'}`}>
                                                <div className="p-4 space-y-4">
                                                    {isDuplicate && <button onClick={()=> { setTargetCar(item.vehicles[0]); setHistoryList(history); setHistoryOpen(true); }} className="w-full bg-rose-50 hover:bg-rose-100 text-rose-600 border border-rose-200 text-xs py-2.5 rounded-lg flex items-center justify-center font-bold transition"><AlertCircle size={14} className="mr-1.5"/> 금일 {count}회 중복 신청 (이력보기)</button>}
                                                    <div className="bg-white p-2 rounded-xl border border-slate-200 shadow-sm">
                                                        {activeTab==='construction' ? (
                                                            <>
                                                                <InfoRow label="방문목적" value={item.visitPurpose} />
                                                                <InfoRow label="방문호수" value={`${item.visitUnit}호`} />
                                                                <InfoRow label="방문내용" value={item.location} />
                                                                <InfoRow label="연락처" value={item.driverPhone} />
                                                                <InfoRow label="접수구분" value={getReceptionDisplay(item)} />
                                                                {item.receptionType === 'proxy' && <InfoRow label="대리접수자" value={item.proxySubmitterName} />}
                                                                {item.firstCheckedManagerRole && <InfoRow label="확인부서" value={getRoleNameById(item.firstCheckedManagerRole)} />}
                                                                {item.firstCheckedManagerName && <InfoRow label="담당자명" value={item.firstCheckedManagerName} />}
                                                                <InfoRow label="방문기간" value={`${item.startDate} ${item.startTime} ~ ${item.endDate} ${item.endTime}`} />
                                                                <InfoRow label="차량번호" value={item.vehicles.join(', ')} highlight />
                                                            </>
                                                        ) : (
                                                            <>
                                                                <InfoRow label="신청구분" value={`${item.applicationType} ${item.applicationType==='change' ? `(기존: ${item.oldCarNumber})` : ''}`} />
                                                                {item.applicationType === 'change' && <InfoRow label="변경사유" value={item.changeReason} highlight />}
                                                                <InfoRow label="신청호수" value={`${item.unitNumber}호`} />
                                                                <InfoRow label="소속" value={item.department} />
                                                                <InfoRow label="연락처" value={item.phone} />
                                                                <InfoRow label="접수구분" value={getReceptionDisplay(item)} />
                                                                {item.receptionType === 'proxy' && <InfoRow label="대리접수자" value={item.proxySubmitterName} />}
                                                                {item.firstCheckedManagerRole && <InfoRow label="확인부서" value={getRoleNameById(item.firstCheckedManagerRole)} />}
                                                                {item.firstCheckedManagerName && <InfoRow label="담당자명" value={item.firstCheckedManagerName} />}
                                                                <InfoRow label="차량번호" value={item.carNumber} highlight />
                                                                {(item.registrationImg || item.idCardImg) && (
                                                                    <div className="mt-2 pt-2 border-t border-slate-100 px-2">
                                                                        <span className="text-xs text-slate-400 block mb-2 font-bold">첨부 서류 (클릭하여 확대)</span>
                                                                        <div className="flex gap-3 pb-1">
                                                                            {item.registrationImg && <div className="flex flex-col gap-1 shrink-0 group cursor-pointer" onClick={() => {setViewImage(item.registrationImg); setViewImageTitle('차량등록증');}}><img src={item.registrationImg} className="h-16 w-24 rounded-lg border border-slate-200 object-cover"/><span className="text-[10px] text-slate-500 text-center">차량등록증</span></div>}
                                                                            {item.idCardImg && <div className="flex flex-col gap-1 shrink-0 group cursor-pointer" onClick={() => {setViewImage(item.idCardImg); setViewImageTitle('사원증');}}><img src={item.idCardImg} className="h-16 w-24 rounded-lg border border-slate-200 object-cover"/><span className="text-[10px] text-slate-500 text-center">사원증</span></div>}
                                                                        </div>
                                                                    </div>
                                                                )}
                                                            </>
                                                        )}
                                                        {item.signature && (
                                                            <div className="mt-2 pt-2 border-t border-slate-100 px-2">
                                                                <span className="text-xs text-slate-400 block mb-2 font-bold">{submitSignatureLabel}</span>
                                                                <div className="h-20 bg-slate-50 rounded-lg border border-slate-200 flex flex-col items-center justify-center p-2 cursor-pointer" onClick={() => {setViewImage(item.signature); setViewImageTitle(submitSignatureLabel);}}>
                                                                    <img src={item.signature} className={`max-w-full ${item.submittedAt ? 'max-h-10 mb-1' : 'max-h-full'}`}/>
                                                                    {item.submittedAt && <span className="text-[11px] text-slate-400">{formatDateTimeForDoc(item.submittedAt)}</span>}
                                                                </div>
                                                            </div>
                                                        )}
                                                        {item.firstCheckedManagerSignature && (
                                                            <div className="mt-2 pt-2 border-t border-slate-100 px-2">
                                                                <span className="text-xs text-slate-400 block mb-2 font-bold">1차 확인 담당자 서명</span>
                                                                <div className="h-20 bg-slate-50 rounded-lg border border-slate-200 flex flex-col items-center justify-center p-2 cursor-pointer" onClick={() => {setViewImage(item.firstCheckedManagerSignature); setViewImageTitle('1차 확인 담당자 서명');}}>
                                                                    <img src={item.firstCheckedManagerSignature} className={`max-w-full ${item.firstCheckedAt ? 'max-h-10 mb-1' : 'max-h-full'}`}/>
                                                                    {item.firstCheckedAt && <span className="text-[11px] text-slate-400">{formatDateTimeForDoc(item.firstCheckedAt)}</span>}
                                                                </div>
                                                            </div>
                                                        )}
                                                        {finalApprovalSignature && (
                                                            <div className="mt-2 pt-2 border-t border-slate-100 px-2">
                                                                <span className="text-xs text-slate-400 block mb-2 font-bold">최종확정 서명</span>
                                                                <div className="h-20 bg-slate-50 rounded-lg border border-slate-200 flex flex-col items-center justify-center p-2">
                                                                    <span className="text-base font-extrabold text-emerald-700">{finalApprovalSignature}</span>
                                                                    {item.approvedAt && <span className="text-[11px] text-slate-400 mt-1">{formatDateTimeForDoc(item.approvedAt)}</span>}
                                                                </div>
                                                            </div>
                                                        )}
                                                        <div className="mt-2 pt-2 border-t border-slate-100 px-2 flex justify-end gap-2 text-[10px] text-slate-400">
                                                            {item.checkedBy && <span className="flex items-center gap-1 text-indigo-500"><BadgeCheck size={10}/> {item.checkedBy} 확인</span>}
                                                            {item.approvedBy && <span className="flex items-center gap-1 text-emerald-500"><CheckCircle size={10}/> {item.approvedBy} 승인</span>}
                                                        </div>
                                                        {item.status==='rejected' && <div className="mt-2 text-xs text-rose-600 bg-rose-50 p-2 rounded border border-rose-100 font-bold">반려 사유: {item.rejectionReason} ({item.rejectedBy})</div>}
                                                        {activityLogs.length > 0 && (
                                                            <div className="mt-2 pt-2 border-t border-slate-100 px-2">
                                                                <span className="text-xs text-slate-500 block mb-2 font-bold">처리 이력</span>
                                                                <div className="space-y-1.5 max-h-40 overflow-y-auto pr-1">
                                                                    {activityLogs.map((log, idx) => (
                                                                        <div key={log.id || `${item.id}-log-${idx}`} className="bg-slate-50 border border-slate-200 rounded-lg px-2 py-1.5">
                                                                            <div className="flex justify-between items-start gap-2">
                                                                                <span className="text-[11px] font-bold text-slate-700">{log.action || '기록'}</span>
                                                                                <span className="text-[10px] text-slate-400 shrink-0">{formatDateTimeForDoc(log.at)}</span>
                                                                            </div>
                                                                            <div className="text-[11px] text-slate-600 break-keep">{log.detail || '-'}</div>
                                                                            <div className="text-[10px] text-slate-400 mt-0.5">담당: {log.actor || '-'}</div>
                                                                        </div>
                                                                    ))}
                                                                </div>
                                                            </div>
                                                        )}
                                                    </div>
                                                    {renderActionButtons(item)}
                                                </div>
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                        )}
                    </div>
                </div>
            )
        }

        function AdminLoginModal({ isOpen, onClose, onLogin }) {
            const [password, setPassword] = useState('');
            const [selectedRoleId, setSelectedRoleId] = useState(null);
            const [error, setError] = useState('');

            useEffect(() => {
                if (isOpen) return;
                setPassword('');
                setSelectedRoleId(null);
                setError('');
            }, [isOpen]);

            if (!isOpen) return null;

            const selectedRole = ROLE_LOGIN_OPTIONS.find((role) => role.id === selectedRoleId) || null;

            const handleSubmit = (e) => {
                e.preventDefault();
                if (!selectedRole) {
                    setError('부서를 먼저 선택해주세요.');
                    return;
                }
                if (password === selectedRole.password) {
                    onLogin(selectedRole.id);
                    return;
                }
                setError('비밀번호를 확인해주세요.');
                setPassword('');
            };

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-md p-4 animate-fade-in">
                    <div className="bg-white w-full max-w-sm rounded-3xl shadow-2xl p-6 relative">
                        <button onClick={onClose} className="absolute top-4 right-4 text-slate-400 hover:text-slate-600"><X size={24}/></button>
                        <div className="flex flex-col items-center mb-5">
                            <div className="w-12 h-12 bg-indigo-50 rounded-full flex items-center justify-center mb-3">
                                <UserCheck size={24} className="text-indigo-600"/>
                            </div>
                            <h3 className="font-bold text-xl text-slate-800">로그인</h3>
                            <p className="text-xs text-slate-500 mt-1">부서를 선택한 뒤 비밀번호를 입력하세요.</p>
                        </div>

                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div>
                                <label className="block text-xs font-bold text-slate-500 mb-2 ml-1">부서 선택</label>
                                <div className="space-y-2">
                                    {ROLE_LOGIN_OPTIONS.map((role) => {
                                        const isSelected = selectedRoleId === role.id;
                                        return (
                                            <button
                                                key={role.id}
                                                type="button"
                                                onClick={() => {
                                                    setSelectedRoleId(role.id);
                                                    setPassword('');
                                                    setError('');
                                                }}
                                                className={`w-full px-4 py-3 rounded-xl border-2 text-left transition-all ${isSelected ? 'border-indigo-500 bg-indigo-50 text-indigo-700' : 'border-slate-200 bg-white text-slate-700 hover:border-slate-300'}`}
                                            >
                                                <span className="block text-sm font-bold">{role.name}</span>
                                            </button>
                                        );
                                    })}
                                </div>
                            </div>

                            <div>
                                <label className="block text-xs font-bold text-slate-500 mb-1.5 ml-1">비밀번호</label>
                                <input
                                    type="password"
                                    className={`w-full p-4 border-2 rounded-xl text-center text-xl tracking-widest outline-none transition-colors ${error ? 'border-rose-400 bg-rose-50' : 'border-slate-200 focus:border-indigo-500'} ${!selectedRole ? 'bg-slate-100 text-slate-400 cursor-not-allowed' : ''}`}
                                    placeholder={selectedRole ? `${selectedRole.name} 비밀번호` : '부서를 먼저 선택하세요'}
                                    value={password}
                                    onChange={(e) => {
                                        setPassword(e.target.value);
                                        setError('');
                                    }}
                                    autoFocus
                                    maxLength={4}
                                    inputMode="numeric"
                                    disabled={!selectedRole}
                                />
                                {error && <p className="text-xs text-rose-500 text-center mt-2 font-bold">{error}</p>}
                            </div>

                            <button
                                type="submit"
                                disabled={!selectedRole || !password}
                                className="w-full bg-indigo-600 hover:bg-indigo-700 disabled:bg-slate-300 disabled:cursor-not-allowed text-white py-4 rounded-xl font-bold shadow-lg transition active:scale-95"
                            >
                                로그인
                            </button>
                        </form>
                    </div>
                </div>
            );
        }

        function HomeScreen({ onNavigate, adminRole, onOpenAdmin }) {
            const isRegularBlocked = isRegularAccessBlockedForRole(adminRole);
            return (
                <div className="p-6 md:p-8 flex flex-col items-center justify-center h-full animate-fade-in bg-[radial-gradient(circle_at_top,_#eef2ff,_#f8fafc_42%,_#f1f5f9)]">
                    <div className="w-full flex flex-col gap-4">
                        <div className="text-center mb-5">
                            <div className="w-full max-w-[520px] aspect-[16/7] rounded-3xl mx-auto mb-4 shadow-xl border-2 border-slate-300 overflow-hidden relative bg-slate-200">
                                <svg viewBox="0 0 640 280" preserveAspectRatio="xMidYMid slice" className="absolute inset-0 w-full h-full block" aria-hidden="true">
                                    <defs>
                                        <linearGradient id="mallSkyHero" x1="0" y1="0" x2="0" y2="1">
                                            <stop offset="0%" stopColor="#5b7fd4" />
                                            <stop offset="58%" stopColor="#7f93d5" />
                                            <stop offset="100%" stopColor="#d7b6cf" />
                                        </linearGradient>
                                    </defs>

                                    <rect x="0" y="0" width="640" height="280" fill="url(#mallSkyHero)" />

                                    <g fill="#e9edf8" fillOpacity="0.9" stroke="#7181b9" strokeWidth="2">
                                        <ellipse cx="124" cy="56" rx="86" ry="24" />
                                        <ellipse cx="260" cy="46" rx="64" ry="19" />
                                        <ellipse cx="520" cy="62" rx="90" ry="25" />
                                    </g>

                                    <path d="M0 190 C72 170, 126 186, 180 178 C238 168, 302 188, 362 178 C436 165, 520 192, 640 174 L640 206 L0 206 Z" fill="#5a6f87" fillOpacity="0.6" />
                                    <rect x="0" y="206" width="640" height="74" fill="#374151" />

                                    <g stroke="#1f2937" strokeWidth="3">
                                        <rect x="120" y="106" width="360" height="124" fill="#d5dce8" />
                                        <rect x="120" y="152" width="360" height="78" fill="#2f4362" />
                                        <line x1="138" y1="152" x2="138" y2="230" stroke="#94a3b8" />
                                        <line x1="156" y1="152" x2="156" y2="230" stroke="#94a3b8" />
                                        <line x1="174" y1="152" x2="174" y2="230" stroke="#94a3b8" />
                                        <line x1="192" y1="152" x2="192" y2="230" stroke="#94a3b8" />
                                        <line x1="210" y1="152" x2="210" y2="230" stroke="#94a3b8" />
                                        <line x1="228" y1="152" x2="228" y2="230" stroke="#94a3b8" />
                                        <line x1="246" y1="152" x2="246" y2="230" stroke="#94a3b8" />
                                        <line x1="264" y1="152" x2="264" y2="230" stroke="#94a3b8" />
                                        <line x1="282" y1="152" x2="282" y2="230" stroke="#94a3b8" />
                                        <line x1="300" y1="152" x2="300" y2="230" stroke="#94a3b8" />
                                        <line x1="318" y1="152" x2="318" y2="230" stroke="#94a3b8" />
                                        <line x1="336" y1="152" x2="336" y2="230" stroke="#94a3b8" />
                                        <line x1="354" y1="152" x2="354" y2="230" stroke="#94a3b8" />
                                        <line x1="372" y1="152" x2="372" y2="230" stroke="#94a3b8" />
                                        <line x1="390" y1="152" x2="390" y2="230" stroke="#94a3b8" />
                                        <line x1="408" y1="152" x2="408" y2="230" stroke="#94a3b8" />
                                        <line x1="426" y1="152" x2="426" y2="230" stroke="#94a3b8" />
                                        <line x1="444" y1="152" x2="444" y2="230" stroke="#94a3b8" />
                                    </g>

                                    <g stroke="#1f2937" strokeWidth="3">
                                        <polygon points="438,52 592,38 592,230 438,230" fill="#cbd5e1" />
                                        <rect x="455" y="58" width="122" height="148" fill="#8f9bb0" />
                                        <line x1="455" y1="82" x2="577" y2="82" stroke="#334155" />
                                        <line x1="455" y1="106" x2="577" y2="106" stroke="#334155" />
                                        <line x1="455" y1="130" x2="577" y2="130" stroke="#334155" />
                                        <line x1="455" y1="154" x2="577" y2="154" stroke="#334155" />
                                        <line x1="455" y1="178" x2="577" y2="178" stroke="#334155" />
                                        <line x1="475" y1="58" x2="475" y2="206" stroke="#334155" />
                                        <line x1="495" y1="58" x2="495" y2="206" stroke="#334155" />
                                        <line x1="515" y1="58" x2="515" y2="206" stroke="#334155" />
                                        <line x1="535" y1="58" x2="535" y2="206" stroke="#334155" />
                                        <line x1="555" y1="58" x2="555" y2="206" stroke="#334155" />
                                    </g>

                                    <g stroke="#111827" strokeWidth="3">
                                        <rect x="236" y="122" width="128" height="28" rx="8" fill="#f8fafc" />
                                        <polygon points="298,126 324,146 272,146" fill="#dbeafe" />
                                        <line x1="270" y1="138" x2="326" y2="138" stroke="#1e3a8a" strokeWidth="2" />
                                    </g>

                                    <g>
                                        <rect x="74" y="234" width="492" height="20" rx="9" fill="#1f2937" />
                                        <line x1="100" y1="244" x2="152" y2="244" stroke="#f8fafc" strokeWidth="4" strokeLinecap="round" />
                                        <line x1="188" y1="244" x2="240" y2="244" stroke="#f8fafc" strokeWidth="4" strokeLinecap="round" />
                                        <line x1="276" y1="244" x2="328" y2="244" stroke="#f8fafc" strokeWidth="4" strokeLinecap="round" />
                                        <line x1="364" y1="244" x2="416" y2="244" stroke="#f8fafc" strokeWidth="4" strokeLinecap="round" />
                                        <line x1="452" y1="244" x2="504" y2="244" stroke="#f8fafc" strokeWidth="4" strokeLinecap="round" />
                                    </g>

                                    <g transform="translate(186 236)" stroke="#1f2937" strokeWidth="3">
                                        <rect x="-34" y="-16" width="68" height="18" rx="9" fill="#60a5fa" />
                                        <rect x="-20" y="-28" width="40" height="12" rx="6" fill="#bfdbfe" />
                                        <circle cx="-18" cy="4" r="7" fill="#111827" />
                                        <circle cx="18" cy="4" r="7" fill="#111827" />
                                    </g>

                                    <g transform="translate(394 236)" stroke="#1f2937" strokeWidth="3">
                                        <rect x="-34" y="-16" width="68" height="18" rx="9" fill="#fb7185" />
                                        <rect x="-20" y="-28" width="40" height="12" rx="6" fill="#fecdd3" />
                                        <circle cx="-18" cy="4" r="7" fill="#111827" />
                                        <circle cx="18" cy="4" r="7" fill="#111827" />
                                    </g>
                                </svg>
                            </div><h2 className="text-3xl md:text-4xl font-extrabold tracking-tight text-slate-900 mb-2">환영합니다</h2>
                            <p className="text-slate-700 text-base md:text-lg font-bold">강동 아이파크 더 리버몰 주차관제실</p>
                            <p className="text-slate-500 text-sm mt-1">아래 큰 버튼을 눌러 업무를 선택하세요</p>
                        </div>
                        <button onClick={()=>onNavigate('construction')} className="w-full group bg-white p-6 md:p-7 rounded-3xl border-2 border-indigo-200 hover:border-indigo-400 shadow-md hover:shadow-xl hover:shadow-indigo-100 transition-all duration-300 flex items-center gap-5 relative overflow-hidden min-h-[110px]">
                            <div className="bg-indigo-600 p-4 rounded-2xl shadow-md group-hover:scale-105 transition-transform duration-300"><Car size={38} className="text-white"/></div>
                            <div className="text-left z-10">
                                <span className="font-extrabold text-2xl md:text-[28px] text-slate-900 leading-tight block mb-1">공사/방문 등록</span>
                                <span className="text-base text-slate-600 font-semibold">일반 방문 및 공사 차량</span>
                            </div>
                        </button>
                        <button
                            onClick={()=>{ if (!isRegularBlocked) onNavigate('regular'); }}
                            disabled={isRegularBlocked}
                            className={`w-full p-6 md:p-7 rounded-3xl border-2 shadow-md transition-all duration-300 flex items-center gap-5 relative overflow-hidden min-h-[110px] ${
                                isRegularBlocked
                                    ? 'bg-slate-100 border-slate-300 cursor-not-allowed'
                                    : 'group bg-white border-emerald-200 hover:border-emerald-400 hover:shadow-xl hover:shadow-emerald-100'
                            }`}
                        >
                            <div className={`p-4 rounded-2xl shadow-md transition-transform duration-300 ${isRegularBlocked ? 'bg-slate-400' : 'bg-emerald-600 group-hover:scale-105'}`}><FileText size={38} className="text-white"/></div>
                            <div className="text-left z-10">
                                <span className={`font-extrabold text-2xl md:text-[28px] leading-tight block mb-1 ${isRegularBlocked ? 'text-slate-500' : 'text-slate-900'}`}>정기권 신청</span>
                                <span className={`text-base font-semibold ${isRegularBlocked ? 'text-slate-400' : 'text-slate-600'}`}>입주민 및 직원 정기 등록</span>
                                {isRegularBlocked && <span className="block text-xs text-slate-500 mt-1 font-bold">방재실 계정은 정기권 신청 불가</span>}
                            </div>
                        </button>
                        <button onClick={()=>onNavigate('statusCheck')} className="w-full bg-white p-5 rounded-2xl border-2 border-slate-300 flex items-center justify-center gap-3 hover:bg-slate-50 transition active:scale-95 text-slate-700 font-extrabold text-lg shadow-sm">
                            <Search size={24}/><span>신청 내역 조회</span>
                        </button>
                        {adminRole ? (
                            <button onClick={()=>onNavigate('admin')} className="w-full bg-slate-800 hover:bg-slate-900 text-white p-5 rounded-2xl flex items-center justify-center gap-3 shadow-xl shadow-slate-200 transition active:scale-95 border border-slate-700">
                                <UserCheck size={24}/>
                                <div className="text-left"><span className="block text-xs text-slate-300 font-normal">현재 접속중</span><span className="font-extrabold text-lg">{ROLES[Object.keys(ROLES).find(k => ROLES[k].id === adminRole)].name} 관리모드</span></div>
                            </button>
                        ) : (
                            <button onClick={onOpenAdmin} className="w-full bg-white hover:bg-slate-50 text-slate-600 p-5 rounded-2xl flex items-center justify-center gap-2 border-2 border-slate-300 shadow-sm transition"><Lock size={20}/><span className="font-extrabold text-lg">로그인</span></button>
                        )}
                    </div>
                </div>
            )
        }

        // 공사/방문 등록 폼 - 차량 입력 간소화 및 상태 라벨 수정
        function ConstructionForm({ onBack, onSubmit, initialData, userRole }) {
            const allowedPurposes = useMemo(() => {
                if (userRole === 'SAFETY') return ['공사', '기타'];
                if (userRole === 'CENTER') return ['기타'];
                return ['공사', '부동산', '기타'];
            }, [userRole]);
            const receptionRoleName = userRole ? getRoleNameById(userRole) : '';
            const [visitPurpose, setVisitPurpose] = useState(allowedPurposes[0]);
            const today = new Date().toISOString().split('T')[0];
            const [formData, setFormData] = useState({ companyName:'', visitorName:'', visitUnit:'', location:'', driverPhone:'', startDate: today, endDate: today, startTime:'09:00', endTime:'18:00', vehicles:[''], signature: null, proxySubmitterName: '' });
            
            useEffect(() => { 
                if(initialData) { 
                    setVisitPurpose(initialData.visitPurpose); 
                    setFormData({...initialData}); 
                } else {
                    setVisitPurpose(allowedPurposes[0]);
                }
            }, [initialData, allowedPurposes]);

            useEffect(() => { 
                if(visitPurpose==='부동산') { 
                    if(formData.startDate) setFormData(p=>({...p, endDate:p.startDate})); 
                    if(formData.startTime) { 
                        const [h,m]=formData.startTime.split(':').map(Number); 
                        const eH=h+2; 
                        const eS=eH>=24?'23:59':`${String(eH).padStart(2,'0')}:${String(m).padStart(2,'0')}`; 
                        if(formData.endTime!==eS) setFormData(p=>({...p, endTime:eS})); 
                    } 
                } 
            }, [visitPurpose, formData.startDate, formData.startTime]);
            const handleFormSubmit = (e) => {
                e.preventDefault();
                onSubmit({ ...formData, visitPurpose });
            };

            return (
                <div className="flex flex-col h-full bg-white">
                    <div className="px-5 py-4 border-b border-slate-100 flex items-center gap-3 shrink-0 bg-white z-10">
                        <button onClick={onBack} className="p-2 -ml-2 rounded-full hover:bg-slate-50"><ArrowLeft className="text-slate-600"/></button>
                        <h2 className="text-xl font-bold text-slate-800">공사/방문 등록</h2>
                    </div>
                    <form onSubmit={handleFormSubmit} className="flex flex-col flex-1 overflow-hidden">
                        <div className="flex-1 overflow-y-auto p-5">
                            {userRole && (
                                <div className="mb-4 p-3 rounded-xl border border-amber-200 bg-amber-50">
                                    <p className="text-xs font-bold text-amber-800">관리자 로그인 접수</p>
                                    <p className="text-[11px] text-amber-700 mt-1">현재 접수는 대리접수로 자동 처리됩니다. 접수처: {receptionRoleName || '관리자'}</p>
                                </div>
                            )}
                            <div className="mb-6">
                                <label className="block text-sm font-bold text-slate-800 mb-3">방문 목적</label>
                                <div className="flex gap-2 bg-slate-100 p-1.5 rounded-2xl">
                                    {allowedPurposes.map(t=>(<button key={t} type="button" onClick={()=>setVisitPurpose(t)} className={`flex-1 py-2.5 text-sm rounded-xl font-bold transition-all ${visitPurpose===t?'bg-white shadow text-indigo-600':'text-slate-500 hover:text-slate-700'}`}>{t}</button>))}
                                </div>
                                {visitPurpose==='부동산'&&<p className="text-xs text-indigo-500 mt-2 font-medium flex items-center gap-1"><Clock size={12}/> 부동산은 2시간 제한됩니다.</p>}
                            </div>
                            <div className="space-y-1">
                                <FormInput label="업체명" required value={formData.companyName} onChange={e=>setFormData({...formData, companyName:e.target.value})} placeholder={visitPurpose === '기타' ? "" : (visitPurpose === '공사' ? "예: OO인테리어" : "예: 행복부동산")}/>
                                <FormInput label="방문자 성명" required value={formData.visitorName} onChange={e=>setFormData({...formData, visitorName:e.target.value})} placeholder={visitPurpose === '기타' ? "" : "홍길동"}/>
                                <FormInput label="방문 호수" required value={formData.visitUnit} onChange={e=>setFormData({...formData, visitUnit:e.target.value.replace(/[^0-9]/g, '')})} placeholder="예: 101"/>
                                <FormInput label="내용" value={formData.location} onChange={e=>setFormData({...formData, location:e.target.value})} placeholder={visitPurpose === '공사' ? '예: 인테리어 공사' : '예: 매물 확인'}/>
                                <FormInput label="연락처" type="tel" required value={formData.driverPhone} onChange={e=>setFormData({...formData, driverPhone:e.target.value.replace(/[^0-9]/g,'')})} placeholder="01012345678"/>
                            </div>
                            
                            <div className="p-4 bg-slate-50 rounded-2xl border border-slate-100 mb-6">
                                <h3 className="text-sm font-bold text-slate-700 mb-3">방문 일시</h3>
                                <div className="grid grid-cols-2 gap-3 mb-3">
                                    <div><label className="text-xs text-slate-400 mb-1 block">시작일</label><input type="date" required className="w-full p-2.5 border rounded-xl text-sm bg-white font-medium" value={formData.startDate} onChange={e=>{const v=e.target.value; setFormData(p=>({...p, startDate:v, endDate: visitPurpose==='부동산'?v:p.endDate}))}}/></div>
                                    <div><label className="text-xs text-slate-400 mb-1 block">시작 시간</label><input type="time" required className="w-full p-2.5 border rounded-xl text-sm bg-white font-medium" value={formData.startTime} onChange={e=>setFormData({...formData, startTime:e.target.value})}/></div>
                                </div>
                                <div className="grid grid-cols-2 gap-3">
                                    <div><label className="text-xs text-slate-400 mb-1 block">종료일</label><input type="date" required className="w-full p-2.5 border rounded-xl text-sm bg-white font-medium disabled:bg-slate-100" value={formData.endDate} onChange={e=>setFormData({...formData, endDate:e.target.value})} disabled={visitPurpose==='부동산'}/></div>
                                    <div><label className="text-xs text-slate-400 mb-1 block">종료 시간</label><input type="time" required className="w-full p-2.5 border rounded-xl text-sm bg-white font-medium disabled:bg-slate-100" value={formData.endTime} onChange={e=>setFormData({...formData, endTime:e.target.value})} disabled={visitPurpose==='부동산'}/></div>
                                </div>
                            </div>

                            <div className="mb-6">
                                <label className="text-sm font-bold text-slate-800 mb-2 block">차량 번호</label>
                                <div className="space-y-2">
                                    {/* 차량 1대만 입력받도록 수정 */}
                                    <div className="flex gap-2">
                                        <input 
                                            className="flex-1 p-3 border border-slate-200 rounded-xl bg-slate-50 focus:bg-white focus:ring-2 focus:ring-indigo-500 outline-none font-bold tracking-wider" 
                                            value={formData.vehicles[0] || ''} 
                                            onChange={e=>{
                                                const val = sanitizeCarNumberInput(e.target.value);
                                                setFormData({...formData, vehicles:[val]})
                                            }} 
                                            required 
                                            placeholder="12가3456"
                                        />
                                    </div>
                                    <p className="text-xs text-slate-400 mt-1">※ 차량은 1대만 입력 가능합니다.</p>
                                </div>
                            </div>

                            <div className="mb-6">
                                {userRole && (
                                    <div className="mb-3">
                                        <FormInput
                                            label="대리 접수자명"
                                            required
                                            value={formData.proxySubmitterName || ''}
                                            onChange={e=>setFormData({...formData, proxySubmitterName:e.target.value})}
                                            placeholder="예: 홍길동"
                                        />
                                    </div>
                                )}
                                <div className="flex justify-between items-end mb-2">
                                    <label className="text-sm font-bold text-slate-800 flex items-center gap-2"><PenTool size={16}/> {userRole ? '대리 접수 서명' : '신청자 서명'}</label>
                                    <span className="text-xs font-bold text-slate-500">{getFormattedDate()}</span>
                                </div>
                                <SignaturePad onSave={(data) => setFormData(prev => ({...prev, signature: data}))} initialData={formData.signature} />
                            </div>

                            <div className="mt-4 mb-6 p-4 bg-slate-50 rounded-xl border border-slate-200">
                                <h4 className="font-bold text-sm text-slate-700 mb-2 flex items-center gap-1"><AlertCircle size={14} className="text-rose-500"/> 유의사항</h4>
                                <ul className="list-decimal list-inside text-xs text-slate-600 space-y-1 break-keep">
                                    <li>차량번호 및 상세정보를 정확히 기입바라며, 거짓이 있을 경우 불이익이 발생할 수 있습니다.</li>
                                    <li>등록차량은 <span className="text-rose-600 font-bold">B2층</span>에 주차하고 수칙을 준수해야 합니다.</li>
                                    <li>차량은 <span className="text-rose-600 font-bold">매장별 3대</span>로 제한하고, 현장 상황에 따라 변경될 수 있습니다.</li>
                                </ul>
                                <p className="text-[10px] text-slate-400 mt-2 text-right">아래 내용을 준수하지 않으면 주차를 거부할 수 있습니다.</p>
                            </div>
                        </div>
                        <div className="p-4 border-t border-slate-100 bg-white shrink-0 safe-area-bottom"><button type="submit" className="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-4 rounded-2xl font-bold shadow-xl shadow-indigo-200 transition active:scale-95">{initialData?'수정하기':'신청하기'}</button></div>
                    </form>
                </div>
            );
        }

        function RegularTicketForm({ onBack, onSubmit, initialData, userRole }) {
            const [appType, setAppType] = useState('new');
            const receptionRoleName = userRole ? getRoleNameById(userRole) : '';
            const [formData, setFormData] = useState({ name:'', department:'', phone:'', carNumber:'', oldCarNumber:'', unitNumber:'', registrationImg:null, idCardImg:null, signature: null, changeReason: '', proxySubmitterName: '' });
            const regFileRef = useRef(null); const idFileRef = useRef(null);
            
            useEffect(() => { if(initialData) { setAppType(initialData.applicationType); setFormData({...initialData}); } }, [initialData]);
            
            const handleCompressedFile = (field, file) => {
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const MAX_WIDTH = 1024;
                        let width = img.width; let height = img.height;
                        if (width > MAX_WIDTH) { height *= MAX_WIDTH / width; width = MAX_WIDTH; }
                        canvas.width = width; canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        const dataUrl = canvas.toDataURL('image/jpeg', 0.7);
                        setFormData(p => ({...p, [field]: dataUrl}));
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            };
            const handleFormSubmit = (e) => {
                e.preventDefault();
                onSubmit({ ...formData, applicationType: appType });
            };

            return (
                <div className="flex flex-col h-full bg-white">
                    <div className="px-5 py-4 border-b border-slate-100 flex items-center gap-3 shrink-0 bg-white z-10"><button onClick={onBack} className="p-2 -ml-2 rounded-full hover:bg-slate-50"><ArrowLeft className="text-slate-600"/></button><h2 className="text-xl font-bold text-slate-800">정기권 신청</h2></div>
                    <form onSubmit={handleFormSubmit} className="flex flex-col flex-1 overflow-hidden">
                        <div className="flex-1 overflow-y-auto p-5">
                            {userRole && (
                                <div className="mb-4 p-3 rounded-xl border border-amber-200 bg-amber-50">
                                    <p className="text-xs font-bold text-amber-800">관리자 로그인 접수</p>
                                    <p className="text-[11px] text-amber-700 mt-1">현재 접수는 대리접수로 자동 처리됩니다. 접수처: {receptionRoleName || '관리자'}</p>
                                </div>
                            )}
                            <div className="mb-6">
                                <label className="block text-sm font-bold text-slate-800 mb-3">신청 유형</label>
                                <div className="flex gap-2 bg-slate-100 p-1.5 rounded-2xl">
                                    <button type="button" onClick={()=>setAppType('new')} className={`flex-1 py-2.5 text-sm rounded-xl font-bold transition-all ${appType==='new'?'bg-white shadow text-indigo-600':'text-slate-500 hover:text-slate-700'}`}>신규</button>
                                    <button type="button" onClick={()=>setAppType('change')} className={`flex-1 py-2.5 text-sm rounded-xl font-bold transition-all ${appType==='change'?'bg-white shadow text-emerald-600':'text-slate-500 hover:text-slate-700'}`}>변경</button>
                                </div>
                            </div>
                            
                            {appType==='change' && <div className="space-y-4 mb-6 p-4 bg-emerald-50 rounded-2xl border border-emerald-100"><FormInput label="기존 차량번호" required value={formData.oldCarNumber} onChange={e=>setFormData({...formData, oldCarNumber:sanitizeCarNumberInput(e.target.value)})} className="bg-white" placeholder="예: 12가3456" /><FormInput label="변경 사유" required value={formData.changeReason} onChange={e=>setFormData({...formData, changeReason:e.target.value})} placeholder="예: 차량 매매, 파손 등" className="bg-white" /></div>}
                            
                            <div className="space-y-1">
                                <FormInput label="성명" required value={formData.name} onChange={e=>setFormData({...formData, name:e.target.value})} placeholder="홍길동"/>
                                <FormInput label="소속" required value={formData.department} onChange={e=>setFormData({...formData, department:e.target.value})} placeholder="예: 관리사무소"/>
                                <FormInput label="연락처" type="tel" required value={formData.phone} onChange={e=>setFormData({...formData, phone:e.target.value.replace(/[^0-9]/g,'')})} placeholder="01012345678"/>
                                <div className="grid grid-cols-2 gap-3">
                                    <FormInput label={appType==='change'?'변경할 차량':'차량번호'} required value={formData.carNumber} onChange={e=>setFormData({...formData, carNumber:sanitizeCarNumberInput(e.target.value)})} className="bg-amber-50 border-amber-200 focus:ring-amber-500 focus:border-amber-500" placeholder="12가3456"/>
                                    <FormInput label="호수" required value={formData.unitNumber} onChange={e=>setFormData({...formData, unitNumber:e.target.value.replace(/[^0-9]/g, '')})} placeholder="예: 101"/>
                                </div>
                            </div>

                            <div className="mt-6 space-y-4">
                                <h3 className="text-sm font-bold text-slate-800">증빙 서류 첨부</h3>
                                <div className="grid grid-cols-2 gap-4">
                                    <div className="bg-slate-50 p-3 rounded-2xl border border-slate-100 flex flex-col">
                                        <div className="text-xs font-bold text-slate-500 mb-2 text-center">차량등록증</div>
                                        {formData.registrationImg ? (
                                            <div className="relative group aspect-[4/3]"><img src={formData.registrationImg} className="w-full h-full object-cover rounded-xl border border-slate-200 shadow-sm"/><button type="button" onClick={()=>setFormData(p=>({...p, registrationImg:null}))} className="absolute top-1 right-1 bg-black/50 text-white p-1 rounded-full hover:bg-black/70"><X size={14}/></button></div>
                                        ) : (
                                            <label className="flex-1 flex flex-col gap-2 justify-center items-center cursor-pointer bg-white border border-dashed border-slate-300 rounded-xl hover:bg-slate-50 transition p-2">
                                                <UploadCloud size={20} className="text-slate-400"/>
                                                <span className="text-xs font-bold text-slate-500">사진 첨부</span>
                                                <input ref={regFileRef} type="file" accept="image/*" className="hidden" onChange={e=>handleCompressedFile('registrationImg', e.target.files[0])}/>
                                            </label>
                                        )}
                                    </div>
                                    <div className="bg-slate-50 p-3 rounded-2xl border border-slate-100 flex flex-col">
                                        <div className="text-xs font-bold text-slate-500 mb-2 text-center">사원증</div>
                                        {formData.idCardImg ? (
                                            <div className="relative group aspect-[4/3]"><img src={formData.idCardImg} className="w-full h-full object-cover rounded-xl border border-slate-200 shadow-sm"/><button type="button" onClick={()=>setFormData(p=>({...p, idCardImg:null}))} className="absolute top-1 right-1 bg-black/50 text-white p-1 rounded-full hover:bg-black/70"><X size={14}/></button></div>
                                        ) : (
                                            <label className="flex-1 flex flex-col gap-2 justify-center items-center cursor-pointer bg-white border border-dashed border-slate-300 rounded-xl hover:bg-slate-50 transition p-2">
                                                <UploadCloud size={20} className="text-slate-400"/>
                                                <span className="text-xs font-bold text-slate-500">사진 첨부</span>
                                                <input ref={idFileRef} type="file" accept="image/*" className="hidden" onChange={e=>handleCompressedFile('idCardImg', e.target.files[0])}/>
                                            </label>
                                        )}
                                    </div>
                                </div>
                            </div>

                            <div className="mt-6 mb-6">
                                {userRole && (
                                    <div className="mb-3">
                                        <FormInput
                                            label="대리 접수자명"
                                            required
                                            value={formData.proxySubmitterName || ''}
                                            onChange={e=>setFormData({...formData, proxySubmitterName:e.target.value})}
                                            placeholder="예: 홍길동"
                                        />
                                    </div>
                                )}
                                <div className="flex justify-between items-end mb-2">
                                    <label className="text-sm font-bold text-slate-800 flex items-center gap-2"><PenTool size={16}/> {userRole ? '대리 접수 서명' : '신청자 서명'}</label>
                                    <span className="text-xs font-bold text-slate-500">{getFormattedDate()}</span>
                                </div>
                                <SignaturePad onSave={(data) => setFormData(prev => ({...prev, signature: data}))} initialData={formData.signature} />
                            </div>

                            <div className="mt-4 mb-6 p-4 bg-slate-50 rounded-xl border border-slate-200">
                                <h4 className="font-bold text-sm text-slate-700 mb-2 flex items-center gap-1"><AlertCircle size={14} className="text-rose-500"/> 유의사항</h4>
                                <ul className="list-decimal list-inside text-xs text-slate-600 space-y-1 break-keep">
                                    <li>아래 내용 미준수 시 요금이 부과될 수 있습니다.</li>
                                    <li>차량번호와 상세정보를 정확히 기재해야 합니다. 오기재에 대한 책임은 신청자에게 있습니다.</li>
                                    <li>정기주차는 <span className="text-rose-600 font-bold">주말 및 공휴일을 제외한 평일주차</span>만 가능합니다.</li>
                                    <li>신규등록은 월말 업체 담당자를 통해 명단을 통해 가능하며, 일할 결제는 불가합니다.</li>
                                    <li>이용기간 중 차량번호 변경은 불가합니다. (단, 사고발생으로 인한 대차사용시 관련정보 첨부 후 가능)</li>
                                    <li>정기권 이용수칙 위반 3회 적발 시 <span className="text-rose-600 font-bold">3개월간 정기권 등록 불가</span>합니다.</li>
                                    <li>정기권 신청 및 구매는 주차안내문 내용 참조</li>
                                </ul>
                                <p className="text-[10px] text-slate-400 mt-2 text-right">위 내용을 숙지하였으며 준수할 것을 서약합니다.</p>
                            </div>
                        </div>
                        <div className="p-4 border-t border-slate-100 bg-white shrink-0 safe-area-bottom"><button type="submit" className="w-full bg-emerald-500 hover:bg-emerald-600 text-white py-4 rounded-2xl font-bold shadow-xl shadow-emerald-200 transition active:scale-95">{initialData?'수정하기':'신청하기'}</button></div>
                    </form>
                </div>
            );
        }

        function StatusCheckScreen({ onBack, submissions, onEdit }) {
            const [phone, setPhone] = useState(''); const [car, setCar] = useState(''); const [res, setRes] = useState(null);
            const formatDateTime = (value) => {
                if (!value) return '-';
                const d = new Date(value);
                if (Number.isNaN(d.getTime())) return '-';
                return d.toLocaleString('ko-KR', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            };
            const isVisibleInStatusCheck = (item) => isWithinRetentionWindow(item, STATUS_CHECK_RETENTION);
            const search = (e) => {
                e.preventDefault();
                const phoneQuery = sanitizePhoneInput(phone);
                const carQuery = sanitizeCarNumberInput(car);
                if (!phoneQuery || !carQuery) { setRes([]); return; }
                const c = submissions.construction.filter(i =>
                    isVisibleInStatusCheck(i) &&
                    sanitizePhoneInput(i.driverPhone).includes(phoneQuery) &&
                    (i.vehicles || []).some(v => sanitizeCarNumberInput(v).includes(carQuery))
                );
                const r = submissions.regular.filter(i =>
                    isVisibleInStatusCheck(i) &&
                    sanitizePhoneInput(i.phone).includes(phoneQuery) &&
                    sanitizeCarNumberInput(i.carNumber).includes(carQuery)
                );
                setRes([...c, ...r]);
            };
            return (
                <div className="flex flex-col h-full bg-slate-50">
                    <div className="px-5 py-4 border-b border-slate-100 flex items-center gap-3 bg-white sticky top-0 z-10"><button onClick={onBack} className="p-2 -ml-2 rounded-full hover:bg-slate-50"><ArrowLeft className="text-slate-600"/></button><h2 className="text-xl font-bold text-slate-800">신청 내역 조회</h2></div>
                    <div className="p-5">
                        <form onSubmit={search} className="bg-white p-5 rounded-2xl shadow-sm border border-slate-100 mb-6 space-y-3"><input className="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-sm" placeholder="전화번호 (숫자만)" value={phone} onChange={e=>setPhone(sanitizePhoneInput(e.target.value))}/><input className="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-sm" placeholder="차량번호" value={car} onChange={e=>setCar(sanitizeCarNumberInput(e.target.value))}/><button className="w-full bg-indigo-600 text-white py-3 rounded-xl font-bold">조회하기</button></form>
                        <div className="space-y-4">
                            {res && res.map(i => (
                                <div key={i.id} className={`bg-white p-5 rounded-2xl shadow-sm border-l-4 ${getStatusBorder(i.status)}`}>
                                    <div className="flex justify-between items-start mb-2">
                                        <span className="font-bold text-slate-800">{i.type==='construction'?i.companyName:i.name}</span>
                                        <span className={`px-2 py-1 rounded text-xs font-bold ${getStatusColor(i.status)}`}>{getStatusLabel(i.status)}</span>
                                    </div>
                                    <div className="text-sm text-slate-600 mb-3">{i.type==='construction'?i.vehicles[0]:i.carNumber}</div>
                                    <div className="text-xs text-slate-600 bg-slate-50 border border-slate-200 rounded-lg p-2 mb-3 space-y-1">
                                        <div><span className="font-bold text-slate-700">신청일시:</span> {formatDateTime(i.submittedAt)}</div>
                                        {i.status === 'approved' && <div><span className="font-bold text-emerald-700">승인일시:</span> {formatDateTime(i.approvedAt || i.updatedAt)}</div>}
                                        {i.status === 'rejected' && <div><span className="font-bold text-rose-700">반려일시:</span> {formatDateTime(i.rejectedAt || i.updatedAt)}</div>}
                                    </div>
                                    {i.status === 'rejected' && (
                                        <div className="text-xs text-rose-700 bg-rose-50 border border-rose-100 rounded-lg p-2 mb-3 font-semibold">
                                            반려 사유: {i.rejectionReason || '사유 미입력'}{i.rejectedBy ? ` (${i.rejectedBy})` : ''}
                                        </div>
                                    )}
                                    {i.status!=='approved' && i.status!=='checked' && <button onClick={()=>onEdit(i)} className="w-full py-2 border border-slate-200 rounded-lg text-sm">수정하기</button>}
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            )
        }

        function SuccessScreen({ type, onHome }) {
            return (
                <div className="flex flex-col items-center justify-center h-full bg-white p-6 text-center animate-scale-in">
                    <div className="w-24 h-24 bg-emerald-100 rounded-full flex items-center justify-center mb-6"><CheckCircle size={48} className="text-emerald-500"/></div>
                    <h2 className="text-2xl font-bold text-slate-800 mb-2">신청 완료!</h2><p className="text-slate-500 mb-8">관리자 승인 후 주차가 가능합니다.</p><button onClick={onHome} className="w-full max-w-xs bg-slate-800 text-white py-4 rounded-2xl font-bold">확인</button>
                </div>
            )
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
